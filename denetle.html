<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ä°badet Veri Tamir Kiti</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: sans-serif; }
        .card { border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-radius: 15px; }
        .nav-pills .nav-link.active { background-color: #198754; }
        .nav-link { color: #333; font-weight: bold; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #198754; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: none; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-3">

<div class="container" style="max-width: 600px;">
    <h3 class="text-center mb-4 fw-bold text-success"><i class="fas fa-tools"></i> Veri Tamir Kiti</h3>
    
    <div id="auth-section" class="text-center card p-5">
        <p>Verilerinizi dÃ¼zeltmek iÃ§in giriÅŸ yapÄ±n.</p>
        <button class="btn btn-dark w-100 py-2 rounded-pill" onclick="login()">Google ile GiriÅŸ</button>
    </div>

    <div id="editor-section" style="display:none;">
        <div class="card p-3 mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <span class="small text-muted" id="user-display">KullanÄ±cÄ±</span>
                <button class="btn btn-sm btn-outline-danger" onclick="logout()">Ã‡Ä±kÄ±ÅŸ</button>
            </div>
        </div>

        <ul class="nav nav-pills nav-fill mb-3" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#pills-home" type="button">ğŸ“Š GeÃ§miÅŸ (Log)</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-profile" type="button">ğŸ¯ BugÃ¼n (SayaÃ§)</button>
            </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            
            <!-- LOG DÃœZENLEME (Ä°STATÄ°STÄ°KLER Ä°Ã‡Ä°N) -->
            <div class="tab-pane fade show active" id="pills-home">
                <div class="alert alert-info small">Buradaki deÄŸiÅŸiklikler <b>Grafikleri</b> etkiler.</div>
                <div id="days-list" class="list-group"></div>
            </div>

            <!-- GÃœNLÃœK HEDEF DÃœZENLEME (ANA EKRAN Ä°Ã‡Ä°N) -->
            <div class="tab-pane fade" id="pills-profile">
                <div class="alert alert-warning small">
                    Buradan <b>BugÃ¼nkÃ¼ (Ana Ekran)</b> namaz sayÄ±larÄ±nÄ± manuel olarak dÃ¼zeltebilirsiniz. 
                    <br>Ã–rn: Sabah'Ä± yanlÄ±ÅŸlÄ±kla 0 gÃ¶rdÃ¼yseniz buradan artÄ±rÄ±n.
                </div>
                
                <div class="card p-4">
                    <h5 class="text-center mb-3">BugÃ¼nÃ¼n SayaÃ§larÄ±</h5>
                    <div id="daily-loader" class="loader"></div>
                    <div id="daily-inputs" style="display:none;">
                        <div class="row g-2 mb-2 align-items-center">
                            <div class="col-4 fw-bold">Sabah</div>
                            <div class="col-8"><input type="number" id="dc-0" class="form-control text-center"></div>
                        </div>
                        <div class="row g-2 mb-2 align-items-center">
                            <div class="col-4 fw-bold">Ã–ÄŸle</div>
                            <div class="col-8"><input type="number" id="dc-1" class="form-control text-center"></div>
                        </div>
                        <div class="row g-2 mb-2 align-items-center">
                            <div class="col-4 fw-bold">Ä°kindi</div>
                            <div class="col-8"><input type="number" id="dc-2" class="form-control text-center"></div>
                        </div>
                        <div class="row g-2 mb-2 align-items-center">
                            <div class="col-4 fw-bold">AkÅŸam</div>
                            <div class="col-8"><input type="number" id="dc-3" class="form-control text-center"></div>
                        </div>
                        <div class="row g-2 mb-2 align-items-center">
                            <div class="col-4 fw-bold">YatsÄ±</div>
                            <div class="col-8"><input type="number" id="dc-4" class="form-control text-center"></div>
                        </div>
                        <hr>
                        <button class="btn btn-success w-100 fw-bold" onclick="saveDailyCounts()">ğŸ’¾ BugÃ¼nÃ¼ Kaydet ve DÃ¼zelt</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC7zdr3x8H--8piHR_1muAz2TVOOaebI54",
        authDomain: "kazanamazi-ser.firebaseapp.com",
        databaseURL: "https://kazanamazi-ser-default-rtdb.firebaseio.com",
        projectId: "kazanamazi-ser",
        storageBucket: "kazanamazi-ser.firebasestorage.app",
        messagingSenderId: "951730390034",
        appId: "1:951730390034:web:639f96ee859c10b0e944cb",
        measurementId: "G-5WGCDTL1RX"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const provider = new firebase.auth.GoogleAuthProvider();
    let currentUserUid = null;
    let currentDailyData = null;

    auth.onAuthStateChanged(user => {
        if (user) {
            currentUserUid = user.uid;
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('editor-section').style.display = 'block';
            document.getElementById('user-display').innerText = user.email;
            loadLast7Days();
            loadDailyData();
        } else {
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('editor-section').style.display = 'none';
        }
    });

    function login() { auth.signInWithPopup(provider).catch(e => alert(e.message)); }
    function logout() { auth.signOut().then(() => window.location.reload()); }

    function getIsoDate(d) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
    }

    // --- LOGLARI YÃœKLE ---
    function loadLast7Days() {
        const list = document.getElementById('days-list');
        list.innerHTML = "<div class='text-center'>Veriler Ã§ekiliyor...</div>";
        
        const dates = [];
        for(let i=0; i<7; i++) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            dates.push(getIsoDate(d));
        }

        db.ref('users/' + currentUserUid + '/namazData/logs').once('value', s => {
            const data = s.val() || {};
            list.innerHTML = "";
            dates.forEach(date => {
                const val = data[date] !== undefined ? data[date] : 0;
                list.innerHTML += `
                <div class="list-group-item d-flex justify-content-between align-items-center mb-2 shadow-sm border">
                    <span class="fw-bold text-secondary">${date}</span>
                    <div class="input-group" style="width: 140px;">
                        <input type="number" id="inp-${date}" class="form-control text-center fw-bold" value="${val}">
                        <button class="btn btn-primary" onclick="saveLog('${date}')">ğŸ’¾</button>
                    </div>
                </div>`;
            });
        });
    }

    window.saveLog = function(date) {
        const newVal = parseInt(document.getElementById('inp-' + date).value);
        if(isNaN(newVal)) return alert("SayÄ± girin");
        
        db.ref('users/' + currentUserUid + '/namazData/logs/' + date).set(newVal)
            .then(() => {
                const btn = document.querySelector(`#inp-${date}`).nextElementSibling;
                btn.className = "btn btn-success";
                btn.innerHTML = "âœ“";
                setTimeout(() => { btn.className = "btn btn-primary"; btn.innerHTML = "ğŸ’¾"; }, 2000);
            })
            .catch(e => alert(e.message));
    }

    // --- GÃœNLÃœK SAYACI YÃœKLE ---
    function loadDailyData() {
        const loader = document.getElementById('daily-loader');
        const inputs = document.getElementById('daily-inputs');
        loader.style.display = 'block';
        inputs.style.display = 'none';

        db.ref('users/' + currentUserUid + '/namazData/daily').once('value', s => {
            currentDailyData = s.val();
            if(currentDailyData && currentDailyData.counts) {
                for(let i=0; i<5; i++) {
                    document.getElementById(`dc-${i}`).value = currentDailyData.counts[i] || 0;
                }
            } else {
                // Veri yoksa 0 bas
                for(let i=0; i<5; i++) document.getElementById(`dc-${i}`).value = 0;
            }
            loader.style.display = 'none';
            inputs.style.display = 'block';
        });
    }

    window.saveDailyCounts = function() {
        if(!currentDailyData) currentDailyData = {};
        
        // Yeni deÄŸerleri al
        const newCounts = [
            parseInt(document.getElementById('dc-0').value) || 0,
            parseInt(document.getElementById('dc-1').value) || 0,
            parseInt(document.getElementById('dc-2').value) || 0,
            parseInt(document.getElementById('dc-3').value) || 0,
            parseInt(document.getElementById('dc-4').value) || 0
        ];

        // Tarih formatÄ± (Ana uygulamayla aynÄ± olmalÄ±: DD.MM.YYYY)
        const d = new Date();
        const dateStr = d.toLocaleDateString('tr-TR'); // Ã–rn: 29.11.2025

        const updateData = {
            date: dateStr,
            counts: newCounts,
            target: currentDailyData.target || 10
        };

        db.ref('users/' + currentUserUid + '/namazData/daily').set(updateData)
            .then(() => {
                alert("BugÃ¼nÃ¼n sayaÃ§larÄ± baÅŸarÄ±yla gÃ¼ncellendi! Ana uygulamayÄ± yenileyip kontrol edin.");
            })
            .catch(e => alert("Hata: " + e.message));
    }
</script>

</body>
</html>
