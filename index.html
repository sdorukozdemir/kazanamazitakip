<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Kaza ƒ∞badet Takip</title>

    <meta name="theme-color" content="#609979">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Amiri:wght@700&display=swap"
        rel="stylesheet">
    <link rel="manifest" id="my-manifest">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>

    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        ::-webkit-scrollbar {
            width: 0px;
            height: 0px;
            background: transparent;
        }

        :root {
            --bg-color: #e3e6ec;
            --text-color: #212529;
            --card-bg: #ffffff;
            --sidebar-bg: linear-gradient(180deg, #609979 0%, #3e6b53 100%);
            --sidebar-item-active: rgba(255, 255, 255, 0.25);
            --sidebar-item-hover: rgba(255, 255, 255, 0.1);
            --input-bg: #f8f9fa;
            --input-text: #000000;
            --border-color: #ced4da;
            --modal-bg: #ffffff;
            --z-btn-minus-bg: #e9ecef;
            --z-btn-minus-text: #495057;
            --z-btn-reset-bg: #fff3cd;
            --z-btn-reset-text: #856404;
            --z-btn-plus-bg: linear-gradient(145deg, #609979, #3e6b53);
            --scroll-track: #e9ecef;
            --scroll-thumb: #ced4da;
            --box-target-bg: #e8f5e9;
            --box-target-border: #c3e6cb;
            --box-target-text: #155724;
            --box-add-bg: #e7f1ff;
            --box-add-border: #b6d4fe;
            --stat-avg-color: #6610f2;
            --calc-box-bg: #f8f9fa;
            --calc-header-bg: linear-gradient(135deg, #609979, #3e6b53);
            --calc-header-text: #ffffff;
            --calc-header-shadow: rgba(96, 153, 121, 0.3);
            --placeholder-color: #6c757d;
            --pink-accent: #d63384;
            --pink-bg-light: #fce4ec;
            --blue-accent: #0d6efd;
            --blue-bg-light: #e7f1ff;
            --fade-box-bg: rgba(255, 255, 255, 0.6);
            --fade-box-border: rgba(0, 0, 0, 0.05);
            --fade-box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
            --calc-item-bg: #ffffff;
            --calc-item-border: #e9ecef;
            --user-box-bg-male: linear-gradient(135deg, #0d6efd, #0a58ca);
            --user-box-bg-female: linear-gradient(135deg, #d63384, #a52864);
            --user-box-text: #ffffff;
            --user-box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            --capsule-bg: #e9ecef;
            --capsule-border: #ced4da;
            --capsule-label: #6c757d;
            --capsule-text: #212529;
            --capsule-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        body.dark-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --card-bg: #1e1e1e;
            --sidebar-bg: linear-gradient(180deg, #111827 0%, #1f2937 100%);
            --sidebar-item-active: rgba(96, 153, 121, 0.2);
            --sidebar-item-hover: rgba(255, 255, 255, 0.05);
            --input-bg: #3a3a3a;
            --input-text: #ffffff;
            --border-color: #444;
            --modal-bg: #2d2d2d;
            --z-btn-minus-bg: #343a40;
            --z-btn-minus-text: #ced4da;
            --z-btn-reset-bg: #3e2c00;
            --z-btn-reset-text: #ffc107;
            --z-btn-plus-bg: linear-gradient(145deg, #0f5132, #146c43);
            --scroll-track: #2d2d2d;
            --scroll-thumb: #555;
            --box-target-bg: #0f2e1c;
            --box-target-border: #146c43;
            --box-target-text: #75b798;
            --box-add-bg: #052c65;
            --box-add-border: #084298;
            --stat-avg-color: #d63384;
            --calc-box-bg: #2d2d2d;
            --calc-header-bg: linear-gradient(135deg, #0f5132, #146c43);
            --calc-header-text: #e0e0e0;
            --calc-header-shadow: rgba(0, 0, 0, 0.5);
            --placeholder-color: #bbbbbb;
            --pink-bg-light: #4a1b2d;
            --blue-bg-light: #0d2b4a;
            --fade-box-bg: rgba(255, 255, 255, 0.05);
            --fade-box-border: rgba(255, 255, 255, 0.05);
            --fade-box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            --calc-item-bg: #262626;
            --calc-item-border: #333;
            --user-box-bg-male: linear-gradient(135deg, #0d6efd, #002a5c);
            --user-box-bg-female: linear-gradient(135deg, #d63384, #4d0a2b);
            --capsule-bg: #2c3035;
            --capsule-border: #444444;
            --capsule-label: #aaaaaa;
            --capsule-text: #ffffff;
            --capsule-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .text-muted {
            color: #adb5bd !important;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        #ptr-spinner {
            position: fixed;
            top: 25px;
            left: 50%;
            width: 36px;
            height: 36px;
            margin-left: -18px;
            z-index: 1000;
            border: 4px solid rgba(96, 153, 121, 0.3);
            border-top-color: #609979;
            border-radius: 12px;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            background-color: var(--card-bg);
            transition: opacity 0.2s;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease, visibility 0.5s;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(96, 153, 121, 0.2);
            border-top-color: #609979;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            margin-top: 15px;
            font-weight: 600;
            color: #609979;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .wrapper {
            display: flex;
            width: 100%;
            height: 100%;
        }

        #sidebar {
            min-width: 280px;
            max-width: 280px;
            background: var(--sidebar-bg);
            color: #fff;
            height: 100vh;
            transition: all 0.3s ease;
            z-index: 2000;
            position: fixed;
            top: 0;
            left: 0;
            overflow-y: auto;
            margin-left: -280px;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
        }

        #overlay {
            display: none;
            position: fixed;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            top: 0;
            left: 0;
            backdrop-filter: blur(2px);
        }

        #overlay.active {
            display: block;
        }

        #sidebar.active {
            margin-left: 0;
        }

        .sidebar-header {
            padding: 30px 20px 20px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 15px;
        }

        #sidebar ul {
            padding: 0 15px;
        }

        #sidebar ul li {
            padding: 12px 20px;
            margin-bottom: 8px;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            font-weight: 500;
            opacity: 0.85;
            border: none;
        }

        #sidebar ul li:hover {
            background: var(--sidebar-item-hover);
            transform: translateX(5px);
            opacity: 1;
        }

        #sidebar ul li.active {
            background: var(--sidebar-item-active);
            color: #fff;
            font-weight: 700;
            opacity: 1;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        #sidebar ul li i {
            width: 30px;
            text-align: center;
            font-size: 1.1rem;
        }

        @media (min-width: 769px) {
            #sidebar {
                position: sticky;
                margin-left: 0;
                height: 100vh;
                z-index: 1050;
                border-top-right-radius: 20px;
                border-bottom-right-radius: 20px;
            }

            #sidebar.active {
                margin-left: -280px;
            }

            #overlay {
                display: none !important;
            }

            #content {
                width: calc(100% - 280px);
                margin-left: 0;
            }
        }

        @media (max-width: 768px) {
            #content {
                width: 100%;
            }
        }

        .user-info-box {
            margin: 10px auto;
            width: 100%;
            padding: 15px 10px;
            border-radius: 12px;
            color: var(--user-box-text);
            box-shadow: var(--user-box-shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 600;
            transition: 0.3s;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .user-info-male {
            background: var(--user-box-bg-male);
        }

        .user-info-female {
            background: var(--user-box-bg-female);
        }

        #content {
            height: 100%;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
            touch-action: pan-y;
        }

        .app-section {
            display: none;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            will-change: transform;
            backface-visibility: hidden;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px 20px 130px 20px;
        }

        .app-section.active {
            display: block;
            position: relative;
            z-index: 5;
        }

        .app-section.sliding {
            display: block !important;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }

        .animate-transition {
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .app-header {
            text-align: center;
            color: var(--sidebar-bg);
            font-weight: 600;
            margin-bottom: 25px;
            font-size: 1.5rem;
            background: -webkit-linear-gradient(45deg, #609979, #3e6b53);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        body.dark-mode .app-header {
            background: -webkit-linear-gradient(45deg, #20c997, #81d4fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .prayer-split-layout {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: stretch;
            height: 420px;
        }

        .prayer-side-menu {
            width: 85px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-shrink: 0;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .prayer-split-layout {
                flex-direction: column;
                height: auto;
            }

            .prayer-side-menu {
                width: 100%;
                flex-direction: row;
                overflow-x: auto;
                padding: 5px 15px;
                scrollbar-width: none;
                gap: 10px;
            }

            .prayer-side-menu::-webkit-scrollbar {
                display: none;
            }

            .side-menu-item {
                min-width: 75px;
                padding: 10px 5px;
                height: 75px;
                flex: 0 0 auto;
            }

            .prayer-detail-card {
                min-height: 380px;
            }
        }

        .side-menu-item {
            border-radius: 18px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0.8;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
            color: #333;
        }

        .side-menu-item:hover {
            transform: translateY(-2px);
            opacity: 1;
        }

        .side-menu-item.active {
            opacity: 1;
            transform: scale(1.05);
            border: none;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            color: #fff !important;
        }

        .side-menu-item.active .side-menu-label {
            color: #fff !important;
            opacity: 1;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .side-menu-item.active .side-menu-icon {
            color: #fff !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .side-menu-icon {
            font-size: 1.5rem;
            margin-bottom: 4px;
            transition: 0.3s;
        }

        .side-menu-label {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.7;
            transition: 0.3s;
        }

        .flip-icon {
            transform: scaleX(-1);
            display: inline-block;
        }

        .theme-sabah {
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
            color: #006064;
        }

        .theme-sabah.active {
            background: linear-gradient(135deg, #00acc1 0%, #00838f 100%);
        }

        .theme-ogle {
            background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);
            color: #f57f17;
        }

        .theme-ogle.active {
            background: linear-gradient(135deg, #fdd835 0%, #fbc02d 100%);
        }

        .theme-ikindi {
            background: linear-gradient(135deg, #ffe0b2 0%, #ffcc80 100%);
            color: #e65100;
        }

        .theme-ikindi.active {
            background: linear-gradient(135deg, #fb8c00 0%, #ef6c00 100%);
        }

        .theme-aksam {
            background: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%);
            color: #1a237e;
        }

        .theme-aksam.active {
            background: linear-gradient(135deg, #3949ab 0%, #1a237e 100%);
        }

        .theme-yatsi {
            background: linear-gradient(135deg, #cfd8dc 0%, #b0bec5 100%);
            color: #263238;
        }

        .theme-yatsi.active {
            background: linear-gradient(135deg, #546e7a 0%, #455a64 100%);
        }

        .theme-oruc-kaza {
            background: linear-gradient(135deg, #e6e9f0 0%, #eef1f5 100%);
            color: #212529;
            border: 1px solid #ced4da;
        }

        .theme-oruc-kaza.active {
            background: linear-gradient(135deg, #232526 0%, #414345 100%);
            color: white;
            border: none;
        }

        .theme-oruc-nafile {
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
            color: #1b5e20;
        }

        .theme-oruc-nafile.active {
            background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%);
            color: white;
        }

        body.dark-mode .side-menu-item {
            background: #2c3035;
            color: #90a4ae;
            border: 1px solid #444;
        }

        body.dark-mode .theme-sabah.active {
            background: linear-gradient(135deg, #0277bd 0%, #01579b 100%);
            color: #e1f5fe;
        }

        body.dark-mode .theme-ogle.active {
            background: linear-gradient(135deg, #ff8f00 0%, #e65100 100%);
            color: #fffde7;
        }

        body.dark-mode .theme-ikindi.active {
            background: linear-gradient(135deg, #d84315 0%, #bf360c 100%);
            color: #fbe9e7;
        }

        body.dark-mode .theme-aksam.active {
            background: linear-gradient(135deg, #283593 0%, #1a237e 100%);
            color: #e8eaf6;
        }

        body.dark-mode .theme-yatsi.active {
            background: linear-gradient(135deg, #37474f 0%, #263238 100%);
            color: #eceff1;
        }

        body.dark-mode .theme-oruc-kaza {
            background: #2c3035;
            color: #ced4da;
            border-color: #444;
        }

        body.dark-mode .theme-oruc-kaza.active {
            background: linear-gradient(135deg, #000000 0%, #434343 100%);
            color: white;
        }

        body.dark-mode .theme-oruc-nafile.active {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
        }

        .prayer-detail-card {
            flex: 1;
            border-radius: 25px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            transition: background 0.5s ease;
            border: 1px solid var(--border-color);
        }

        .bg-sabah {
            background: linear-gradient(135deg, #e1f5fe 0%, #81d4fa 100%);
        }

        .bg-ogle {
            background: linear-gradient(135deg, #fff9c4 0%, #fff176 100%);
        }

        .bg-ikindi {
            background: linear-gradient(135deg, #ffccbc 0%, #ff8a65 100%);
        }

        .bg-aksam {
            background: linear-gradient(135deg, #c5cae9 0%, #9fa8da 100%);
        }

        .bg-yatsi {
            background: linear-gradient(135deg, #cfd8dc 0%, #b0bec5 100%);
        }

        .bg-oruc-kaza {
            background: linear-gradient(135deg, #232526 0%, #414345 100%);
            color: white;
        }

        .bg-oruc-nafile {
            background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%);
            color: white;
        }

        .bg-white-10 {
            background: rgba(255, 255, 255, 0.15) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        .border-white-10 {
            border-color: rgba(255, 255, 255, 0.2) !important;
        }

        body.dark-mode .bg-sabah {
            background: linear-gradient(120deg, #01579b 0%, #0288d1 40%, #29b6f6 50%, #0288d1 60%, #01579b 100%);
        }

        body.dark-mode .bg-ogle {
            background: linear-gradient(120deg, #e65100 0%, #f57c00 40%, #ffb74d 50%, #f57c00 60%, #e65100 100%);
        }

        body.dark-mode .bg-ikindi {
            background: linear-gradient(120deg, #bf360c 0%, #d84315 40%, #ff7043 50%, #d84315 60%, #bf360c 100%);
        }

        body.dark-mode .bg-aksam {
            background: linear-gradient(120deg, #1a237e 0%, #303f9f 40%, #7986cb 50%, #303f9f 60%, #1a237e 100%);
        }

        body.dark-mode .bg-yatsi {
            background: linear-gradient(120deg, #102027 0%, #263238 40%, #546e7a 50%, #263238 60%, #102027 100%);
        }

        body.dark-mode .bg-oruc-kaza {
            background: linear-gradient(135deg, #000000 0%, #434343 100%);
        }

        body.dark-mode .bg-oruc-nafile {
            background: linear-gradient(135deg, #0e6655 0%, #117864 100%);
        }

        .pd-content {
            position: relative;
            z-index: 2;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 25px;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(8px);
            border-radius: 24px;
            margin: 10px;
        }

        body.dark-mode .pd-content {
            background: rgba(20, 20, 20, 0.5);
        }

        .pd-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.05);
            padding-bottom: 10px;
        }

        .pd-title {
            font-size: 1.8rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }

        .pd-remaining-badge {
            background: #dc3545;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
            white-space: nowrap;
            flex-shrink: 0;
        }

        @media (max-width: 576px) {
            .pd-header {
                flex-wrap: wrap;
                gap: 5px;
                justify-content: center;
            }

            .pd-title {
                font-size: 1.4rem;
                width: 100%;
                justify-content: center;
            }

            .pd-remaining-badge {
                margin: 0 auto;
                font-size: 0.8rem;
                padding: 4px 12px;
            }
        }

        .pd-stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: auto;
        }

        .pd-input-group {
            background: var(--input-bg);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
        }

        .pd-label {
            font-size: 0.75rem;
            font-weight: 700;
            opacity: 0.6;
            text-transform: uppercase;
            margin-bottom: 5px;
            color: var(--text-color);
        }

        .pd-input {
            background: transparent;
            border: none;
            font-size: 1.8rem;
            font-weight: 800;
            text-align: center;
            width: 100%;
            color: var(--text-color);
            outline: none;
        }

        .pd-progress-container {
            margin-top: 20px;
            margin-bottom: 5px;
        }

        .pd-progress-track {
            height: 12px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        body.dark-mode .pd-progress-track {
            background: rgba(255, 255, 255, 0.1);
        }

        .pd-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #609979, #3e6b53);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .pd-progress-text {
            font-size: 0.75rem;
            font-weight: 700;
            text-align: center;
            margin-top: 4px;
            opacity: 0.7;
        }

        .pd-actions {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
        }

        .pd-btn {
            width: 70px;
            height: 70px;
            border-radius: 20px;
            border: none;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
            color: white;
        }

        .pd-btn:active {
            transform: scale(0.9);
        }

        .pd-btn-plus {
            background: #609979;
            box-shadow: 0 10px 20px rgba(96, 153, 121, 0.3);
        }

        .pd-btn-minus {
            background: #6c757d;
            box-shadow: 0 10px 20px rgba(108, 117, 125, 0.3);
        }

        .stat-accordion-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-accordion-header {
            padding: 18px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            background: var(--card-bg);
            user-select: none;
        }

        .stat-accordion-header:hover {
            background: rgba(0, 0, 0, 0.02);
        }

        .stat-header-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stat-icon-wrapper {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(96, 153, 121, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #609979;
        }

        .stat-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-color);
        }

        .stat-arrow {
            transition: transform 0.3s;
            color: var(--placeholder-color);
        }

        .stat-accordion-item.open .stat-arrow {
            transform: rotate(180deg);
            color: #609979;
        }

        .stat-accordion-body {
            display: none;
            padding: 0 20px 20px 20px;
            border-top: 1px dashed var(--border-color);
            animation: statSlideDown 0.3s ease-out;
        }

        .stat-accordion-item.open .stat-accordion-body {
            display: block;
        }

        @keyframes statSlideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .stat-detail-item {
            background: var(--input-bg);
            padding: 10px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-detail-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 700;
            opacity: 0.6;
            display: block;
            margin-bottom: 3px;
        }

        .stat-detail-value {
            font-size: 1.1rem;
            font-weight: 800;
        }

        .text-done {
            color: #609979;
        }

        .text-rem {
            color: #dc3545;
        }

        .summary-bar {
            background: var(--sidebar-bg);
            color: white;
            border-radius: 16px;
            padding: 15px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .summary-item {
            text-align: center;
        }

        .summary-val {
            font-size: 1.2rem;
            font-weight: 800;
            line-height: 1;
        }

        .summary-lbl {
            font-size: 0.7rem;
            opacity: 0.8;
            text-transform: uppercase;
            font-weight: 600;
            margin-top: 4px;
        }

        .login-card,
        .goal-card,
        .zikr-card,
        .calculator-card,
        .settings-card,
        .prediction-card,
        .stat-card {
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        #login-screen {
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--bg-color);
        }

        .goal-card {
            background: linear-gradient(135deg, #609979, #3e6b53);
            color: white;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .goal-card.success-mode {
            border: 3px solid #ffc107;
        }

        .goal-input {
            width: 70px;
            text-align: center;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            color: #609979;
            background: white;
        }

        .goal-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .streak-box {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .tesbihat-list-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .t-list-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .t-list-card:active {
            transform: scale(0.98);
        }

        .t-card-info {
            z-index: 2;
            flex: 1;
        }

        .t-card-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .t-card-count {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
        }

        .t-card-icon {
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            margin-left: 10px;
            z-index: 2;
        }

        .t-card-delete {
            position: absolute;
            right: 45px;
            top: 50%;
            transform: translateY(-50%);
            width: 35px;
            height: 35px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            z-index: 10;
            transition: 0.2s;
        }

        .t-card-delete:active {
            background: #dc3545;
        }

        .t-add-card {
            background: transparent;
            border: 2px dashed var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            border-radius: 16px;
            cursor: pointer;
            color: var(--placeholder-color);
            font-weight: 700;
            transition: 0.2s;
        }

        .t-add-card:hover {
            border-color: #609979;
            color: #609979;
            background: var(--input-bg);
        }

        .tesbihat-detail-wrapper {
            animation: fadeIn 0.3s ease;
        }

        .tesbihat-header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .control-btn {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            font-size: 1.2rem;
        }

        .color-palette-container {
            display: none;
            gap: 8px;
            background: var(--card-bg);
            padding: 10px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            position: absolute;
            top: 60px;
            left: 20px;
            z-index: 100;
            flex-wrap: wrap;
            max-width: 250px;
        }

        .cp-swatch {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        .cp-swatch:active {
            transform: scale(1.1);
        }

        .chart-period-selector {
            display: flex;
            width: 100%;
            background: var(--input-bg);
            border-radius: 20px;
            padding: 5px;
            gap: 5px;
            border: 1px solid var(--border-color);
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
        }

        .chart-period-btn {
            flex: 1;
            text-align: center;
            padding: 12px 5px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            border-radius: 16px;
            transition: all 0.3s ease;
            color: var(--text-color);
            background: transparent;
            border: 1px solid transparent;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-period-btn.active {
            background: linear-gradient(135deg, #609979, #3e6b53);
            color: white;
            box-shadow: 0 4px 12px rgba(96, 153, 121, 0.4);
            transform: translateY(-1px);
        }

        .completion-legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            border-radius: 50px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            min-width: 140px;
            justify-content: center;
            transition: transform 0.2s;
        }

        .legend-item:active {
            transform: scale(0.98);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .legend-text {
            font-size: 0.95rem;
            font-weight: 800;
            color: var(--text-color);
        }

        .legend-percent {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-left: 8px;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .bottom-nav {
                display: flex;
            }

            #content {
                padding-bottom: 90px;
            }

            .btn-success.d-md-none {
                display: none !important;
            }
        }

        @media (orientation: landscape) and (max-height: 600px) {
            .app-header {
                display: none;
            }

            .bottom-nav {
                height: 50px;
                padding-bottom: 0;
            }

            .nav-item i {
                font-size: 1.1rem;
                margin-bottom: 2px;
            }

            .nav-item span {
                font-size: 0.6rem;
            }

            #content {
                padding-top: 5px;
                padding-bottom: 55px;
            }

            .chart-container {
                display: block !important;
                padding: 10px;
                margin-bottom: 10px;
            }

            .chart-container h5 {
                font-size: 0.9rem;
                margin-bottom: 5px;
            }

            #barChart,
            #lineChart,
            #completionChart {
                max-height: 180px !important;
            }

            .scrolling-wrapper {
                margin-bottom: 10px !important;
            }

            .stat-card-scroll {
                padding: 8px;
                width: 130px;
            }

            .analysis-box {
                padding: 10px;
                margin-bottom: 10px;
            }
        }
    </style>
</head>

<body>
    <!-- Part 1 Content ends around line 500-600. Truncating here to keep it safe. -->
    <div id="ptr-spinner"></div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Veriler Y√ºkleniyor...</div>
    </div>

    <div id="toast-container"></div>

    <div id="addZikrModal" class="custom-modal-overlay">
        <div class="custom-modal">
            <h4 class="mb-3 fw-bold">Yeni Zikir Ekle</h4>
            <input type="text" id="newZikrNameInput" class="form-control mb-3 text-center"
                placeholder="Zikir ismi giriniz..." style="font-size:1.1rem; padding:10px;">
            <div class="modal-btn-group">
                <button class="modal-btn btn-cancel"
                    onclick="document.getElementById('addZikrModal').style.display='none'">ƒ∞ptal</button>
                <button class="modal-btn btn-confirm bg-success border-0" onclick="confirmAddZikr()">Ekle</button>
            </div>
        </div>
    </div>

    <div id="gender-selection-modal" class="custom-modal-overlay">
        <div class="custom-modal" style="max-width: 450px;">
            <h4 class="mb-3 fw-bold">Ho≈ü Geldiniz</h4>
            <p class="mb-4 text-muted">Hesaplamalarƒ± daha doƒüru yapabilmemiz i√ßin l√ºtfen cinsiyetinizi se√ßiniz.</p>
            <div class="row g-3">
                <div class="col-6">
                    <div id="genderOptFemale" class="gender-option" data-type="female" onclick="selectGender('female')">
                        <i class="fas fa-female fa-3x mb-2"></i>
                        <div class="fw-bold">Kadƒ±n</div>
                    </div>
                </div>
                <div class="col-6">
                    <div id="genderOptMale" class="gender-option" data-type="male" onclick="selectGender('male')">
                        <i class="fas fa-male fa-3x mb-2"></i>
                        <div class="fw-bold">Erkek</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="customModal" class="custom-modal-overlay">
        <div class="custom-modal">
            <h4 id="modalTitle">Ba≈ülƒ±k</h4>
            <p id="modalMessage">Mesaj.</p>
            <div class="modal-btn-group" id="modalButtons"></div>
        </div>
    </div>
    <div id="overlay" onclick="toggleSidebar()"></div>

    <div id="login-screen">
        <div class="login-card p-5 text-center" style="max-width: 400px;">
            <h3 class="text-success fw-bold mb-4">ƒ∞badet Takip</h3>
            <button class="btn btn-dark w-100 py-3 rounded-pill" onclick="loginWithGoogle()">
                <i class="fab fa-google me-2"></i> Google ile Giri≈ü
            </button>
        </div>
    </div>

    <div id="app-wrapper" class="wrapper" style="display:none;">
        <nav id="sidebar">
            <div class="sidebar-header">
                <h4 class="fw-bold"><i class="fas fa-kaaba me-2"></i>Takip</h4>
                <div id="sidebarUserInfoBox" class="user-info-box">
                    <i class="fas fa-user-circle"></i>
                    <div id="sidebarUserInfo" class="user-info-text">Kullanƒ±cƒ±</div>
                </div>
            </div>
            <ul class="list-unstyled components">
                <li id="menu-dashboard" class="active" onclick="showSection('dashboard')"><i
                        class="fas fa-mosque me-3"></i>
                    Kaza Namazƒ±</li>
                <li id="menu-stats" onclick="showSection('stats')"><i class="fas fa-chart-pie me-3"></i> ƒ∞statistikler
                </li>
                <li id="menu-achievements" onclick="showSection('achievements')"><i class="fas fa-medal me-3"></i>
                    Ba≈üarƒ±lar
                    & √ñd√ºl</li>
                <li id="menu-fasting" onclick="showSection('fasting')"><i class="fas fa-utensils me-3"></i> Oru√ß Takip
                </li>
                <li id="menu-tesbihat" onclick="showSection('tesbihat')"><i class="fas fa-fingerprint me-3"></i>
                    Tesbihat
                </li>
                <li id="menu-calculator" onclick="showSection('calculator')"><i class="fas fa-calculator me-3"></i>
                    Hesap
                    Sihirbazƒ±</li>
                <li id="menu-settings" onclick="showSection('settings')"><i class="fas fa-cog me-3"></i> Yedekleme &
                    Ayarlar
                </li>
                <li onclick="toggleDarkMode()"><i class="fas fa-moon me-3"></i> <span id="darkModeText">Gece Modu</span>
                </li>
                <li onclick="logout()"><i class="fas fa-sign-out-alt me-3"></i> √áƒ±kƒ±≈ü Yap</li>
            </ul>
        </nav>

        <div id="content">
            <div id="section-dashboard" class="app-section active">
                <div id="menstrualToggleArea" class="menstrual-toggle-container" style="display:none;">
                    <div class="menstrual-label"><i class="fas fa-flower"></i> Muayyen G√ºn√ºmdeyim</div>
                    <div class="form-check form-switch"><input class="form-check-input" type="checkbox"
                            id="menstrualSwitch" style="width: 50px; height: 25px;"
                            onchange="toggleMenstrualState(this.checked)"></div>
                </div>
                <div class="row justify-content-center mb-4">
                    <div class="col-md-8 col-lg-6">
                        <div id="pausedBadge" class="paused-badge text-center w-100"><i
                                class="fas fa-pause-circle me-2"></i> ƒ∞lerleme Duraklatƒ±ldƒ± (Muayyen G√ºn)</div>
                        <div id="goalCard" class="goal-card">
                            <h4>üéØ G√ºnl√ºk Hedef</h4>
                            <div class="goal-content">
                                <span class="fs-5">Bug√ºn</span><strong class="fs-1"
                                    id="dailyCountDisplay">0</strong><span class="fs-5">/</span><input type="number"
                                    id="dailyGoalInput" class="goal-input" value="10"
                                    onchange="updateDailyGoal(this.value)"><span class="fs-5">Kaza</span>
                            </div>
                            <div class="progress mt-2"
                                style="height: 8px; background: rgba(255,255,255,0.3); border-radius: 10px;">
                                <div id="dailyProgressBar" class="progress-bar bg-warning" style="width: 0%"></div>
                            </div>
                            <div id="goalSuccessMessage" class="mt-2 fw-bold text-white" style="display: none;">üéâ
                                Harika!
                                Hedefe Ula≈üƒ±ldƒ±!</div>
                            <div class="mt-2 streak-box"><i class="fas fa-fire text-warning"></i>
                                <span>Zincir:</span><span id="streakValue" class="fw-bold text-warning">0</span>
                                <span>G√ºn</span>
                            </div>
                        </div>
                        <div id="weeklyCard" class="goal-card"
                            style="background: linear-gradient(135deg, #0d6efd, #0dcaf0); margin-top: 20px;">
                            <h4>üèÜ Haftalƒ±k Meydan Okuma</h4>
                            <div class="goal-content">
                                <span class="fs-5">Bu Hafta</span><strong class="fs-1"
                                    id="weeklyCountDisplay">0</strong><span class="fs-5">/</span><input type="number"
                                    id="weeklyGoalInput" class="goal-input" style="color:#0d6efd;" value="50"
                                    onchange="updateWeeklyGoal(this.value)">
                            </div>
                            <div class="progress mt-2"
                                style="height: 10px; background: rgba(255,255,255,0.3); border-radius: 10px;">
                                <div id="weeklyProgressBar" class="progress-bar bg-warning" style="width: 0%"></div>
                            </div>
                            <div id="weeklySuccessMessage" class="mt-2 fw-bold text-white" style="display: none;">üî• Bu
                                Hafta Tamamlandƒ±! Harikasƒ±n!</div>
                            <div class="small text-white-50 mt-2">Pazartesi'den bu yana ilerleme</div>
                        </div>
                    </div>
                </div>
                <div class="row g-3 mb-4 justify-content-center">
                    <div class="col-6 col-md-4">
                        <div class="fade-box"><label class="fw-bold text-secondary small">BA≈ûLAMA TARƒ∞Hƒ∞</label> <input
                                type="text" id="startDate" class="fs-6" placeholder="gg.aa.yyyy"
                                onfocus="(this.type='date')" onblur="(this.type='text')"></div>
                    </div>
                    <div class="col-6 col-md-4">
                        <div class="fade-box"><label class="fw-bold text-secondary small">GE√áEN S√úRE (G√úN)</label>
                            <input type="text" id="elapsedDays" class="fs-5" readonly>
                        </div>
                    </div>
                </div>

                <div id="prayerSplitContainer" class="prayer-split-layout">
                </div>

                <div id="summaryBar" class="summary-bar">
                    <div class="summary-item">
                        <div class="summary-val" id="sumTarget">0</div>
                        <div class="summary-lbl">Kƒ±lƒ±nacak</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-val text-warning" id="sumDone">0</div>
                        <div class="summary-lbl">Kƒ±lƒ±nan</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-val" id="sumRemaining">0</div>
                        <div class="summary-lbl">Kalan</div>
                    </div>
                </div>

                <div class="row mt-4 justify-content-center">
                    <div class="col-md-8 col-lg-6">
                        <div class="prediction-card h-100">
                            <i class="fas fa-hourglass-half prediction-icon"></i>
                            <h5 class="fw-bold">Ne Zaman Biter?</h5>
                            <div id="prediction-container">
                                <div class="mt-3">
                                    <div class="prediction-date" id="estFinishDate">Hesaplanƒ±yor...</div>
                                    <div class="prediction-days" id="estDaysLeft">...</div><span
                                        class="prediction-sub-label">G√ºnl√ºk Hedefe G√∂re</span>
                                </div>
                                <div class="prediction-secondary">
                                    <div class="date-small" id="estFinishDateAvg">Hesaplanƒ±yor...</div>
                                    <div class="prediction-days" id="estDaysLeftAvg">...</div><span
                                        class="prediction-sub-label">G√ºnl√ºk Ortalamanƒ±za G√∂re</span>
                                </div>
                            </div>
                            <div id="prediction-success" class="text-success fw-bold mt-2" style="display:none;">üéâ
                                Borcunuz
                                bulunmamaktadƒ±r!</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-achievements" class="app-section">
                <h3 class="app-header">Ba≈üarƒ±larƒ±m & Rozetler</h3>

                <div class="card mb-4 shadow-lg border-0"
                    style="border-radius: 20px; background: linear-gradient(135deg, #2c3e50, #4ca1af); color: white;">
                    <div class="card-body p-4 text-center">
                        <h5 class="text-white-50 text-uppercase small fw-bold">Toplam Skor</h5>
                        <h1 class="display-4 fw-bold mb-0" id="totalScoreDisplay">0</h1>
                        <div class="badge bg-warning text-dark mt-2 fs-6">Seviye: <span
                                id="userLevelDisplay">Ba≈ülangƒ±√ß</span></div>
                    </div>
                </div>

                <h5 class="fw-bold text-secondary mb-3 mt-4 text-center"><i class="fas fa-mosque me-2"></i>Namaz
                    Rozetleri
                </h5>
                <div id="badgeListNamaz" class="badge-grid"></div>

                <h5 class="fw-bold text-secondary mb-3 mt-4 text-center"><i class="fas fa-fire me-2"></i>Zincir ve
                    Devamlƒ±lƒ±k</h5>
                <div id="badgeListStreak" class="badge-grid"></div>
            </div>

            <div id="section-stats" class="app-section">
                <h3 class="app-header">ƒ∞statistikler</h3>
                <div class="stats-tab-container">
                    <button class="stats-tab-btn active" onclick="switchStatsTab('analysis')"
                        id="tabBtn-analysis">Analiz</button>
                    <button class="stats-tab-btn" onclick="switchStatsTab('history')" id="tabBtn-history">Son
                        Deƒüi≈üiklikler</button>
                </div>
                <div id="stats-view-analysis">
                    <div class="scrolling-wrapper mb-4">
                        <div class="stat-card-scroll">
                            <div class="stat-number text-primary" id="statToday">0</div>
                            <div class="stat-label">Bug√ºn</div>
                        </div>
                        <div class="stat-card-scroll">
                            <div class="stat-number text-success" id="statWeekly">0</div>
                            <div class="stat-label">Bu Hafta</div>
                        </div>
                        <div class="stat-card-scroll">
                            <div class="stat-number text-info" id="statMonthly">0</div>
                            <div class="stat-label">Bu Ay</div>
                        </div>
                        <div class="stat-card-scroll">
                            <div class="stat-number text-warning" id="stat3Months">0</div>
                            <div class="stat-label">Son 3 Ay</div>
                        </div>
                        <div class="stat-card-scroll">
                            <div class="stat-number text-danger" id="stat6Months">0</div>
                            <div class="stat-label">Son 6 Ay</div>
                        </div>
                        <div class="stat-card-scroll">
                            <div class="stat-number text-secondary" id="statYearly">0</div>
                            <div class="stat-label">Son 1 Yƒ±l</div>
                        </div>
                        <div class="stat-card-scroll">
                            <div class="stat-number" id="statAverage">0</div>
                            <div class="stat-label">G√ºnl√ºk Ort.</div>
                        </div>
                    </div>

                    <div class="analysis-box mb-4">
                        <div class="analysis-row">
                            <div class="analysis-icon icon-good"><i class="fas fa-check"></i></div>
                            <div class="analysis-text"><span class="analysis-title">En ƒ∞yi Performans</span><span
                                    class="analysis-value" id="bestPrayer">Hesaplanƒ±yor...</span></div>
                        </div>
                        <div class="analysis-row">
                            <div class="analysis-icon icon-bad"><i class="fas fa-exclamation"></i></div>
                            <div class="analysis-text"><span class="analysis-title">En √áok Bor√ß</span><span
                                    class="analysis-value" id="worstPrayer">Hesaplanƒ±yor...</span></div>
                        </div>
                    </div>

                    <div class="analysis-box mb-4">
                        <div class="analysis-row">
                            <div class="analysis-icon" style="background: #20c997; color: white;"><i
                                    class="fas fa-calendar-day"></i></div>
                            <div class="analysis-text">
                                <span class="analysis-title">En Verimli G√ºn</span>
                                <span class="analysis-value" id="bestDayVal">Hesaplanƒ±yor...</span>
                            </div>
                        </div>

                        <div class="analysis-row">
                            <div class="analysis-icon icon-blue"><i class="fas fa-calendar-week"></i></div>
                            <div class="analysis-text">
                                <span class="analysis-title">En Verimli Hafta</span>
                                <span class="analysis-value" id="bestWeekVal">Hesaplanƒ±yor...</span>
                            </div>
                        </div>
                        <div class="analysis-row">
                            <div class="analysis-icon icon-orange"><i class="fas fa-calendar-alt"></i></div>
                            <div class="analysis-text">
                                <span class="analysis-title">En Verimli Ay</span>
                                <span class="analysis-value" id="bestMonthVal">Hesaplanƒ±yor...</span>
                            </div>
                        </div>
                        <div class="analysis-row">
                            <div class="analysis-icon icon-purple"><i class="fas fa-fire-alt"></i></div>
                            <div class="analysis-text">
                                <span class="analysis-title">En G√º√ßl√º Zincir</span>
                                <span class="analysis-value" id="longestStreakVal">Hesaplanƒ±yor...</span>
                            </div>
                        </div>
                    </div>

                    <h5 class="text-secondary fw-bold ms-1 mb-3">Detaylƒ± Namaz Analizi</h5>
                    <div id="prayer-analysis-grid" class="mb-4">
                    </div>

                    <div class="row g-4">
                        <div class="col-md-12">
                            <div class="chart-container">
                                <h5 class="text-center mb-3 fw-bold">Namaz Bazlƒ± Daƒüƒ±lƒ±m</h5><canvas id="barChart"
                                    style="max-height: 350px;"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h5 class="text-center mb-3 fw-bold">Performans Analizi</h5>
                                <div class="d-flex justify-content-center mb-2">
                                    <div class="chart-period-selector">
                                        <div class="chart-period-btn active" id="btn-period-weekly"
                                            onclick="switchChartPeriod('weekly', this)">Haftalƒ±k</div>
                                        <div class="chart-period-btn" id="btn-period-monthly"
                                            onclick="switchChartPeriod('monthly', this)">Aylƒ±k</div>
                                        <div class="chart-period-btn" id="btn-period-3months"
                                            onclick="switchChartPeriod('3months', this)">3 Ay</div>
                                    </div>
                                </div>
                                <canvas id="lineChart" style="max-height: 250px;"></canvas>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="chart-container">
                                <h5 class="text-center mb-3 fw-bold">Genel Durum</h5>
                                <canvas id="completionChart" style="max-height: 250px;"></canvas>
                                <!-- New Legend Container -->
                                <div id="completionLegend" class="completion-legend"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="stats-view-history" style="display: none;">
                    <h5 class="text-center fw-bold mt-4 text-secondary">ƒ∞≈ülem Ge√ßmi≈üi</h5>

                    <div class="history-filter-tabs">
                        <div class="h-main-tabs">
                            <button class="h-tab-btn active" onclick="setHistoryCategory('all', this)">T√ºm√º</button>
                            <button class="h-tab-btn" onclick="setHistoryCategory('namaz', this)">Namaz</button>
                            <button class="h-tab-btn" onclick="setHistoryCategory('oruc', this)">Oru√ß</button>
                        </div>

                        <div id="namazSubTabs" class="h-sub-tabs">
                            <button class="h-sub-btn" onclick="setNamazSubCategory('Sabah', this)">Sabah</button>
                            <button class="h-sub-btn" onclick="setNamazSubCategory('√ñƒüle', this)">√ñƒüle</button>
                            <button class="h-sub-btn" onclick="setNamazSubCategory('ƒ∞kindi', this)">ƒ∞kindi</button>
                            <button class="h-sub-btn" onclick="setNamazSubCategory('Ak≈üam', this)">Ak≈üam</button>
                            <button class="h-sub-btn" onclick="setNamazSubCategory('Yatsƒ±', this)">Yatsƒ±</button>
                            <button class="h-sub-btn active" onclick="setNamazSubCategory('all', this)">T√ºm√º</button>
                        </div>

                        <div id="fastingSubTabs" class="h-sub-tabs">
                            <button class="h-sub-btn active" onclick="setFastingSubCategory('all', this)">T√ºm√º</button>
                            <button class="h-sub-btn" onclick="setFastingSubCategory('kaza', this)">Kaza</button>
                            <button class="h-sub-btn" onclick="setFastingSubCategory('nafile', this)">Nafile</button>
                        </div>
                    </div>

                    <div class="date-filter-capsule">
                        <span class="capsule-label">ƒ∞≈ûLEM TARƒ∞Hƒ∞</span>
                        <input type="text" id="historyFilterDate" class="capsule-input" placeholder="gg.aa.yyyy"
                            ontouchstart="(this.type='date');"
                            onfocus="(this.type='date'); if('showPicker' in HTMLInputElement.prototype) this.showPicker();"
                            onblur="if(!this.value) this.type='text'" onchange="filterHistoryByDate()">
                        <i id="resetHistoryDateBtn" class="fas fa-times capsule-reset"
                            onclick="clearHistoryFilter()"></i>
                    </div>

                    <div id="historyListContainer" class="px-2"></div>
                </div>
            </div>

            <div id="section-fasting" class="app-section">
                <h3 class="app-header">Oru√ß Takip</h3>
                <div id="fastingContainer"></div>
            </div>

            <div id="section-tesbihat" class="app-section">
                <h3 class="app-header">Tesbihat ve Zikir</h3>
                <div id="tesbihatContainer"></div>
            </div>

            <div id="section-calculator" class="app-section">
                <h3 class="app-header">Kaza Hesaplama Sihirbazƒ±</h3>
                <div class="row justify-content-center">
                    <div class="col-lg-10">
                        <div class="calculator-card">
                            <div id="femaleCalcInfo" class="custom-alert-box custom-alert-female" style="display:none;">
                                <div class="d-flex align-items-center mb-2"><i
                                        class="fas fa-female fa-lg me-2 text-danger"></i><span class="fw-bold">Kadƒ±n
                                        kullanƒ±cƒ± olarak i≈üaretlendiƒüiniz i√ßin hesaplamalardan Muayyen G√ºnler
                                        d√º≈ü√ºlecektir.</span></div>
                                <div class="d-flex align-items-center gap-2 mt-2"><span>Aylƒ±k Ortalama Muayyen G√ºn
                                        Sayƒ±sƒ±:</span><input type="number" id="menstrualDaysInput"
                                        class="form-control text-center fw-bold text-danger"
                                        style="width: 70px; height: 35px;" value="6"
                                        onchange="updateMenstrualDays(this.value)"></div>
                            </div>
                            <div class="custom-alert-box custom-alert-tip"><i class="fas fa-lightbulb me-2"></i>Sabah
                                Namazƒ±na girdiƒüiniz <strong>Sorumluluk Ba≈ülama (Buluƒü √áaƒüƒ±)</strong> ve <strong>Namaza
                                    D√ºzenli Ba≈ülama Tarihi</strong> deƒüerlerini <strong>Kopyala</strong> ile diƒüer
                                namazlara
                                uygulayabilirsiniz.</div>
                            <div class="d-flex justify-content-end gap-2 mb-3 flex-wrap">
                                <button class="btn btn-sm btn-outline-secondary" onclick="copyStartDate()"><i
                                        class="fas fa-copy me-1"></i> Sorumluluk Ba≈ülangƒ±√ß Tarihini Kopyala</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="copyEndDate()"><i
                                        class="fas fa-copy me-1"></i> D√ºzenli Ba≈ülama Tarihini Kopyala</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="resetCalculatorInputs()"><i
                                        class="fas fa-trash-alt me-1"></i> Temizle</button>
                            </div>
                            <div id="calcRowsContainer"></div>
                            <hr class="my-4">
                            <button class="btn btn-danger w-100 py-3 rounded-pill fw-bold"
                                onclick="applyAdvancedCalculation()"><i class="fas fa-check-circle me-2"></i>
                                Hesaplananlarƒ±
                                Onayla ve Aktar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-settings" class="app-section">
                <h3 class="app-header">Yedekleme ve Ayarlar</h3>
                <div class="row justify-content-center g-4">
                    <div class="col-12">
                        <div id="genderSettingsCard"
                            class="settings-card d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center"><i class="fas fa-venus-mars fs-2 me-3"
                                    style="opacity: 0.8;"></i>
                                <div>
                                    <div class="settings-title mb-0">Cinsiyet Ayarƒ±</div>
                                    <div class="settings-desc mb-0" id="currentGenderDisplay">Se√ßilmedi</div>
                                </div>
                            </div>
                            <button class="btn btn-light btn-sm fw-bold shadow-sm"
                                onclick="openGenderModal(true)">Deƒüi≈ütir</button>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-4">
                        <div class="settings-card text-center h-100"><i class="fas fa-download settings-icon"></i>
                            <div class="settings-title">Yedek Al</div>
                            <div class="settings-desc">Verileri indir.</div><button class="btn btn-success w-100"
                                onclick="downloadBackupJSON()"><i class="fas fa-file-export me-2"></i> Yedek ƒ∞ndir
                                (.json)</button>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-4">
                        <div class="settings-card text-center h-100"><i
                                class="fas fa-upload settings-icon text-primary"></i>
                            <div class="settings-title">Yedekten D√∂n</div>
                            <div class="settings-desc">Yedek dosyasƒ±nƒ± y√ºkle.</div><button class="btn btn-primary w-100"
                                onclick="document.getElementById('importFile').click()"><i
                                    class="fas fa-file-import me-2"></i> Yedek Y√ºkle</button><input type="file"
                                id="importFile" accept=".json" style="display: none;" onchange="importBackupJSON(this)">
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-4">
                        <div class="settings-card text-center h-100"><i
                                class="fas fa-file-csv settings-icon text-warning"></i>
                            <div class="settings-title">Excel Raporu</div>
                            <div class="settings-desc">Excel (.csv) formatƒ±nda indir.</div><button
                                class="btn btn-warning w-100 text-white" onclick="downloadDataAsCSV()"><i
                                    class="fas fa-table me-2"></i> Rapor ƒ∞ndir (.csv)</button>
                        </div>
                    </div>

                    <div id="installAppContainer" class="col-md-6 col-lg-4" style="display: none;">
                        <div class="settings-card text-center h-100"
                            style="border: 2px solid #609979; background: linear-gradient(135deg, rgba(96, 153, 121, 0.1), rgba(255, 255, 255, 0.5));">
                            <i class="fas fa-mobile-alt settings-icon text-success"></i>
                            <div class="settings-title">Uygulamayƒ± ƒ∞ndir</div>
                            <div class="settings-desc">ƒ∞nternetsiz eri≈üim i√ßin y√ºkle.</div>
                            <button class="btn btn-success w-100 fw-bold shadow-sm" onclick="installPWA()">
                                <i class="fas fa-download me-2"></i> Ana Ekrana Ekle
                            </button>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="settings-card text-center border-danger"><i
                                class="fas fa-exclamation-triangle settings-icon text-danger"></i>
                            <div class="settings-title text-danger">Verileri Sƒ±fƒ±rla</div>
                            <div class="settings-desc">Her ≈üeyi siler.</div><button class="btn btn-danger py-2 px-5"
                                onclick="confirmResetData()"><i class="fas fa-trash-alt me-2"></i> Her ≈ûeyi Sil ve
                                Sƒ±fƒ±rla</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="showSection('dashboard'); activateNav(this)"><i
                class="fas fa-mosque"></i><span>Kaza</span></div>
        <div class="nav-item" onclick="showSection('achievements'); activateNav(this)"><i class="fas fa-medal"></i><span
                style="font-size: 0.65rem;">√ñd√ºl</span></div>
        <div class="nav-item" onclick="showSection('stats'); activateNav(this)"><i
                class="fas fa-chart-pie"></i><span>Analiz</span></div>
        <div class="nav-item" onclick="showSection('fasting'); activateNav(this)"><i
                class="fas fa-utensils"></i><span>Oru√ß</span></div>
        <div class="nav-item" onclick="showSection('tesbihat'); activateNav(this)"><i
                class="fas fa-fingerprint"></i><span>Zikir</span></div>
        <div class="nav-item" onclick="toggleSidebar()"><i class="fas fa-bars"></i><span>Men√º</span></div>
    </div>

    <script>
        const jsConfetti = new JSConfetti();
        let currentChartPeriod = 'weekly';
        let activeRowIndex = 0;
        let currentHistoryCategory = 'all';
        let currentFastingSubCat = 'all';
        let currentNamazSubCat = 'all';
        let activeTesbihatIndex = 0;
        let isTesbihatDetailView = false;
        let activeFastingIndex = 0;

        function triggerHaptic() { if (navigator.vibrate) navigator.vibrate(10); }

        function hideLoader() {
            const loader = document.getElementById('loading-overlay');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => { loader.style.visibility = 'hidden'; }, 500);
            }
        }

        setTimeout(() => { hideLoader(); }, 5000);

        const pwaIcon = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23609979' d='M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256 256-114.6 256-256S401.4 0 256 0zm-46.8 389L68.6 248.4c-4.7-4.7-4.7-12.3 0-17l28.3-28.3c4.7-4.7 12.3-4.7 17 0L209.2 298l188.8-188.8c4.7-4.7 12.3-4.7 17 0l28.3 28.3c4.7 4.7 4.7 12.3 0 17L226.2 389c-4.7 4.7-12.3 4.7-17 0z'/%3E%3C/svg%3E";
        const manifestBlob = new Blob([JSON.stringify({
            "name": "Kaza ƒ∞badet Takip v1.0", "short_name": "ƒ∞badet", "start_url": "./index.html", "display": "standalone",
            "orientation": "any", "background_color": "#f8f9fa", "theme_color": "#609979",
            "icons": [{ "src": pwaIcon, "sizes": "192x192", "type": "image/svg+xml" }]
        })], { type: 'application/json' });
        document.querySelector('#my-manifest').href = URL.createObjectURL(manifestBlob);
        const firebaseConfig = {
            apiKey: "AIzaSyC7zdr3x8H--8piHR_1muAz2TVOOaebI54",
            authDomain: "kazanamazi-ser.firebaseapp.com",
            databaseURL: "https://kazanamazi-ser-default-rtdb.firebaseio.com",
            projectId: "kazanamazi-ser",
            storageBucket: "kazanamazi-ser.firebasestorage.app",
            messagingSenderId: "951730390034",
            appId: "1:951730390034:web:639f96ee859c10b0e944cb",
            measurementId: "G-5WGCDTL1RX"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();
        let dbRef = null;

        function getCurrentDateSimple() { const d = new Date(); return d.toLocaleDateString('tr-TR'); }
        function getIsoDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        function formatDateTR(isoDate) {
            if (!isoDate) return "";
            if (isoDate.includes('.') && isoDate.split('.')[0].length <= 2) return isoDate; const parts = isoDate.split('-');
            if (parts.length !== 3) return isoDate; const [y, m, d] = parts; return `${d}.${m}.${y}`;
        } const defaultData = {
            startDate: new Date().toISOString().split('T')[0], gender: null, menstrualDaysPerMonth: 6, isMenstrualState: false,
            daily: { date: getCurrentDateSimple(), counts: [0, 0, 0, 0, 0], target: 10 }, weeklyTarget: 50, streak: {
                current: 0,
                lastAchievedDate: ""
            }, calendar: {}, logs: {}, counts:
                [{ name: "Sabah", target: 0, done: 0 }, { name: "√ñƒüle", target: 0, done: 0 }, { name: "ƒ∞kindi", target: 0, done: 0 }, { name: "Ak≈üam", target: 0, done: 0 }, { name: "Yatsƒ±", target: 0, done: 0 }],
            tesbihat: [{
                name: "Subhanallah", arabic: "ÿ≥Ÿèÿ®Ÿíÿ≠ŸéÿßŸÜŸé Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸê", current: 0, target: 33, colorTheme: 'theme-blue'
            }, { name: "Elhamdulillah", arabic: "Ÿ±ŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸéŸëŸ∞ŸáŸê", current: 0, target: 33, colorTheme: 'theme-green' }, {
                name: "Allahu Ekber", arabic: "Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸè ÿ£ŸéŸÉŸíÿ®Ÿéÿ±Ÿè", current: 0, target: 33, colorTheme: 'theme-orange'
            }, {
                name: "La ilahe ƒ∞llallah", arabic: "ŸÑŸéÿß ÿ•ŸêŸÑŸéŸ∞ŸáŸé ÿ•ŸêŸÑŸéŸëÿß Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸè", current: 0, target: 100, colorTheme: 'theme-red'
            }], fasting: { kaza: { target: 0, done: 0, hasTarget: false }, nafile: { target: 10, done: 0, hasTarget: false } },
            earnedBadges: [], history: []
        }; let localData = JSON.parse(JSON.stringify(defaultData)); const
            saved = localStorage.getItem('offlineBackup'); if (saved) {
                localData = JSON.parse(saved);
                document.addEventListener('DOMContentLoaded', () => {
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('app-wrapper').style.display = 'flex';
                    if (localData.gender) applyGenderSettings();
                    renderCalculatorRows();
                    renderApp();
                    renderStats();
                    hideLoader();
                });
            }

        let chartCompletion = null, barChart = null, lineChart = null;

        auth.onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-wrapper').style.display = 'flex';
                document.getElementById('sidebarUserInfo').innerText = user.displayName;

                dbRef = db.ref('users/' + user.uid + '/namazData');
                dbRef.on('value', (s) => {
                    const d = s.val();
                    if (d) {
                        localData = d;
                        localStorage.setItem('offlineBackup', JSON.stringify(localData));
                    } else {
                        if (!saved) {
                            localData = JSON.parse(JSON.stringify(defaultData));
                        }
                    }

                    ensureDataStructure();
                    checkDailyReset();

                    if (!d && !saved) saveToCloud();

                    if (!localData.gender) {
                        if (document.getElementById('gender-selection-modal').style.display === 'none') openGenderModal(false);
                    } else {
                        applyGenderSettings();
                    }

                    try {
                        renderCalculatorRows();
                        renderApp();
                        renderStats();
                        renderFasting();
                    } catch (e) {
                        console.error("Render hatasƒ±:", e);
                    }
                    hideLoader();
                });
            } else {
                if (!saved) {
                    document.getElementById('loading-overlay').style.display = 'none';
                    document.getElementById('login-screen').style.display = 'flex';
                    document.getElementById('app-wrapper').style.display = 'none';
                    localData = JSON.parse(JSON.stringify(defaultData));
                }
            }
        });

        function loginWithGoogle() {
            provider.setCustomParameters({ prompt: 'select_account' });
            auth.signInWithPopup(provider).catch(e => showModal("Hata", e.message));
        }

        function logout() {
            auth.signOut().then(() => {
                localStorage.removeItem('offlineBackup');
                window.location.reload();
            });
        }

        function saveToCloud() {
            if (dbRef) dbRef.set(localData);
            localStorage.setItem('offlineBackup', JSON.stringify(localData));
        }

        function ensureDataStructure() {
            if (!localData.counts) localData.counts = JSON.parse(JSON.stringify(defaultData.counts));
            if (!localData.tesbihat) localData.tesbihat = JSON.parse(JSON.stringify(defaultData.tesbihat));

            if (localData.tesbihat) {
                localData.tesbihat.forEach(t => {
                    if (t.name === "S√ºbhanallah") t.name = "Subhanallah";
                    if (t.name === "Elhamd√ºlillah") t.name = "Elhamdulillah";
                    if (!t.colorTheme || t.colorTheme.startsWith('grad-')) t.colorTheme = 'theme-blue';
                });
            }

            if (!localData.fasting) localData.fasting = JSON.parse(JSON.stringify(defaultData.fasting));
            if (!localData.fasting.nafile) localData.fasting.nafile = { target: 10, done: 0, hasTarget: false };
            if (localData.fasting.kaza && localData.fasting.kaza.hasTarget === undefined) localData.fasting.kaza.hasTarget =
                false;

            if (!localData.calendar) localData.calendar = {};
            if (!localData.logs) localData.logs = {};
            if (localData.weeklyTarget === undefined) localData.weeklyTarget = 50;
            if (localData.menstrualDaysPerMonth === undefined) localData.menstrualDaysPerMonth = 6;
            if (localData.isMenstrualState === undefined) localData.isMenstrualState = false;

            const t = new Date().toLocaleDateString('tr-TR');
            if (!localData.daily || localData.daily.date !== t) {
                localData.daily = { date: t, counts: [0, 0, 0, 0, 0], target: localData.daily?.target || 10 };
                saveToCloud();
            }
            if (!localData.streak) localData.streak = { current: 0, lastAchievedDate: "" };
            if (!localData.history) localData.history = [];
            if (!localData.earnedBadges) localData.earnedBadges = [];
            if (!localData.startDate) localData.startDate = new Date().toISOString().split('T')[0];
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (container.childElementCount >= 3) {
                container.removeChild(container.firstChild);
            }
            const toast = document.createElement('div');
            toast.className = `custom-toast toast-${type}`;
            const icon = type === 'success' ? '<i class="fas fa-check-circle"></i>' : (type === 'warning' ? '<i
        class="fas fa-wifi" ></i > ' : ' < i class="fas fa-exclamation-circle" ></i > ');
            toast.innerHTML = `${icon}<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'toastFadeOut 0.4s forwards';
                setTimeout(() => {
                    if (toast.parentElement) toast.parentElement.removeChild(toast);
                }, 400);
            }, 3000);
        }

        function openGenderModal(force) { document.getElementById('gender-selection-modal').style.display = 'flex'; }
        function selectGender(g) {
            localData.gender = g; if (g === 'male') {
                localData.isMenstrualState = false;
                localData.menstrualDaysPerMonth = 0;
            } else {
                if (!localData.menstrualDaysPerMonth) localData.menstrualDaysPerMonth =
                    6;
            } saveToCloud(); document.getElementById('gender-selection-modal').style.display = 'none'; applyGenderSettings();
            renderCalculatorRows(); renderApp();
        }

        function applyGenderSettings() {
            const toggleArea = document.getElementById('menstrualToggleArea');
            const calcInfo = document.getElementById('femaleCalcInfo');
            const genderText = document.getElementById('currentGenderDisplay');
            const userInfoBox = document.getElementById('sidebarUserInfoBox');
            const settingsCard = document.getElementById('genderSettingsCard');

            document.querySelectorAll('.gender-option').forEach(el => el.classList.remove('selected'));
            if (settingsCard) settingsCard.classList.remove('settings-gender-male', 'settings-gender-female');
            if (userInfoBox) userInfoBox.classList.remove('user-info-male', 'user-info-female');

            if (localData.gender === 'female') {
                toggleArea.style.display = 'flex';
                calcInfo.style.display = 'block';
                genderText.innerText = "Kadƒ±n";
                document.getElementById('menstrualSwitch').checked = localData.isMenstrualState;
                document.getElementById('menstrualDaysInput').value = localData.menstrualDaysPerMonth;
                if (userInfoBox) userInfoBox.classList.add('user-info-female');
                if (settingsCard) settingsCard.classList.add('settings-gender-female');
                document.getElementById('genderOptFemale').classList.add('selected');
            } else {
                toggleArea.style.display = 'none';
                calcInfo.style.display = 'none';
                genderText.innerText = "Erkek";
                if (userInfoBox) userInfoBox.classList.add('user-info-male');
                if (settingsCard) settingsCard.classList.add('settings-gender-male');
                document.getElementById('genderOptMale').classList.add('selected');
            }
        }

        function toggleMenstrualState(isChecked) { localData.isMenstrualState = isChecked; saveToCloud(); renderApp(); }
        window.updateMenstrualDays = function (val) {
            localData.menstrualDaysPerMonth = parseInt(val) || 0; saveToCloud();
            for (let i = 0; i < 5; i++) { window.calcRow(i); }
        } const SECTION_IDS = ['dashboard', 'achievements', 'stats', 'fasting'
            , 'tesbihat', 'calculator', 'settings']; function getSectionIndex(id) {
                return
                SECTION_IDS.indexOf(id.replace('section-', ''));
            } window.showSection = function (targetId) {
                if (!targetId)
                    targetId = 'dashboard'; document.querySelectorAll('#sidebar ul li').forEach(li => li.classList.remove('active'));
                const menuItem = document.getElementById('menu-' + targetId);
                if (menuItem) menuItem.classList.add('active');

                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const navMap = { 'dashboard': 0, 'achievements': 1, 'stats': 2, 'fasting': 3, 'tesbihat': 4 };
                if (navMap[targetId] !== undefined)
                    document.querySelectorAll('.nav-item')[navMap[targetId]].classList.add('active');

                triggerLogic(targetId);

                document.querySelectorAll('.app-section').forEach(sec => {
                    sec.classList.remove('active');
                    sec.style.transform = '';
                    sec.classList.remove('sliding', 'animate-transition');
                });

                const targetSection = document.getElementById('section-' + targetId);
                if (targetSection) targetSection.classList.add('active');

                if (window.innerWidth < 768) {
                    document.getElementById('sidebar').classList.remove('active');
                    document.getElementById('overlay').classList.remove('active');
                }
            }; function triggerLogic(id) {
                try {
                    if (id === 'dashboard') renderApp(); if (id === 'stats') renderStats(); if (id === 'tesbihat') renderTesbihat();
                    if (id === 'calculator') renderCalculatorRows(); if (id === 'fasting') renderFasting(); if (id === 'achievements')
                        renderAchievements();
                } catch (e) { console.log("Render error:", e); }
            } let startX = 0; let startY = 0; let
                currentTranslate = 0; let isDragging = false; let activeSection = null; let prevSection = null; let
                    nextSection = null; let touchStartTime = 0; let isHorizontalMove = false; let isVerticalMove = false; let
                        isSwipeInitialized = false; let isPulling = false; const ptrThreshold = 70; const
                            ptrSpinner = document.getElementById('ptr-spinner'); const contentArea = document.getElementById('content');
        contentArea.addEventListener('touchstart', e => {
            if (shouldIgnoreSwipe(e.target)) return;

            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            touchStartTime = Date.now();

            isHorizontalMove = false;
            isVerticalMove = false;
            isSwipeInitialized = false;
            isPulling = false;

            isDragging = true;

            activeSection = document.querySelector('.app-section.active');
            if (!activeSection) return;

            activeSection.classList.remove('animate-transition');

        }, { passive: true });

        contentArea.addEventListener('touchmove', e => {
            if (!isDragging || !activeSection) return;

            const currentX = e.touches[0].clientX;
            const currentY = e.touches[0].clientY;
            const diffX = currentX - startX;
            const diffY = currentY - startY;

            if (activeSection.id === 'section-dashboard' && activeSection.scrollTop === 0 && diffY > 0 &&
                !isHorizontalMove) {
                if (diffY > 10) {
                    isPulling = true;
                    ptrSpinner.style.display = 'block';
                    ptrSpinner.style.transform = `rotate(${diffY * 3}deg)`;

                    let opacity = Math.min(1, diffY / ptrThreshold);
                    ptrSpinner.style.opacity = opacity;

                    if (diffY > ptrThreshold) {
                        ptrSpinner.style.borderTopColor = "#20c997";
                    } else {
                        ptrSpinner.style.borderTopColor = "#609979";
                    }
                }
                return;
            }

            if (isVerticalMove) {
                isDragging = false;
                resetStyles();
                return;
            }

            if (!isHorizontalMove) {
                if (Math.abs(diffY) > Math.abs(diffX) && Math.abs(diffY) > 5) {
                    isVerticalMove = true;
                    isDragging = false;
                    resetStyles();
                    return;
                }

                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 15) {
                    isHorizontalMove = true;
                    if (e.cancelable) e.preventDefault();
                } else {
                    return;
                }
            }

            if (isHorizontalMove) {
                if (e.cancelable) e.preventDefault();

                if (!isSwipeInitialized) {
                    const currentIndex = getSectionIndex(activeSection.id);
                    prevSection = currentIndex > 0 ? document.getElementById('section-' + SECTION_IDS[currentIndex - 1]) : null;
                    nextSection = currentIndex < SECTION_IDS.length - 1 ? document.getElementById('section-' +
                        SECTION_IDS[currentIndex + 1]) : null; if (prevSection) {
                            prevSection.classList.remove('animate-transition'); prevSection.classList.add('sliding');
                            prevSection.style.transform = 'translateX(-100%)'; triggerLogic(SECTION_IDS[currentIndex - 1]);
                        }
                    if (nextSection) {
                        nextSection.classList.remove('animate-transition');
                        nextSection.classList.add('sliding'); nextSection.style.transform = 'translateX(100%)';
                        triggerLogic(SECTION_IDS[currentIndex + 1]);
                    } isSwipeInitialized = true;
                } currentTranslate = diffX;
                activeSection.style.transform = `translateX(${diffX}px)`; if (prevSection)
                    prevSection.style.transform = `translateX(${diffX - contentArea.offsetWidth}px)`; if (nextSection)
                    nextSection.style.transform = `translateX(${diffX + contentArea.offsetWidth}px)`;
            }
        }, { passive: false });
        contentArea.addEventListener('touchend', e => {
            if (!isDragging || !activeSection) return;
            isDragging = false;

            if (isPulling) {
                const currentY = e.changedTouches[0].clientY;
                const diffY = currentY - startY;

                if (diffY > ptrThreshold) {
                    performRefresh();
                } else {
                    resetPtr();
                }
                isPulling = false;
                return;
            }

            if (!isHorizontalMove) {
                resetStyles();
                return;
            }

            const movedBy = currentTranslate;
            const contentWidth = contentArea.offsetWidth;
            const threshold = contentWidth * 0.25;
            const duration = Date.now() - touchStartTime;

            const isFastSwipe = duration < 200 && Math.abs(movedBy) > 60;

            if ((movedBy < -threshold || (isFastSwipe && movedBy < 0)) && nextSection) {
                finishTransition(activeSection, -contentWidth); finishTransition(nextSection, 0);
                updateActiveState(nextSection);
            } else if ((movedBy > threshold || (isFastSwipe && movedBy > 0))
                && prevSection) {
                finishTransition(activeSection, contentWidth);
                finishTransition(prevSection, 0);
                updateActiveState(prevSection);
            } else {
                snapBack();
            }
        });

        function performRefresh() {
            ptrSpinner.style.borderTopColor = "#20c997";
            ptrSpinner.style.animation = "spin 0.5s linear infinite";
            triggerHaptic();
            setTimeout(() => {
                renderApp();
                showToast("Veriler g√ºncellendi", "success");
                resetPtr();
            }, 800);
        }

        function resetPtr() {
            ptrSpinner.style.display = 'none';
            ptrSpinner.style.opacity = 0;
        }

        function shouldIgnoreSwipe(target) {
            if (!target) return false;
            return target.closest('.scrolling-wrapper, .prayer-side-menu, canvas, .stats-tab-container,
                .history - filter - tabs, .date - filter - capsule');
                        }

        function finishTransition(element, targetX) {
            if (!element) return;
            element.classList.add('animate-transition');
            element.style.transform = `translateX(${targetX}px)`;
        }

        function snapBack() {
            if (activeSection) finishTransition(activeSection, 0);
            if (prevSection) finishTransition(prevSection, -contentArea.offsetWidth);
            if (nextSection) finishTransition(nextSection, contentArea.offsetWidth);

            setTimeout(resetStyles, 300);
        }

        function updateActiveState(newActiveSection) {
            setTimeout(() => {
                document.querySelectorAll('.app-section').forEach(s => {
                    s.classList.remove('active', 'sliding', 'animate-transition');
                    s.style.transform = '';
                });
                newActiveSection.classList.add('active');

                const newId = newActiveSection.id.replace('section-', '');

                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const navMap = { 'dashboard': 0, 'achievements': 1, 'stats': 2, 'fasting': 3, 'tesbihat': 4 };
                if (navMap[newId] !== undefined)
                    document.querySelectorAll('.nav-item')[navMap[newId]].classList.add('active');

                document.querySelectorAll('#sidebar ul li').forEach(li => li.classList.remove('active'));
                const menuItem = document.getElementById('menu-' + newId);
                if (menuItem) menuItem.classList.add('active');

            }, 300);
        }

        function resetStyles() {
            if (prevSection) {
                prevSection.classList.remove('sliding', 'animate-transition');
                prevSection.style.transform = '';
            }
            if (nextSection) {
                nextSection.classList.remove('sliding', 'animate-transition');
                nextSection.style.transform = '';
            }
            if (activeSection) {
                activeSection.classList.remove('animate-transition');
                activeSection.style.transform = '';
            }
            currentTranslate = 0;
            isHorizontalMove = false;
            isVerticalMove = false;
            isSwipeInitialized = false;
            prevSection = null;
            nextSection = null;
        }

        function toggleSidebar() {
            triggerHaptic();
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }
        function activateNav(element) {
            triggerHaptic();
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); if (element)
                element.classList.add('active');
        }

        function renderApp() {
            if (!localData.counts) return;
            const todayISO = getIsoDate(new Date());
            const todayTotal = localData.daily.counts.reduce((a, b) => a + b, 0);
            if (localData.logs[todayISO] !== todayTotal) {
                localData.logs[todayISO] = todayTotal;
                if (dbRef) dbRef.child('logs').update({ [todayISO]: todayTotal });
            }
            recalculateStreak();

            const dateInput = document.getElementById('startDate');
            if (dateInput.type !== 'date') { dateInput.value = formatDateTR(localData.startDate); } else {
                dateInput.value = localData.startDate;
            }

            const isPaused = localData.gender === 'female' && localData.isMenstrualState;
            const pausedBadge = document.getElementById('pausedBadge');
            const goalCard = document.getElementById('goalCard');
            const weeklyCard = document.getElementById('weeklyCard');
            const splitContainer = document.getElementById('prayerSplitContainer');

            if (isPaused) {
                pausedBadge.style.display = 'block';
                goalCard.classList.add('paused-mode-overlay'); weeklyCard.classList.add('paused-mode-overlay');
                splitContainer.classList.add('paused-mode-overlay');
            } else {
                pausedBadge.style.display =
                    'none'; goalCard.classList.remove('paused-mode-overlay');
                weeklyCard.classList.remove('paused-mode-overlay');
                splitContainer.classList.remove('paused-mode-overlay');
            }

            document.getElementById('dailyCountDisplay').innerText = todayTotal;
            document.getElementById('dailyGoalInput').value = localData.daily.target;
            let p = (todayTotal / localData.daily.target) * 100; if (p > 100) p = 100;
            document.getElementById('dailyProgressBar').style.width = p + "%";
            if (todayTotal >= localData.daily.target) {
                document.getElementById('goalCard').classList.add('success-mode');
                document.getElementById('goalSuccessMessage').style.display = 'block';
            } else {
                document.getElementById('goalCard').classList.remove('success-mode');
                document.getElementById('goalSuccessMessage').style.display = 'none';
            }
            document.getElementById('streakValue').innerText = localData.streak.current;

            const weeklyTotal = getWeeklyProgress();
            const weeklyTarget = localData.weeklyTarget || 50;
            document.getElementById('weeklyCountDisplay').innerText = weeklyTotal;
            document.getElementById('weeklyGoalInput').value = weeklyTarget;
            let wp = (weeklyTotal / weeklyTarget) * 100; if (wp > 100) wp = 100;
            document.getElementById('weeklyProgressBar').style.width = wp + "%";
            const wCard = document.getElementById('weeklyCard'); const wMsg =
                document.getElementById('weeklySuccessMessage');
            if (weeklyTotal >= weeklyTarget) {
                wCard.classList.add('success-mode'); wMsg.style.display =
                    'block';
            } else { wCard.classList.remove('success-mode'); wMsg.style.display = 'none'; }


            if (document.getElementById('prayerDetailCard')) {
                updateCardUI(activeRowIndex);
            } else {
                splitContainer.innerHTML = "";
                let menuHTML = `<div class="prayer-side-menu">`;
                const iconList = ["fa-cloud-sun", "fa-sun", "fa-cloud-sun", "fa-moon", "fa-star"];
                const themeList = ["theme-sabah", "theme-ogle", "theme-ikindi", "theme-aksam",
                    "theme-yatsi"];

                localData.counts.forEach((item, i) => {
                    const isActive = (i === activeRowIndex) ? 'active' : '';
                    const flipClass = (i === 2) ? 'flip-icon' : '';

                    menuHTML += `
                            <div id="menuItem${i}" class="side-menu-item ${isActive} ${themeList[i]}"
                                onclick="setActivePrayer(${i})">
                                <i class="fas ${iconList[i]} side-menu-icon ${flipClass}"></i>
                                <div class="side-menu-label">${item.name}</div>
                            </div>`;
                });
                menuHTML += `
                        </div>`;

                let cardHTML = `
                        <div id="prayerDetailCard" class="prayer-detail-card">
                            <div class="pd-content">
                                <div class="pd-header">
                                    <div class="pd-title"><i id="pdTitleIcon" class="fas"></i> <span
                                            id="pdTitleText"></span></div>
                                    <div id="pdRemainingBadge" class="pd-remaining-badge"></div>
                                </div>

                                <div class="pd-stats-row">
                                    <div class="pd-input-group">
                                        <span class="pd-label">KILINACAK</span>
                                        <input type="number" id="pdInputTarget" class="pd-input">
                                    </div>
                                    <div class="pd-input-group">
                                        <span class="pd-label text-success">KILINAN</span>
                                        <input type="number" id="pdInputDone" class="pd-input text-success">
                                    </div>
                                </div>

                                <div class="pd-progress-container">
                                    <div class="pd-progress-track">
                                        <div id="pdProgressFill" class="pd-progress-fill"></div>
                                    </div>
                                    <div id="pdProgressText" class="pd-progress-text"></div>
                                </div>

                                <div class="pd-actions">
                                    <button id="btnMinus" class="pd-btn pd-btn-minus"><i
                                            class="fas fa-minus"></i></button>
                                    <button id="btnPlus" class="pd-btn pd-btn-plus"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                        </div>`;

                splitContainer.innerHTML = menuHTML + cardHTML;
                document.getElementById('pdInputTarget').onchange = (e) => window.upT(activeRowIndex,
                    e.target.value);
                document.getElementById('pdInputDone').onchange = (e) => window.upD(activeRowIndex,
                    e.target.value);
                document.getElementById('btnMinus').onclick = () => window.chC(activeRowIndex, -1);
                document.getElementById('btnPlus').onclick = () => window.chC(activeRowIndex, 1);
                updateCardUI(activeRowIndex);
            }

            let tt = 0, td = 0;
            localData.counts.forEach(c => { tt += parseInt(c.target); td += parseInt(c.done); });
            const days = getElapsedDays();
            document.getElementById('elapsedDays').value = days;

            document.getElementById('sumTarget').innerText = tt;
            document.getElementById('sumDone').innerText = td;
            document.getElementById('sumRemaining').innerText = tt - td;

            calculateEstFinish(td, days);
        }

        function updateCardUI(index) {
            const item = localData.counts[index];
            const remaining = Math.max(0, item.target - item.done);
            const percent = item.target > 0 ? (item.done / item.target) * 100 : 0;
            const bgList = ["bg-sabah", "bg-ogle", "bg-ikindi", "bg-aksam", "bg-yatsi"];
            const iconList = ["fa-cloud-sun", "fa-sun", "fa-cloud-sun", "fa-moon", "fa-star"];

            const card = document.getElementById('prayerDetailCard');
            if (card) card.className = `prayer-detail-card ${bgList[index]}`;

            const iconEl = document.getElementById('pdTitleIcon');
            if (iconEl) {
                iconEl.className = `fas ${iconList[index]}`;
                if (index === 2) iconEl.classList.add('flip-icon');
                else iconEl.classList.remove('flip-icon');
            }

            const titleText = document.getElementById('pdTitleText');
            if (titleText) titleText.innerText = item.name;

            const badge = document.getElementById('pdRemainingBadge');
            if (badge) badge.innerText = `Kalan: ${remaining}`;

            const inpTarget = document.getElementById('pdInputTarget');
            if (inpTarget) inpTarget.value = item.target;

            const inpDone = document.getElementById('pdInputDone');
            if (inpDone) inpDone.value = item.done;

            const progFill = document.getElementById('pdProgressFill');
            if (progFill) progFill.style.width = `${percent}%`;

            const progText = document.getElementById('pdProgressText');
            if (progText) progText.innerText = `%${percent.toFixed(1)} Tamamlandƒ±`;

            document.querySelectorAll('.side-menu-item').forEach((el, i) => {
                if (i === index) el.classList.add('active');
                else el.classList.remove('active');
            });

            if (inpTarget) inpTarget.onchange = (e) => window.upT(index, e.target.value);
            if (inpDone) inpDone.onchange = (e) => window.upD(index, e.target.value);

            const btnMinus = document.getElementById('btnMinus');
            if (btnMinus) btnMinus.onclick = () => window.chC(index, -1);

            const btnPlus = document.getElementById('btnPlus');
            if (btnPlus) btnPlus.onclick = () => window.chC(index, 1);
        }

        window.setActivePrayer = function (index) {
            activeRowIndex = index;
            triggerHaptic();
            updateCardUI(index);
            setTimeout(() => {
                const activeEl = document.getElementById(`menuItem${index}`);
                if (activeEl) activeEl.scrollIntoView({
                    behavior: 'smooth', inline: 'center', block: 'nearest'
                });
            }, 100);
        }

        window.renderCalculatorRows = function () {
            const c =
                document.getElementById('calcRowsContainer'); if (!c || c.innerHTML.trim()) return; const
                    prayerTypes = ["Sabah", "√ñƒüle", "ƒ∞kindi", "Ak≈üam", "Yatsƒ±"]; prayerTypes.forEach((p, i) => {
                        c.innerHTML += `<div class="calc-row" id="row-${i}">
                            <div class="calc-header">${p}</div>
                            <div class="calc-body">
                                <div class="calc-item">
                                    <div class="calc-group-box"><span class="calc-label-small">Sorumluluk
                                            Ba≈ülangƒ±cƒ±</span><input type="text" class="form-control date-input"
                                            placeholder="gg.aa.yyyy" ontouchstart="(this.type='date')"
                                            onfocus="(this.type='date'); if('showPicker' in HTMLInputElement.prototype) this.showPicker();"
                                            onblur="(this.type='text'); this.value = formatDateTR(this.value);"
                                            onchange="window.calcRow(${i})"></div>
                                </div>
                                <div class="calc-item">
                                    <div class="calc-group-box"><span class="calc-label-small">D√ºzenli Ba≈ülama
                                            Tarihi</span><input type="text" class="form-control date-input"
                                            placeholder="gg.aa.yyyy" ontouchstart="(this.type='date')"
                                            onfocus="(this.type='date'); if('showPicker' in HTMLInputElement.prototype) this.showPicker();"
                                            onblur="(this.type='text'); this.value = formatDateTR(this.value);"
                                            onchange="window.calcRow(${i})"></div>
                                </div>
                                <div class="calc-item">
                                    <div class="calc-group-box" style="justify-content:center;"><span
                                            class="calc-label-small">Hesaplanan G√ºn</span><input type="number"
                                            class="form-control calc-result-input" id="res-${i}" value="0"></div>
                                </div>
                            </div>
                        </div>`;
                    });
        };
        window.calcRow = function (i) {
            const r = document.getElementById(`row-${i}`); const inputs =
                r.querySelectorAll('input'); let s = inputs[0].value; let e = inputs[1].value; function
                parseDateTR(val) {
                if (!val) return null; if (val.includes('.') && val.split('.').length === 3) {
                    const parts = val.split('.'); return new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                } return
                new Date(val);
            } if (s && e) {
                const startDate = parseDateTR(s); const endDate = parseDateTR(e);
                if (startDate && endDate && !isNaN(startDate) && !isNaN(endDate)) {
                    let totalDays =
                        Math.ceil((endDate - startDate) / (86400000)); if (localData.gender === 'female') {
                            const
                                totalMonths = totalDays / 30.44; const menstrualDeduction = Math.floor(totalMonths *
                                    (localData.menstrualDaysPerMonth || 6)); totalDays = totalDays - menstrualDeduction;
                        }
                    document.getElementById(`res-${i}`).value = Math.max(0, totalDays);
                }
            }
        };

        window.upT = function (i, v) {
            localData.counts[i].target = parseInt(v) || 0; saveToCloud();
            renderApp();
        };
        window.upD = function (i, v) {
            const val = parseInt(v) || 0;
            const item = localData.counts[i];
            if (val > item.target) {
                showModal("Uyarƒ±", `${item.name} namazƒ± i√ßin girilen sayƒ± hedeften b√ºy√ºk olamaz.`);
                document.getElementById('pdInputDone').value = item.done;
                return;
            }
            if (item.done !== val) {
                const o = item.done;
                item.done = val;
                addHistory(item.name, o, val);
                saveToCloud();
                renderApp();
            }
        };

        window.chC = function (i, d) {
            triggerHaptic();
            const item = localData.counts[i];
            const remaining = Math.max(0, item.target - item.done);

            if (d > 0 && remaining <= 0) {
                showModal("Bilgi", `${item.name} namazƒ± i√ßin kaza borcunuz
                            bulunmamaktadƒ±r.`); return;
            } const o = item.done; const n = o + d; if (n >= 0) {
                item.done = n;
                if (d > 0) {
                    localData.daily.counts[i]++;
                    const todayISO = getIsoDate(new Date());
                    localData.logs[todayISO] = (localData.logs[todayISO] || 0) + 1;
                    const ct = localData.daily.counts.reduce((a, b) => a + b, 0);
                    if (ct >= localData.daily.target) {
                        localData.calendar[todayISO] = true;
                        if (ct === localData.daily.target) jsConfetti.addConfetti();
                    } else {
                        delete localData.calendar[todayISO];
                    }

                    const wTotal = getWeeklyProgress();
                    const wTarget = localData.weeklyTarget || 50;
                    if (wTotal === wTarget) {
                        jsConfetti.addConfetti({
                            emojis: ['üåô', '‚≠ê'],
                            emojiSize: 35,
                            confettiNumber: 60
                        });
                        showToast("Haftalƒ±k Hedef Tamamlandƒ±! üèÜ", "success");
                    }

                    let totalDebt = 0;
                    localData.counts.forEach(c => totalDebt += Math.max(0, c.target - c.done));
                    if (totalDebt <= 0) {
                        showModal("Tebrikler!", "Kaza namaz borcunuz bulunmamaktadƒ±r. Allah kabul etsin!");
                    }
                    recalculateStreak();
                } else if (localData.daily.counts[i] > 0) {
                    localData.daily.counts[i]--;
                    const todayISO = getIsoDate(new Date());
                    if (localData.logs && localData.logs[todayISO] > 0) localData.logs[todayISO]--;
                    const ct = localData.daily.counts.reduce((a, b) => a + b, 0);
                    if (ct < localData.daily.target) { delete localData.calendar[todayISO]; }
                    recalculateStreak();
                } addHistory(localData.counts[i].name, o, n); saveToCloud();
                renderApp();
            }
        }; function recalculateStreak() {
            let currentStreak = 0; const
                today = new Date(); const isoToday = getIsoDate(today); if (localData.calendar &&
                    localData.calendar[isoToday]) { currentStreak++; } for (let i = 1; i < 1000; i++) {
                        const d = new Date(); d.setDate(today.getDate() - i); const iso = getIsoDate(d); if
                            (localData.calendar && localData.calendar[iso]) { currentStreak++; } else {
                            if
                                (i === 1 && currentStreak === 0) { } else { break; }
                        }
                    }
            localData.streak.current = currentStreak;
        } window.updateDailyGoal = function (v) {
            let
                totalDebt = 0; localData.counts.forEach(c => totalDebt += Math.max(0, c.target -
                    c.done));

            if (totalDebt <= 0) {
                showModal("Bilgi", "Kaza namaz borcunuz bulunmamaktadƒ±r.");
                document.getElementById('dailyGoalInput').value = localData.daily.target; return;
            } localData.daily.target = parseInt(v) || 10; saveToCloud(); renderApp();
        };
        window.updateWeeklyGoal = function (v) {
            let totalDebt = 0;
            localData.counts.forEach(c => totalDebt += Math.max(0, c.target - c.done));

            if (totalDebt <= 0) {
                showModal("Bilgi", "Kaza namaz borcunuz bulunmamaktadƒ±r."
                ); document.getElementById('weeklyGoalInput').value = localData.weeklyTarget;
                return;
            } localData.weeklyTarget = parseInt(v) || 50; saveToCloud();
            renderApp();
        }; function getWeeklyProgress() {
            if (!localData.logs) return
            0; const today = new Date(); const day = today.getDay(); const
                diff = today.getDate() - day + (day == 0 ? -6 : 1); const monday = new
                    Date(today.setDate(diff)); monday.setHours(0, 0, 0, 0); let weeklyTotal = 0;
            Object.keys(localData.logs).forEach(dateKey => {
                const logDate = new
                    Date(dateKey); if (logDate >= monday) {
                        weeklyTotal +=
                            localData.logs[dateKey];
                    }
            }); return weeklyTotal;
        }

        function renderTesbihat() {
            const c = document.getElementById('tesbihatContainer');

            if (!localData.tesbihat || localData.tesbihat.length === 0) {
                localData.tesbihat = JSON.parse(JSON.stringify(defaultData.tesbihat));
            }

            if (!isTesbihatDetailView) {
                c.innerHTML = "";

                let listHTML = '<div class="tesbihat-list-container">';

                localData.tesbihat.forEach((item, i) => {
                    const themeClass = item.colorTheme || 'theme-blue';
                    const deleteBtn = i > 3 ? `<div class="t-card-delete"
                                                    onclick="event.stopPropagation(); deleteTesbihat(${i})"><i
                                                        class="fas fa-trash-alt"></i></div>` : '';

                    listHTML += `
                                                <div class="t-list-card ${themeClass}"
                                                    onclick="openTesbihatDetail(${i})">
                                                    <div class="t-card-info">
                                                        <div class="t-card-name">${item.name}</div>
                                                        <div class="t-card-count">Saya√ß: ${item.current} /
                                                            ${item.target}</div>
                                                    </div>
                                                    <i class="fas fa-chevron-right t-card-icon"></i>
                                                    ${deleteBtn}
                                                </div>
                                                `;
                });

                listHTML += `
                                                <div class="t-add-card" onclick="openAddZikrModal()">
                                                    <i class="fas fa-plus me-2"></i> YENƒ∞ Zƒ∞Kƒ∞R EKLE
                                                </div>
                                            </div>`;

                c.innerHTML = listHTML;
            } else {
                if (activeTesbihatIndex >= localData.tesbihat.length) activeTesbihatIndex =
                    0;
                const currentZikr = localData.tesbihat[activeTesbihatIndex];
                const p = currentZikr.target > 0 ? (currentZikr.current /
                    currentZikr.target) * 100 : 0;
                const themeClass = currentZikr.colorTheme || 'theme-blue';

                const existingCard = document.querySelector('.tesbihat-detail-card');
                if (existingCard) {
                    document.querySelector('.zikr-count').innerText = currentZikr.current;

                    const progBar = document.querySelector('.tesbihat-detail-card
                        .progress - bar');
                                            if (progBar) progBar.style.width = `${p}%`;

                    existingCard.className = `tesbihat-detail-card ${themeClass}`;

                    const targetInput = document.querySelector('.tesbihat-inputs-row
                                            input[type = "number"]');
                                            if (targetInput && document.activeElement !== targetInput) {
                        targetInput.value = currentZikr.target;
                    }
                    return;
                }

                const colors = [
                    { class: 'theme-blue', name: 'Mavi' },
                    { class: 'theme-green', name: 'Ye≈üil' },
                    { class: 'theme-red', name: 'Kƒ±rmƒ±zƒ±' },
                    { class: 'theme-black', name: 'Siyah' },
                    { class: 'theme-orange', name: 'Turuncu' },
                    { class: 'theme-purple', name: 'Mor' },
                    { class: 'theme-teal', name: 'Teal' },
                    { class: 'theme-gold', name: 'Gold' }
                ];

                let paletteItems = '';
                colors.forEach(col => {
                    paletteItems += `<div class="cp-swatch ${col.class}"
                                                onclick="changeTesbihatColor(${activeTesbihatIndex}, '${col.class}')">
                                            </div>`;
                });

                c.innerHTML = "";

                let detailHTML = `
                                            <div class="tesbihat-detail-wrapper">
                                                <div class="tesbihat-header-controls" style="position:relative;">
                                                    <div class="control-btn" onclick="togglePalette()"><i
                                                            class="fas fa-palette"></i></div>
                                                    <div id="paletteMenu" class="color-palette-container">
                                                        ${paletteItems}
                                                    </div>

                                                    <div class="control-btn" onclick="closeTesbihatDetail()"><i
                                                            class="fas fa-arrow-left"></i></div>
                                                </div>

                                                <div class="tesbihat-detail-card ${themeClass}">
                                                    <div class="arabic-text">${currentZikr.arabic || ''}</div>
                                                    <h5 class="fw-bold zikr-name"
                                                        style="opacity:0.9; margin-bottom:5px;">${currentZikr.name}</h5>

                                                    <div class="zikr-count">${currentZikr.current}</div>

                                                    <div class="progress mb-4 w-100"
                                                        style="height: 10px; border-radius:10px; background:rgba(255,255,255,0.3);">
                                                        <div class="progress-bar bg-white" style="width: ${p}%"></div>
                                                    </div>

                                                    <div class="zikr-btn-group">
                                                        <button class="zikr-btn z-minus"
                                                            onclick="window.upTes(${activeTesbihatIndex},-1)"><i
                                                                class="fas fa-minus"></i></button>
                                                        <button class="zikr-btn z-plus"
                                                            onclick="window.upTes(${activeTesbihatIndex},1)"><i
                                                                class="fas fa-plus"></i></button>
                                                        <button class="zikr-btn z-reset"
                                                            onclick="window.resTes(${activeTesbihatIndex})"><i
                                                                class="fas fa-undo"></i></button>
                                                    </div>

                                                    <div class="tesbihat-inputs-row">
                                                        <div class="tesbihat-box-style">
                                                            <span class="t-label-small">HEDEF</span>
                                                            <input type="number" class="t-input"
                                                                value="${currentZikr.target}"
                                                                onchange="window.setTesTarget(${activeTesbihatIndex}, this.value)">
                                                        </div>
                                                        <div class="tesbihat-box-style">
                                                            <input type="number" id="manZ-${activeTesbihatIndex}"
                                                                class="t-input" placeholder="+Adet">
                                                            <button class="btn-add-large"
                                                                onclick="window.addTes(${activeTesbihatIndex})">EKLE</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            `;
                c.innerHTML = detailHTML;
            }
        }

        window.openTesbihatDetail = function (index) {
            activeTesbihatIndex = index;
            isTesbihatDetailView = true;
            triggerHaptic();
            renderTesbihat();
        }

        window.closeTesbihatDetail = function () {
            isTesbihatDetailView = false;
            triggerHaptic();
            renderTesbihat();
        }

        window.togglePalette = function () {
            const p = document.getElementById('paletteMenu');
            if (p.style.display === 'flex') {
                p.style.display = 'none';
            } else {
                p.style.display = 'flex';
            }
        }

        window.changeTesbihatColor = function (index, colorClass) {
            localData.tesbihat[index].colorTheme = colorClass;
            saveToCloud();
            document.getElementById('paletteMenu').style.display = 'none';
            renderTesbihat();
        }

        window.openAddZikrModal = function () {
            document.getElementById('newZikrNameInput').value = "";
            document.getElementById('addZikrModal').style.display = 'flex';
        }

        window.confirmAddZikr = function () {
            const name = document.getElementById('newZikrNameInput').value;
            if (name && name.trim() !== "") {
                localData.tesbihat.push({
                    name: name.trim(),
                    arabic: "",
                    current: 0,
                    target: 33,
                    colorTheme: 'theme-blue'
                });
                saveToCloud();
                document.getElementById('addZikrModal').style.display = 'none';
                renderTesbihat();
                showToast("Yeni zikir eklendi!", "success");
            } else {
                showToast("L√ºtfen bir isim giriniz.", "warning");
            }
        }

        window.deleteTesbihat = function (index) {
            if (confirm(`${localData.tesbihat[index].name} silinsin mi?`)) {
                localData.tesbihat.splice(index, 1);
                saveToCloud();
                renderTesbihat();
                showToast("Silindi.", "warning");
            }
        }

        function formatTime(d) {
            if (!isFinite(d) || d <= 0) return "Tamamlandƒ±";
            const y = Math.floor(d / 365); const r = d % 365; const m = Math.floor(r / 30);
            const fd = Math.floor(r % 30); let res = ""; if (y > 0) res += `${y} Yƒ±l `; if
                (m > 0) res += `${m} Ay `; if (y === 0 && m === 0) res += `${fd} G√ºn`; else
                if (fd > 0 && y < 10) res += `${fd} G.`; return res || "Bug√ºn";
        }
        function calculateEstFinish(done, days) {
            if (!days || days < 1) days = 1; let avg = localData.daily.counts.reduce((a, b) => a + b, 0);
            if (days >= 7) {
                let logsArr = Object.values(localData.logs || {});
                let totalLogged = logsArr.reduce((a, b) => a + b, 0);
                avg = totalLogged / days;
            }

            let totalTarget = 0;
            localData.counts.forEach(c => totalTarget += c.target);

            const rem = totalTarget - done;

            document.getElementById('statAverage').innerText = avg.toFixed(1);

            if (rem <= 0) {
                document.getElementById('prediction-container').style.display = 'none';
                document.getElementById('prediction-success').style.display = 'block'; return;
            } else {
                document.getElementById('prediction-container').style.display = 'block';
                document.getElementById('prediction-success').style.display = 'none';
            } const
                dateEl = document.getElementById('estFinishDate'); const daysEl = document.getElementById('estDaysLeft'); const
                    dailyTarget = localData.daily.target; if (dailyTarget > 0) {
                        const dLeft = Math.ceil(rem / dailyTarget);
                        const estDate = new Date(); estDate.setDate(estDate.getDate() + dLeft);
                        dateEl.innerText = formatDateTR(getIsoDate(estDate));
                        daysEl.innerText = `${formatTime(dLeft)} Kaldƒ±`;
                    } else {
                dateEl.innerText = "-";
                daysEl.innerText = "Hedef Girilmedi";
            }

            const dateElAvg = document.getElementById('estFinishDateAvg');
            const daysElAvg = document.getElementById('estDaysLeftAvg');

            if (avg > 0) {
                const dLeftAvg = Math.ceil(rem / avg);
                const estDateAvg = new Date(); estDateAvg.setDate(estDateAvg.getDate() + dLeftAvg);
                dateElAvg.innerText = formatDateTR(getIsoDate(estDateAvg));
                daysElAvg.innerText = `${formatTime(dLeftAvg)} Kaldƒ±`;
            } else {
                dateElAvg.innerText = "-";
                daysElAvg.innerText = "Veri Yok";
            }
        }

        function getElapsedDays() {
            const start = new Date(localData.startDate);
            const now = new Date();
            const diffTime = Math.abs(now - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        window.upTes = function (i, val) {
            localData.tesbihat[i].current += val;
            if (localData.tesbihat[i].current < 0) localData.tesbihat[i].current = 0; saveToCloud(); renderTesbihat();
        }
        window.resTes = function (i) {
            if (confirm("Saya√ß sƒ±fƒ±rlansƒ±n mƒ±?")) {
                localData.tesbihat[i].current = 0;
                saveToCloud(); renderTesbihat();
            }
        } window.setTesTarget = function (i, val) {
            localData.tesbihat[i].target = parseInt(val) || 33; saveToCloud(); renderTesbihat();
        }
        window.addTes = function (i) {
            const v = parseInt(document.getElementById(`manZ-${i}`).value); if (v && v !== 0) {
                window.upTes(i, v); document.getElementById(`manZ-${i}`).value = "";
            }
        } /* Fasting Functions */ function
            renderFasting() {
            const c = document.getElementById('fastingContainer'); const f = localData.fasting;
            if (!f.kaza) f.kaza = { done: 0, target: 0, hasTarget: false }; const kazaP = f.kaza.target > 0 ? Math.min(100,
                (f.kaza.done / f.kaza.target) * 100) : 0;
            const nafileDone = f.nafile.done;

            let remainingBadge = '';
            if (f.kaza.target > 0) {
                const rem = Math.max(0, f.kaza.target - f.kaza.done);
                remainingBadge = `<div class="pd-remaining-badge mt-2" style="background:${rem === 0 ? '#198754' : '#dc3545'}">
                ${rem === 0 ? 'Tamamlandƒ±' : rem + ' G√ºn Kaldƒ±'}</div>`;
            }

            const kazaActive = activeFastingIndex === 0 ? 'active' : '';
            const nafileActive = activeFastingIndex === 1 ? 'active' : '';

            const html = `
            <div class="prayer-split-layout" style="height:auto; min-height:400px;">
                <div class="prayer-side-menu">
                    <div class="side-menu-item theme-oruc-kaza ${kazaActive}"
                        onclick="activeFastingIndex=0; renderFasting();">
                        <i class="fas fa-utensils side-menu-icon" style="font-size:1.2rem;"></i>
                        <div class="side-menu-label">KAZA ORUCU</div>
                    </div>
                    <div class="side-menu-item theme-oruc-nafile ${nafileActive}"
                        onclick="activeFastingIndex=1; renderFasting();">
                        <i class="fas fa-leaf side-menu-icon" style="font-size:1.2rem;"></i>
                        <div class="side-menu-label">NAFƒ∞LE</div>
                    </div>
                </div>

                <div class="prayer-detail-card ${activeFastingIndex === 0 ? 'bg-oruc-kaza' : 'bg-oruc-nafile'}">
                    <div class="pd-content">
                        ${activeFastingIndex === 0 ? `
                        <div class="text-center mb-3">
                            <h3 class="fw-bold"><i class="fas fa-utensils me-2"></i> KAZA ORUCU</h3>
                            ${remainingBadge}
                        </div>

                        <div class="pd-stats-row">
                            <div class="pd-input-group bg-white-10 border-white-10">
                                <span class="pd-label text-white">HEDEF</span>
                                <input type="number" class="pd-input text-white" value="${f.kaza.target}"
                                    onchange="changeFasting('kaza', 'target', this.value)">
                            </div>
                            <div class="pd-input-group bg-white-10 border-white-10">
                                <span class="pd-label text-warning">TUTULAN</span>
                                <input type="number" class="pd-input text-warning" value="${f.kaza.done}"
                                    onchange="changeFasting('kaza', 'done', this.value)">
                            </div>
                        </div>

                        <div class="pd-progress-container">
                            <div class="pd-progress-track bg-white-10">
                                <div class="pd-progress-fill bg-warning" style="width: ${kazaP}%"></div>
                            </div>
                            <div class="pd-progress-text text-white-50">%${kazaP.toFixed(1)} Tamamlandƒ±</div>
                        </div>

                        <div class="pd-actions">
                            <button class="pd-btn bg-white-10" onclick="changeFasting('kaza', 'add', -1)"><i
                                    class="fas fa-minus"></i></button>
                            <button class="pd-btn bg-success border-white-10"
                                onclick="changeFasting('kaza', 'add', 1)"><i class="fas fa-plus"></i></button>
                        </div>
                        ` : `
                        <div class="text-center mb-3">
                            <h3 class="fw-bold"><i class="fas fa-leaf me-2"></i> NAFƒ∞LE ORU√á</h3>
                            <div class="mt-2 text-white-50">G√∂n√ºll√º ƒ∞badet</div>
                        </div>

                        <div class="text-center my-4">
                            <div class="display-1 fw-bold text-white">${nafileDone}</div>
                            <div class="text-white-50 text-uppercase fw-bold ls-1">G√ºn Tutuldu</div>
                        </div>

                        <div class="pd-actions">
                            <button class="pd-btn bg-white-10" onclick="changeFasting('nafile', 'add', -1)"><i
                                    class="fas fa-minus"></i></button>
                            <button class="pd-btn bg-success border-white-10"
                                onclick="changeFasting('nafile', 'add', 1)"><i class="fas fa-plus"></i></button>
                        </div>
                        `}
                    </div>
                </div>
            </div>
            `;
            c.innerHTML = html;
        }

        window.changeFasting = function (type, field, val) {
            const iVal = parseInt(val) || 0;
            if (field === 'target') {
                localData.fasting[type].target = iVal;
                localData.fasting[type].hasTarget = (iVal > 0);
            } else if (field === 'done') {
                const old = localData.fasting[type].done;
                localData.fasting[type].done = iVal;
                if (localData.fasting[type].done !== old) addHistory(type === 'kaza' ? 'Kaza Orucu' : 'Nafile Oru√ß', old,
                    iVal, 'oruc');
            } else if (field === 'add') {
                triggerHaptic();
                const old = localData.fasting[type].done;
                const n = old + iVal;
                if (n >= 0) {
                    localData.fasting[type].done = n;
                    addHistory(type === 'kaza' ? 'Kaza Orucu' : 'Nafile Oru√ß', old, n, 'oruc');
                    if (iVal > 0) jsConfetti.addConfetti({ emojis: ['‚ú®'], emojiSize: 20, confettiNumber: 30 });
                }
            }
            saveToCloud();
            renderFasting();
        }

        /* History & Filter */
        function addHistory(itemName, oldVal, newVal, category = 'namaz') {
            const diff = newVal - oldVal;
            if (diff === 0) return;

            const hItem = {
                id: Date.now(),
                date: new Date().toISOString(),
                item: itemName,
                change: diff,
                old: oldVal,
                new: newVal,
                category: category // 'namaz' or 'oruc'
            };

            if (!localData.history) localData.history = [];
            localData.history.unshift(hItem);
            if (localData.history.length > 50) localData.history.pop();

            if (document.getElementById('stats-view-history').style.display !== 'none') {
                renderHistoryList();
            }
        }

        function switchStatsTab(tab) {
            document.querySelectorAll('.stats-tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tabBtn-' + tab).classList.add('active');

            if (tab === 'analysis') {
                document.getElementById('stats-view-analysis').style.display = 'block';
                document.getElementById('stats-view-history').style.display = 'none';
            } else {
                document.getElementById('stats-view-analysis').style.display = 'none';
                document.getElementById('stats-view-history').style.display = 'block';
                renderHistoryList();
            }
        }

        function resetHistoryFilters() {
            currentHistoryCategory = 'all';
            currentNamazSubCat = 'all';
            currentFastingSubCat = 'all';

            document.querySelectorAll('.h-tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.h-tab-btn')[0].classList.add('active'); // T√ºm√º

            document.getElementById('namazSubTabs').style.display = 'none';
            document.getElementById('fastingSubTabs').style.display = 'none';
        }

        function setHistoryCategory(cat, btn) {
            currentHistoryCategory = cat;
            document.querySelectorAll('.h-tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            document.getElementById('namazSubTabs').style.display = 'none';
            document.getElementById('fastingSubTabs').style.display = 'none';

            if (cat === 'namaz') {
                document.getElementById('namazSubTabs').style.display = 'flex';
            } else if (cat === 'oruc') {
                document.getElementById('fastingSubTabs').style.display = 'flex';
            }
            renderHistoryList();
        }

        function setNamazSubCategory(sub, btn) {
            currentNamazSubCat = sub;
            document.querySelectorAll('#namazSubTabs .h-sub-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderHistoryList();
        }

        function setFastingSubCategory(sub, btn) {
            currentFastingSubCat = sub;
            document.querySelectorAll('#fastingSubTabs .h-sub-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderHistoryList();
        }

        function filterHistoryByDate() { renderHistoryList(); }
        function clearHistoryFilter() {
            document.getElementById('historyFilterDate').value = "";
            renderHistoryList();
        }

        function renderHistoryList() {
            const list = document.getElementById('historyListContainer');
            list.innerHTML = "";

            if (!localData.history || localData.history.length === 0) {
                list.innerHTML = `<div class="text-center text-muted mt-5"><i
                    class="fas fa-history fa-3x mb-3 opacity-25"></i>
                <p>Hen√ºz i≈ülem ge√ßmi≈üi yok.</p>
            </div>`;
                return;
            }

            const dateFilter = document.getElementById('historyFilterDate').value; // gg.aa.yyyy or yyyy-mm-dd
            let filterDateObj = null;
            if (dateFilter) {
                if (dateFilter.includes('.')) {
                    const p = dateFilter.split('.'); filterDateObj = new Date(`${p[2]}-${p[1]}-${p[0]}`);
                } else {
                    filterDateObj = new Date(dateFilter);
                }
            }

            localData.history.forEach(h => {
                // Main Category Filter
                if (currentHistoryCategory === 'namaz' && h.category !== 'namaz') return;
                if (currentHistoryCategory === 'oruc' && h.category !== 'oruc') return;

                // Sub Category Filters
                if (currentHistoryCategory === 'namaz' && currentNamazSubCat !== 'all') {
                    if (h.item !== currentNamazSubCat) return;
                }
                if (currentHistoryCategory === 'oruc' && currentFastingSubCat !== 'all') {
                    if (currentFastingSubCat === 'kaza' && h.item !== 'Kaza Orucu') return;
                    if (currentFastingSubCat === 'nafile' && h.item !== 'Nafile Oru√ß') return;
                }

                // Date Filter
                if (filterDateObj) {
                    const hDate = new Date(h.date);
                    if (hDate.getDate() !== filterDateObj.getDate() ||
                        hDate.getMonth() !== filterDateObj.getMonth() ||
                        hDate.getFullYear() !== filterDateObj.getFullYear()) {
                        return;
                    }
                }

                const dt = new Date(h.date);
                const timeStr = dt.getHours().toString().padStart(2, '0') + ":" + dt.getMinutes().toString().padStart(2, '0');
                const dateStr = formatDateTR(getIsoDate(dt));

                const isPos = h.change > 0;
                const colorClass = isPos ? 'text-success' : 'text-danger';
                const icon = isPos ? 'fa-arrow-up' : 'fa-arrow-down';

                list.innerHTML += `
            <div class="user-info-box bg-white border mb-2 justify-content-between px-3 py-2 shadow-sm"
                style="color:var(--text-color);">
                <div style="text-align:left;">
                    <div class="fw-bold">${h.item} <span class="badge bg-light text-secondary ms-2"
                            style="font-weight:normal; font-size:0.65rem;">${dateStr} ${timeStr}</span></div>
                    <div class="small text-muted">√ñnceki: ${h.old} ‚ûî Yeni: ${h.new}</div>
                </div>
                <div class="${colorClass} fw-bold fs-5">
                    ${isPos ? '+' : ''}${h.change} <i class="fas ${icon} small"></i>
                </div>
            </div>
            `;
            });

            if (list.innerHTML === "") {
                list.innerHTML = `<div class="text-center text-muted mt-5">
                <p>Filtrelere uygun kayƒ±t bulunamadƒ±.</p>
            </div>`;
            }
        }


        /* Stats & Charts */
        function renderStats() {
            let totalTarget = 0, totalDone = 0;
            let labels = [], remainingData = [], doneData = [];
            let maxRemaining = -1, maxName = "", maxDone = -1, bestName = "";
            const days = getElapsedDays();

            const gridContainer = document.getElementById('prayer-analysis-grid');
            gridContainer.innerHTML = "";

            localData.counts.forEach((c, index) => {
                totalTarget += c.target;
                totalDone += c.done;
                const remaining = Math.max(0, c.target - c.done);
                if (remaining > maxRemaining) { maxRemaining = remaining; maxName = c.name; }

                const performanceRate = c.target > 0 ? (c.done / days) : 0;
                if (performanceRate > maxDone) { maxDone = performanceRate; bestName = c.name; }

                labels.push(c.name);
                remainingData.push(remaining);
                doneData.push(c.done);

                // Accordion Item
                let pct = c.target > 0 ? ((c.done / c.target) * 100).toFixed(1) : 0;
                let iconClass = ["fa-cloud-sun", "fa-sun", "fa-cloud-sun", "fa-moon", "fa-star"][index];

                let itemHTML = `
            <div class="stat-accordion-item" id="statAccordion${index}" onclick="this.classList.toggle('open')">
                <div class="stat-accordion-header">
                    <div class="stat-header-content">
                        <div class="stat-icon-wrapper"><i class="fas ${iconClass}"></i></div>
                        <div>
                            <div class="stat-title">${c.name}</div>
                            <div class="text-secondary small" style="font-size:0.75rem;">Hedef: ${c.target} ‚Ä¢ Kalan: <b
                                    class="text-danger">${remaining}</b></div>
                        </div>
                    </div>
                    <i class="fas fa-chevron-down stat-arrow"></i>
                </div>
                <div class="stat-accordion-body">
                    <div class="progress" style="height:6px; border-radius:10px; margin: 10px 0;">
                        <div class="progress-bar bg-success" style="width: ${pct}%"></div>
                    </div>
                    <div class="text-end small text-success fw-bold mb-2">%${pct} Tamamlandƒ±</div>
                    <div class="stat-detail-grid">
                        <div class="stat-detail-item">
                            <span class="stat-detail-label text-success">KILINAN</span>
                            <span class="stat-detail-value text-done">${c.done}</span>
                        </div>
                        <div class="stat-detail-item">
                            <span class="stat-detail-label text-danger">KALAN</span>
                            <span class="stat-detail-value text-rem">${remaining}</span>
                        </div>
                    </div>
                </div>
            </div>`;
                gridContainer.innerHTML += itemHTML;
            });

            document.getElementById('bestPrayer').innerText = bestName + " (G√ºnde " + maxDone.toFixed(2) + ")";
            document.getElementById('worstPrayer').innerText = maxName + " (" + maxRemaining + " Bor√ß)";

            const logs = localData.logs || {};
            const dates = Object.keys(logs);
            const last7 = dates.sort().slice(-7);
            const dailyData = last7.map(d => logs[d]);
            const dailyLabels = last7.map(d => formatDateTR(d).substring(0, 5));

            // Calculate Time-Based Stats
            let todayLog = logs[getIsoDate(new Date())] || 0;
            document.getElementById('statToday').innerText = todayLog;
            document.getElementById('statWeekly').innerText = getWeeklyProgress();

            let mTotal = 0, yTotal = 0, m3Total = 0, m6Total = 0;
            const now = new Date();
            const oneMonthAgo = new Date(); oneMonthAgo.setMonth(now.getMonth() - 1);
            const threeMonthsAgo = new Date(); threeMonthsAgo.setMonth(now.getMonth() - 3);
            const sixMonthsAgo = new Date(); sixMonthsAgo.setMonth(now.getMonth() - 6);
            const oneYearAgo = new Date(); oneYearAgo.setFullYear(now.getFullYear() - 1);

            // Best Day/Week/Month Logic
            let dayScores = {}, weekScores = {}, monthScores = {};
            let longestStreak = 0, tempStreak = 0;
            let prevDate = null;

            const sortedDates = dates.sort();

            sortedDates.forEach(d => {
                const val = logs[d];
                const dateObj = new Date(d);

                // Streak
                if (prevDate) {
                    const diffTime = dateObj - prevDate;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays === 1 && val >= (localData.daily.target || 10)) {
                        tempStreak++;
                    } else if (val < (localData.daily.target || 10)) { tempStreak = 0; }
                } else {
                    if (val >= (localData.daily.target
                        || 10)) tempStreak = 1;
                }
                if (tempStreak > longestStreak) longestStreak = tempStreak;
                prevDate = dateObj;

                // Period Totals
                if (dateObj >= oneMonthAgo) mTotal += val;
                if (dateObj >= threeMonthsAgo) m3Total += val;
                if (dateObj >= sixMonthsAgo) m6Total += val;
                if (dateObj >= oneYearAgo) yTotal += val;

                // Best Calculations
                // Day
                if (!dayScores[d] || dayScores[d] < val) dayScores[d] = val; // Week (ISO Week) const
                weekNum = getWeekNumber(dateObj); const weekKey = dateObj.getFullYear() + "-W" + weekNum;
                if (!weekScores[weekKey]) weekScores[weekKey] = 0; weekScores[weekKey] += val; // Month const
                monthKey = dateObj.getFullYear() + "-" + (dateObj.getMonth() + 1); if (!monthScores[monthKey])
                    monthScores[monthKey] = 0; monthScores[monthKey] += val;
            });
            document.getElementById('statMonthly').innerText = mTotal;
            document.getElementById('stat3Months').innerText = m3Total;
            document.getElementById('stat6Months').innerText = m6Total;
            document.getElementById('statYearly').innerText = yTotal; // Find Best const
            bestDay = Object.keys(dayScores).reduce((a, b) => dayScores[a] > dayScores[b] ? a : b, "-");
            document.getElementById('bestDayVal').innerText = bestDay !== "-" ? formatDateTR(bestDay) + " (" +
                dayScores[bestDay] + ")" : "-";

            const bestWeek = Object.keys(weekScores).reduce((a, b) => weekScores[a] > weekScores[b] ? a : b,
                "-");
            document.getElementById('bestWeekVal').innerText = bestWeek !== "-" ? bestWeek + " (" +
                weekScores[bestWeek] + ")" : "-";

            const bestMonth = Object.keys(monthScores).reduce((a, b) => monthScores[a] > monthScores[b] ? a : b,
                "-");
            document.getElementById('bestMonthVal').innerText = bestMonth !== "-" ? bestMonth + " (" +
                monthScores[bestMonth] + ")" : "-";

            document.getElementById('longestStreakVal').innerText = longestStreak > 0 ? longestStreak + " G√ºn" :
                "Yok";

            const ctx1 = document.getElementById('completionChart').getContext('2d');
            const ctx2 = document.getElementById('barChart').getContext('2d');
            const ctx3 = document.getElementById('lineChart').getContext('2d');

            if (chartCompletion) chartCompletion.destroy();
            if (barChart) barChart.destroy();
            if (lineChart) lineChart.destroy();

            const isDark = document.body.classList.contains('dark-mode');
            const lc = isDark ? '#e0e0e0' : '#444';

            const gradSabah = ctx2.createLinearGradient(0, 0, 0, 350); gradSabah.addColorStop(0, '#4fc3f7');
            gradSabah.addColorStop(1, '#0288d1');
            const gradOgle = ctx2.createLinearGradient(0, 0, 0, 350); gradOgle.addColorStop(0, '#fff176');
            gradOgle.addColorStop(1, '#fdd835');
            const gradIkindi = ctx2.createLinearGradient(0, 0, 0, 350); gradIkindi.addColorStop(0, '#ffcc80');
            gradIkindi.addColorStop(1, '#fb8c00');
            const gradAksam = ctx2.createLinearGradient(0, 0, 0, 350); gradAksam.addColorStop(0, '#7986cb');
            gradAksam.addColorStop(1, '#3949ab');
            const gradYatsi = ctx2.createLinearGradient(0, 0, 0, 350); gradYatsi.addColorStop(0, '#90a4ae');
            gradYatsi.addColorStop(1, '#546e7a');

            const gradDone = ctx1.createLinearGradient(0, 0, 0, 250); gradDone.addColorStop(0, '#66bb6a');
            gradDone.addColorStop(1, '#2e7d32');
            const gradRem = ctx1.createLinearGradient(0, 0, 0, 250); gradRem.addColorStop(0, '#ef5350');
            gradRem.addColorStop(1, '#c62828');

            // NEW LOGIC FOR COMPLETION CHART LEGEND
            let pDone = totalTarget > 0 ? ((totalDone / totalTarget) * 100).toFixed(1) : "0.0";
            let pRem = totalTarget > 0 ? (((totalTarget - totalDone) / totalTarget) * 100).toFixed(1) : "0.0";

            // Inject custom legend HTML
            document.getElementById('completionLegend').innerHTML = `
                    <div class="legend-item">
                        <div class="legend-dot" style="background: linear-gradient(135deg, #609979, #88cbb9);"></div>
                        <span class="legend-text">Kƒ±lƒ±nan</span>
                        <span class="legend-percent">%${pDone}</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: linear-gradient(135deg, #fb8c00, #ffb74d);"></div>
                        <span class="legend-text">Kalan</span>
                        <span class="legend-percent">${pRem === "0.0" && totalTarget > 0 ? "%100" : "%" + pRem}</span>
                    </div>
                    `;

            chartCompletion = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Kƒ±lƒ±nan', 'Kalan'],
                    datasets: [{
                        data: [totalDone, totalTarget - totalDone],
                        backgroundColor: [gradDone, gradRem],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { display: false },
                        datalabels: { display: false },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                label: function (context) {
                                    let label = context.label || '';
                                    if (label) { label += ': '; }
                                    let value = context.parsed;
                                    let total = context.chart._metasets[context.datasetIndex].total;
                                    let percentage = ((value * 100) / total).toFixed(1) + "%";
                                    return label + value + " (" + percentage + ")";
                                }
                            }
                        }
                    }
                },
                plugins: []
            });

            barChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Kƒ±lƒ±nacak', data: remainingData, backgroundColor: [gradSabah, gradOgle, gradIkindi,
                                gradAksam, gradYatsi], borderRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }, datalabels: {
                            color: isDark ? '#fff' : '#000', anchor: 'end',
                            align: 'top', formatter: (v) => v > 0 ? v : ""
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: isDark ? '#333' : '#eee' }, ticks: { color: lc } },
                        x: { grid: { display: false }, ticks: { color: lc } }
                    }
                }
            });

            updatePerformanceChart(currentChartPeriod);
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }

        function updatePerformanceChart(period) {
            const ctx3 = document.getElementById('lineChart').getContext('2d');
            if (lineChart) lineChart.destroy();

            const logs = localData.logs || {};
            const dates = Object.keys(logs).sort();
            const now = new Date();
            let filteredDates = [];
            let labels = [];
            let data = [];

            if (period === 'weekly') {
                const oneWeekAgo = new Date(); oneWeekAgo.setDate(now.getDate() - 7);
                filteredDates = dates.filter(d => new Date(d) >= oneWeekAgo);
            } else if (period === 'monthly') {
                const oneMonthAgo = new Date(); oneMonthAgo.setMonth(now.getMonth() - 1);
                filteredDates = dates.filter(d => new Date(d) >= oneMonthAgo);
            } else if (period === '3months') {
                const threeMonthsAgo = new Date(); threeMonthsAgo.setMonth(now.getMonth() - 3);
                filteredDates = dates.filter(d => new Date(d) >= threeMonthsAgo);
            }

            filteredDates.forEach(d => {
                labels.push(formatDateTR(d).substring(0, 5));
                data.push(logs[d]);
            });

            const isDark = document.body.classList.contains('dark-mode');
            const lc = isDark ? '#e0e0e0' : '#444';

            const gradLine = ctx3.createLinearGradient(0, 0, 0, 250);
            gradLine.addColorStop(0, 'rgba(96, 153, 121, 0.5)');
            gradLine.addColorStop(1, 'rgba(96, 153, 121, 0.0)');

            lineChart = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'G√ºnl√ºk Kƒ±lƒ±nan',
                        data: data,
                        borderColor: '#609979',
                        backgroundColor: gradLine,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#609979',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, datalabels: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: isDark ? '#333' : '#eee' }, ticks: { color: lc } },
                        x: { grid: { display: false }, ticks: { color: lc, maxTicksLimit: 7 } }
                    }
                }
            });
        }

        function switchChartPeriod(period, btn) {
            currentChartPeriod = period;
            document.querySelectorAll('.chart-period-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updatePerformanceChart(period);
        }

        function renderAchievements() {
            const badgeListNamaz = document.getElementById('badgeListNamaz');
            const badgeListStreak = document.getElementById('badgeListStreak');

            badgeListNamaz.innerHTML = '';
            badgeListStreak.innerHTML = '';

            const BADGES = [
                {
                    id: 'namaz_start', icon: 'fa-praying-hands', title: 'Bismillah', desc: 'ƒ∞lk namazƒ±nƒ± kaydettin',
                    condition: (d) => totalPrayers(d) >= 1, type: 'namaz'
                },
                {
                    id: 'namaz_100', icon: 'fa-mosque', title: 'Gayretli', desc: '100 kaza namazƒ± kƒ±ldƒ±n', condition:
                        (d) => totalPrayers(d) >= 100, type: 'namaz'
                },
                {
                    id: 'namaz_500', icon: 'fa-star', title: 'Sebat', desc: '500 kaza namazƒ± kƒ±ldƒ±n', condition: (d)
                        => totalPrayers(d) >= 500, type: 'namaz'
                },
                {
                    id: 'namaz_1000', icon: 'fa-sun', title: 'Nur', desc: '1000 kaza namazƒ± kƒ±ldƒ±n', condition: (d) =>
                        totalPrayers(d) >= 1000, type: 'namaz'
                },
                {
                    id: 'namaz_5000', icon: 'fa-trophy', title: '√ústad', desc: '5000 kaza namazƒ± kƒ±ldƒ±n', condition:
                        (d) => totalPrayers(d) >= 5000, type: 'namaz'
                },

                {
                    id: 'streak_3', icon: 'fa-fire', title: 'Alev', desc: '3 g√ºn √ºst √ºste hedefi tutturdun',
                    condition: (d) => d.streak.current >= 3, type: 'streak'
                },
                {
                    id: 'streak_7', icon: 'fa-burn', title: 'Kor', desc: '1 hafta aralƒ±ksƒ±z devam ettin', condition:
                        (d) => d.streak.current >= 7, type: 'streak'
                },
                {
                    id: 'streak_30', icon: 'fa-certificate', title: 'Demir ƒ∞rade', desc: '1 aydƒ±r aralƒ±ksƒ±z devam
                    ediyorsun', condition: (d) => d.streak.current >= 30, type: 'streak' },
                    {
                        id: 'streak_100', icon: 'fa-crown', title: 'Zincir Kƒ±ran', desc: '100 g√ºn √ºst √ºste bƒ±rakmadƒ±n',
                        condition: (d) => d.streak.current >= 100, type: 'streak'
                    }
                    ];

            let score = 0;
            let earnedCount = 0;

            BADGES.forEach(b => {
                const isEarned = b.condition(localData);
                if (isEarned) {
                    if (!localData.earnedBadges.includes(b.id)) {
                        localData.earnedBadges.push(b.id);
                        jsConfetti.addConfetti();
                        showToast(`Yeni Rozet: ${b.title}`, 'success');
                        saveToCloud();
                    }
                    score += 100;
                    earnedCount++;
                }

                const card = document.createElement('div');
                card.className = `badge-card ${isEarned ? 'earned' : 'locked'}`;
                card.innerHTML = `
                    <div class="badge-icon-wrapper">
                        <i class="fas ${b.icon}"></i>
                    </div>
                    <div class="badge-info">
                        <div class="badge-title">${b.title}</div>
                        <div class="badge-desc">${b.desc}</div>
                    </div>
                    ${!isEarned ? '<div class="lock-overlay"><i class="fas fa-lock"></i></div>' : ''}
                    `;

                if (b.type === 'namaz') badgeListNamaz.appendChild(card);
                else badgeListStreak.appendChild(card);
            });

            document.getElementById('totalScoreDisplay').innerText = score;

            let level = "Ba≈ülangƒ±√ß";
            if (score > 500) level = "Gayretli";
            if (score > 1000) level = "Adanmƒ±≈ü";
            if (score > 2000) level = "Sarsƒ±lmaz";
            if (score > 5000) level = "√ústad";

            document.getElementById('userLevelDisplay').innerText = level;
        }

        function totalPrayers(d) { return d.counts.reduce((a, b) => a + b.done, 0); }

        window.confirmResetData = function () {
            showModal('Dikkat', 'T√ºm verileriniz silinecek (Hesaplamalar hari√ß). Onaylƒ±yor musunuz?', [
                {
                    text: 'ƒ∞ptal', class: 'btn-cancel', onClick: () =>
                        document.getElementById('customModal').style.display = 'none'
                },
                {
                    text: 'Sƒ±fƒ±rla', class: 'btn-confirm bg-danger', onClick: () => {
                        const bkupGender = localData.gender;
                        const bkupMens = localData.menstrualDaysPerMonth;
                        const bkupIsMens = localData.isMenstrualState;
                        const bkupStartDate = localData.startDate;

                        localData = JSON.parse(JSON.stringify(defaultData));

                        // Keep settings
                        localData.gender = bkupGender;
                        localData.menstrualDaysPerMonth = bkupMens;
                        localData.isMenstrualState = bkupIsMens;
                        localData.startDate = bkupStartDate;

                        saveToCloud();
                        document.getElementById('customModal').style.display = 'none';
                        renderApp();
                        showToast('Veriler sƒ±fƒ±rlandƒ±.', 'warning');
                    }
                }
            ]);
        }

        window.showModal = function (title, msg, buttons = []) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalMessage').innerHTML = msg;
            const btnContainer = document.getElementById('modalButtons');
            btnContainer.innerHTML = '';

            if (buttons.length === 0) {
                btnContainer.innerHTML = '<button class="modal-btn btn-confirm bg-success border-0"
                onclick = "document.getElementById(\'customModal\').style.display=\'none\'" > Tamam</button > ';
            } else {
                buttons.forEach(b => {
                    const btn = document.createElement('button');
                    btn.className = `modal-btn ${b.class}`;
                    btn.innerText = b.text;
                    btn.onclick = b.onClick;
                    btnContainer.appendChild(btn);
                });
            }
            document.getElementById('customModal').style.display = 'flex';
        }

        window.toggleDarkMode = function () {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('darkModeText').innerText = isDark ? "G√ºnd√ºz Modu" : "Gece Modu";
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            renderStats();
        }

        function checkDailyReset() {
            const today = new Date().toLocaleDateString('tr-TR');
            if (localData.daily.date !== today) {
                localData.daily.date = today;
                localData.daily.counts = [0, 0, 0, 0, 0];
                localData.streak.todayIncremented = false;
                saveToCloud();
            }
        }

        // Theme Init
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('darkModeText').innerText = "G√ºnd√ºz Modu";
        }

        // PWA Install
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btnContainer = document.getElementById('installAppContainer');
            if (btnContainer) btnContainer.style.display = 'block';
        });

        window.installPWA = async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                document.getElementById('installAppContainer').style.display = 'none';
            }
            deferredPrompt = null;
        }

        /* Service Worker */
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(reg => console.log('SW Registered')).catch(err =>
                console.log('SW Error:', err));
        }

        window.addEventListener('online', () => { showToast('ƒ∞nternet baƒülantƒ±sƒ± saƒülandƒ±.', 'success'); });
        window.addEventListener('offline', () => {
            showToast('ƒ∞nternet yok. √áevrimdƒ±≈üƒ± moddasƒ±nƒ±z.',
                'warning');
        });

        window.downloadBackupJSON = function () {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(localData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "ibadet_takip_yedek_" + new
                Date().toISOString().split('T')[0] + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        window.importBackupJSON = function (input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (json.counts && json.daily) { // Simple validation
                        localData = json;
                        saveToCloud();
                        location.reload();
                    } else {
                        showToast("Ge√ßersiz yedek dosyasƒ±!", "error");
                    }
                } catch (ex) {
                    showToast("Dosya okuma hatasƒ±!", "error");
                }
            };
            reader.readAsText(file);
        }

        window.downloadDataAsCSV = function () {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Namaz,Kƒ±lƒ±nan,Kalan,G√ºnl√ºk Hedef\n";
            localData.counts.forEach(row => {
                csvContent += `${row.name},${row.done},${Math.max(0, row.target -
                    row.done)},${localData.daily.target}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "ibadet_ozet_rapor.csv");
            document.body.appendChild(link);
            link.click();
        }
        window.copyStartDate = function () {
            const s = document.querySelector('#row-0 input').value; if (s) {
                document.querySelectorAll('.calc-row').forEach((r, i) => {
                    if (i > 0) {
                        const inps =
                            r.querySelectorAll('input'); inps[0].value = s; window.calcRow(i);
                    }
                }); showToast("Tarih
                    diƒüerlerine kopyalandƒ±.", "success"); } }
                    window.copyEndDate = function () {
                        const s = document.querySelector('#row-0
                    input: nth - child(2)').value; if(s) { document.querySelectorAll('.calc - row').forEach((r, i) => {
                    if (i > 0) { const inps = r.querySelectorAll('input'); inps[1].value = s; window.calcRow(i); }
                    });
                showToast("Tarih diƒüerlerine kopyalandƒ±.", "success");
            }
        }
        window.resetCalculatorInputs = function () {
            document.querySelectorAll('.date-input').forEach(i =>
                i.value = ""); document.querySelectorAll('.calc-result-input').forEach(i => i.value = 0);
        }
        window.applyAdvancedCalculation = function () {
            let total = 0;
            for (let i = 0; i < 5; i++) {
                const v = parseInt(document.getElementById(`res-${i}`).value) || 0;
                localData.counts[i].target = v; total += v;
            } saveToCloud(); renderApp(); showModal("Ba≈üarƒ±lƒ±",
                `Hesaplanan toplam ${total} kaza namazƒ±, hedeflerinize ba≈üarƒ±yla aktarƒ±ldƒ±.`);
            showSection('dashboard');
        } </script>
</body>

</html>
