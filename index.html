<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kaza Namazƒ± Takip</title>
    
    <meta name="theme-color" content="#198754">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" id="my-manifest">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>

    <style>
        /* TEMA DEƒûƒ∞≈ûKENLERƒ∞ */
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: #ffffff;
            --sidebar-bg: #157347;
            --table-head: #157347;
            --table-row-bg: #e6e6e6;
            --input-bg: #ffffff;
            --input-text: #000000;
            --border-color: #dee2e6;
        }

        /* GECE MODU */
        body.dark-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --card-bg: #1e1e1e;
            --sidebar-bg: #0f5132;
            --table-head: #0f5132;
            --table-row-bg: #2d2d2d;
            --input-bg: #2d2d2d;
            --input-text: #ffffff;
            --border-color: #444;
        }

        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-x: hidden; transition: background-color 0.3s, color 0.3s; }
        
        .wrapper { display: flex; width: 100%; align-items: stretch; }
        #sidebar { min-width: 250px; max-width: 250px; background: var(--sidebar-bg); color: #fff; min-height: 100vh; transition: all 0.3s; }
        #sidebar.active { margin-left: -250px; }
        #sidebar .sidebar-header { padding: 20px; background: rgba(0,0,0,0.2); }
        #sidebar ul.components { padding: 20px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        #sidebar ul li { padding: 10px; font-size: 1.1em; display: block; cursor: pointer; }
        #sidebar ul li:hover { background: rgba(255,255,255,0.1); }
        #sidebar ul li.active { background: #fff; color: var(--sidebar-bg); border-radius: 5px 0 0 5px; margin-left: 10px; font-weight: bold; }
        
        #content { width: 100%; padding: 20px; min-height: 100vh; transition: all 0.3s; }
        @media (max-width: 768px) {
            #sidebar { margin-left: -250px; position: fixed; z-index: 999; height: 100%; }
            #sidebar.active { margin-left: 0; }
        }

        .app-header { text-align: center; color: var(--sidebar-bg); font-weight: bold; margin-bottom: 20px; }
        body.dark-mode .app-header { color: #20c997; }

        /* TABLO */
        .main-table { color: var(--text-color); }
        .main-table thead th { background-color: var(--table-head); color: white; vertical-align: middle; text-align: center; font-size: 0.9rem; white-space: nowrap; border-color: var(--border-color); }
        .main-table tbody td { vertical-align: middle; text-align: center; background-color: var(--table-row-bg); color: var(--text-color); font-weight: bold; white-space: nowrap; border-color: var(--border-color); }
        .main-table input { text-align: center; font-weight: bold; min-width: 60px; background-color: var(--input-bg); color: var(--input-text); border: 1px solid var(--border-color); }
        .main-table tfoot td { background-color: #d9534f; color: white; font-weight: bold; text-align: center; border-color: #c9302c; }
        
        .btn-action { width: 30px; height: 30px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; margin: 0 2px; }
        .btn-plus { background-color: #20c997; border: none; color: white; }
        .btn-minus { background-color: #6c757d; border: none; color: white; }
        .col-namaz { background-color: #f4a261 !important; color: black; } 
        .hidden { display: none !important; }
        @media (max-width: 768px) { .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; } }

        /* KARTLAR */
        .login-card, .calculator-card, .chart-container, .badge-item { background-color: var(--card-bg); color: var(--text-color); border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        #login-screen { height: 100vh; display: flex; justify-content: center; align-items: center; background-color: var(--bg-color); }
        .chart-container { padding: 20px; margin-bottom: 20px; text-align: center; }

        .goal-card {
            background: linear-gradient(135deg, #198754, #20c997);
            color: white; border-radius: 15px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(32, 201, 151, 0.4);
            position: relative; overflow: hidden; transition: all 0.3s ease;
        }
        .goal-card.success-mode { background: linear-gradient(135deg, #1aa179, #157347); border: 3px solid #ffc107; box-shadow: 0 0 20px rgba(255, 193, 7, 0.6); }
        .goal-input { width: 80px; text-align: center; font-weight: bold; border: none; border-radius: 5px; color: #198754; background: white; }

        /* STREAK (Zƒ∞NCƒ∞R) ALANI */
        .streak-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px; border-radius: 10px; margin-top: 15px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .streak-count { font-size: 1.5rem; font-weight: bold; color: #ffc107; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }

        .badge-container { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-top: 20px; margin-bottom: 40px; }
        .badge-item { text-align: center; width: 110px; padding: 10px; animation: popIn 0.5s ease; }
        .badge-title { font-size: 0.85rem; font-weight: bold; color: #198754; }
        body.dark-mode .badge-title { color: #20c997; }

        .history-row-up, .history-row-up > td { background-color: #d1e7dd !important; color: #0f5132 !important; }
        .history-row-down, .history-row-down > td { background-color: #f8d7da !important; color: #842029 !important; }
        body.dark-mode .history-row-up, body.dark-mode .history-row-up > td { background-color: #0f5132 !important; color: #fff !important; }
        body.dark-mode .history-row-down, body.dark-mode .history-row-down > td { background-color: #842029 !important; color: #fff !important; }

        .calc-row { background: var(--table-row-bg); padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .calc-label { font-weight: bold; color: var(--sidebar-bg); font-size: 1.1rem; margin-bottom: 5px; display: block;}
        body.dark-mode .calc-label { color: #20c997; }
        .form-control { background-color: var(--input-bg); color: var(--input-text); border-color: var(--border-color); }
        .form-control:focus { background-color: var(--input-bg); color: var(--input-text); }

        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(1); } }
        .success-msg { animation: bounceIn 0.5s; font-size: 1.3rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <h3 class="text-success fw-bold mb-4">Kaza Namazƒ± Takip</h3>
        <p class="text-secondary mb-4">Verilerinize eri≈ümek i√ßin g√ºvenli giri≈ü yapƒ±n.</p>
        <button class="btn btn-outline-dark w-100 py-2 fw-bold" onclick="loginWithGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" class="me-2">
            Google ile Giri≈ü Yap
        </button>
    </div>
</div>

<div id="app-wrapper" class="wrapper hidden">
    <nav id="sidebar">
        <div class="sidebar-header">
            <h3>Kaza Takip</h3>
            <div id="sidebarUserInfo" class="small mt-2 text-white-50">...</div>
        </div>
        <ul class="list-unstyled components">
            <li id="menu-dashboard" class="active" onclick="showSection('dashboard')"><i class="fas fa-home me-2"></i> Ana Sayfa</li>
            <li id="menu-calculator" onclick="showSection('calculator')"><i class="fas fa-calculator me-2"></i> Hesap Sihirbazƒ±</li>
            <li onclick="toggleDarkMode()"><i class="fas fa-moon me-2"></i> <span id="darkModeText">Gece Modu</span></li>
            <li onclick="forceResetData()" class="text-warning"><i class="fas fa-wrench me-2"></i> Verileri Onar</li>
            <li onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> √áƒ±kƒ±≈ü Yap</li>
        </ul>
    </nav>

    <div id="content">
        <button type="button" id="sidebarCollapse" class="btn btn-success mb-3 d-md-none"><i class="fas fa-bars"></i> Men√º</button>

        <!-- B√ñL√úM 1: ANA SAYFA -->
        <div id="section-dashboard">
            <h2 class="app-header">Namaz Takip Paneli</h2>
            
            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6">
                    <div id="goalCard" class="goal-card text-center">
                        <h4>üéØ G√ºnl√ºk Hedef</h4>
                        
                        <div class="d-flex justify-content-center align-items-center gap-2 mt-3 mb-2">
                            <span style="font-size: 1.2rem;">Bug√ºn</span>
                            <strong style="font-size: 2rem;" id="dailyCountDisplay">0</strong>
                            <span style="font-size: 1.2rem;">/</span>
                            <input type="number" id="dailyGoalInput" class="goal-input" value="10" onchange="updateDailyGoal(this.value)">
                            <span style="font-size: 1.2rem;">Kaza</span>
                        </div>
                        
                        <div class="progress mt-2" style="height: 10px; background-color: rgba(255,255,255,0.3);">
                            <div id="dailyProgressBar" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                        </div>
                        
                        <div id="goalSuccessMessage" class="success-msg mt-2 fw-bold text-white" style="display: none;">
                            üéâ G√ºnl√ºk Hedefe Ula≈üƒ±ldƒ±!
                        </div>

                        <!-- Zƒ∞NCƒ∞R (STREAK) ALANI -->
                        <div class="streak-box">
                            <i class="fas fa-fire fa-lg text-warning"></i>
                            <span class="text-white">Zincir:</span>
                            <span id="streakValue" class="streak-count">0</span>
                            <span class="text-white">G√ºn</span>
                        </div>
                        
                        <small id="goalDefaultText" class="text-white-50 mt-2 d-block">
                            Zinciri kƒ±rmamak i√ßin her g√ºn hedefini tamamla!
                        </small>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-center gap-3 mb-3 flex-wrap">
                <div><label class="fw-bold text-secondary">Ba≈ülama:</label> <input type="date" id="startDate" class="form-control d-inline-block w-auto text-center fw-bold"></div>
                <div><label class="fw-bold text-secondary">G√ºn:</label> <input type="text" id="elapsedDays" class="form-control d-inline-block w-auto text-center fw-bold" readonly></div>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered main-table">
                    <thead>
                        <tr>
                            <th>Namaz</th>
                            <th style="width: 15%;">Kƒ±lƒ±nacak</th>
                            <th style="width: 20%;">Kƒ±lƒ±nan</th>
                            <th>ƒ∞≈ülem</th>
                            <th>Ort. Namaz</th>
                            <th>Kalan S√ºre</th>
                        </tr>
                    </thead>
                    <tbody id="prayerTableBody"></tbody>
                    <tfoot id="prayerTableFoot"></tfoot>
                </table>
            </div>

            <div class="row mt-4 justify-content-center">
                <div class="col-md-6 col-lg-5 mb-3">
                    <div class="chart-container">
                        <h5 class="text-center text-secondary mb-3">Genel Tamamlanma Durumu</h5>
                        <canvas id="completionChart" style="max-height: 280px;"></canvas>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4"><h4 class="text-secondary fw-bold">üèÜ Rozet M√ºzesi</h4></div>
            <div class="badge-container" id="badgeContainer"></div>

            <h4 class="text-center text-secondary fw-bold mt-4" style="font-size: 0.9rem;">Son Deƒüi≈üiklikler</h4>
            <div class="table-responsive">
                <table class="table table-bordered text-center" style="font-size: 0.8rem;">
                    <thead><tr class="table-light"><th>Namaz</th><th>√ñnceki</th><th>Son</th><th>Zaman</th></tr></thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- B√ñL√úM 2: HESAPLAMA Sƒ∞Hƒ∞RBAZI -->
        <div id="section-calculator" class="hidden">
            <h2 class="app-header">Detaylƒ± Hesap Sihirbazƒ±</h2>
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="calculator-card">
                        <div class="alert alert-info small">
                            <i class="fas fa-info-circle me-1"></i> Tarihleri giriniz. <strong>ƒ∞pucu:</strong> ƒ∞lk satƒ±rƒ± doldurup butonlarla kopyalayabilirsiniz.
                        </div>
                        <div class="d-flex justify-content-end gap-2 mb-3 flex-wrap">
                            <button class="btn btn-sm btn-outline-info" onclick="copyStartDate()"><i class="fas fa-arrow-down me-1"></i> Sorumluluk Tarihini Daƒüƒ±t</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="copyEndDate()"><i class="fas fa-arrow-down me-1"></i> D√ºzenli Ba≈ülamayƒ± Daƒüƒ±t</button>
                        </div>
                        <div id="calcRowsContainer"></div>
                        <hr class="my-4">
                        <div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> <strong>Dikkat:</strong> Onaylarsanƒ±z ana sayfadaki hedefler deƒüi≈üir.</div>
                        <button class="btn btn-danger w-100 py-2 fw-bold" onclick="applyAdvancedCalculation()"><i class="fas fa-check-circle me-2"></i> Onaylƒ±yorum ve Hesaplananlarƒ± Aktar</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    document.getElementById('sidebarCollapse').addEventListener('click', function () { document.getElementById('sidebar').classList.toggle('active'); });
    function showSection(sectionId) {
        document.querySelectorAll('#sidebar ul li').forEach(li => li.classList.remove('active'));
        document.getElementById('menu-' + sectionId).classList.add('active');
        document.getElementById('section-dashboard').classList.add('hidden');
        document.getElementById('section-calculator').classList.add('hidden');
        document.getElementById('section-' + sectionId).classList.remove('hidden');
        if(window.innerWidth < 768) { document.getElementById('sidebar').classList.remove('active'); }
        if(sectionId === 'calculator') { renderCalculatorRows(); }
    }

    // GECE MODU
    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        document.getElementById('darkModeText').innerText = isDark ? "G√ºnd√ºz Modu" : "Gece Modu";
        if(chartCompletion) { chartCompletion.options.plugins.legend.labels.color = isDark ? '#fff' : '#666'; chartCompletion.update(); }
    }
    window.addEventListener('load', () => { if(localStorage.getItem('theme') === 'dark') { document.body.classList.add('dark-mode'); document.getElementById('darkModeText').innerText = "G√ºnd√ºz Modu"; } });

    // HESAP Sƒ∞Hƒ∞RBAZI
    const prayerTypes = ["Sabah", "√ñƒüle", "ƒ∞kindi", "Ak≈üam", "Yatsƒ±"];
    function renderCalculatorRows() {
        const container = document.getElementById('calcRowsContainer'); if(container.innerHTML.trim() !== "") return;
        let html = "";
        prayerTypes.forEach((prayer, index) => {
            html += `<div class="calc-row" id="row-${index}"><span class="calc-label">${prayer}</span><div class="calc-input-group">
            <div><small class="text-muted">Sorumluluk Ba≈ülangƒ±cƒ±</small><input type="date" class="form-control start-date" onchange="calculateRow(${index})"></div>
            <div><small class="text-muted">D√ºzenli Ba≈ülama</small><input type="date" class="form-control end-date" onchange="calculateRow(${index})"></div>
            <div><small class="text-muted">Hesaplanan G√ºn</small><input type="number" class="form-control calc-result-input" id="res-${index}" value="0"></div></div></div>`;
        });
        container.innerHTML = html;
    }
    function calculateRow(index) {
        const row = document.getElementById(`row-${index}`); const s = row.querySelector('.start-date').value; const e = row.querySelector('.end-date').value; const r = document.getElementById(`res-${index}`);
        if(s && e) { const d1 = new Date(s); const d2 = new Date(e); if(d1 < d2) { r.value = Math.ceil(Math.abs(d2 - d1) / (1000 * 60 * 60 * 24)); } else { r.value = 0; } }
    }
    function copyStartDate() { const s0 = document.getElementById('row-0').querySelector('.start-date').value; if(!s0) return alert("Sabah tarihini girin"); for(let i=1; i<5; i++) { const r = document.getElementById(`row-${i}`); r.querySelector('.start-date').value = s0; calculateRow(i); } }
    function copyEndDate() { const e0 = document.getElementById('row-0').querySelector('.end-date').value; if(!e0) return alert("Sabah tarihini girin"); for(let i=1; i<5; i++) { const r = document.getElementById(`row-${i}`); r.querySelector('.end-date').value = e0; calculateRow(i); } }
    function applyAdvancedCalculation() {
        let vals = []; for(let i=0; i<5; i++) vals.push(parseInt(document.getElementById(`res-${i}`).value)||0);
        if(vals.every(v=>v===0)) return alert("Deƒüerler 0.");
        if(confirm("Hedefler deƒüi≈ütirilecek. Onaylƒ±yor musunuz?")) {
            ensureDataStructure(); vals.forEach((v,i)=> localData.counts[i].target = v); saveToCloud(); alert("G√ºncellendi!"); showSection('dashboard');
        }
    }

    // PWA & FIREBASE
    const pwaIcon = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23198754' d='M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256 256-114.6 256-256S401.4 0 256 0zm-46.8 389L68.6 248.4c-4.7-4.7-4.7-12.3 0-17l28.3-28.3c4.7-4.7 12.3-4.7 17 0L209.2 298l188.8-188.8c4.7-4.7 12.3-4.7 17 0l28.3 28.3c4.7 4.7 4.7 12.3 0 17L226.2 389c-4.7 4.7-12.3 4.7-17 0z'/%3E%3C/svg%3E";
    const manifestBlob = new Blob([JSON.stringify({ "name": "Kaza Namazƒ±", "short_name": "Namaz Takip", "start_url": ".", "display": "standalone", "background_color": "#f8f9fa", "theme_color": "#198754", "icons": [{ "src": pwaIcon, "sizes": "192x192", "type": "image/svg+xml" }] })], {type: 'application/json'});
    document.querySelector('#my-manifest').href = URL.createObjectURL(manifestBlob);
    if ('serviceWorker' in navigator) navigator.serviceWorker.register(URL.createObjectURL(new Blob([`self.addEventListener('install',e=>e.waitUntil(self.skipWaiting()));self.addEventListener('activate',e=>e.waitUntil(self.clients.claim()));self.addEventListener('fetch',e=>{})`], {type: 'application/javascript'})));

    Chart.register(ChartDataLabels);
    const jsConfetti = new JSConfetti();

    const firebaseConfig = {
        apiKey: "AIzaSyC7zdr3x8H--8piHR_1muAz2TVOOaebI54",
        authDomain: "kazanamazi-ser.firebaseapp.com",
        databaseURL: "https://kazanamazi-ser-default-rtdb.firebaseio.com",
        projectId: "kazanamazi-ser",
        storageBucket: "kazanamazi-ser.firebasestorage.app",
        messagingSenderId: "951730390034",
        appId: "1:951730390034:web:639f96ee859c10b0e944cb",
        measurementId: "G-5WGCDTL1RX"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();
    let dbRef = null;

    const BADGES = [
        { id: 1000, title: "Ba≈ülangƒ±√ß", icon: "üéóÔ∏è", desc: "1.000 Namaz" },
        { id: 5000, title: "ƒ∞stikrar", icon: "üéñÔ∏è", desc: "5.000 Namaz" },
        { id: 10000, title: "Yƒ±ldƒ±z", icon: "‚≠ê", desc: "10.000 Namaz" },
        { id: 25000, title: "≈ûampiyon", icon: "üèÜ", desc: "25.000 Namaz" },
        { id: 50000, title: "Efsane", icon: "üëë", desc: "50.000 Namaz" }
    ];

    function getCurrentDateSimple() { const d = new Date(); return d.toLocaleDateString('tr-TR'); }
    // Helper for yesterday date
    function getYesterdayDateSimple() {
        const d = new Date();
        d.setDate(d.getDate() - 1);
        return d.toLocaleDateString('tr-TR');
    }

    const defaultData = {
        startDate: "2022-11-22",
        daily: { date: getCurrentDateSimple(), counts: [0,0,0,0,0], target: 10 }, 
        // YENƒ∞ STREAK ALANI
        streak: { current: 0, lastAchievedDate: "" },
        counts: [{name:"Sabah",target:0,done:0},{name:"√ñƒüle",target:0,done:0},{name:"ƒ∞kindi",target:0,done:0},{name:"Ak≈üam",target:0,done:0},{name:"Yatsƒ±",target:0,done:0}],
        earnedBadges: [], history: [] 
    };
    let localData = JSON.parse(JSON.stringify(defaultData));
    let chartCompletion = null;

    function ensureDataStructure() {
        const pn = ["Sabah","√ñƒüle","ƒ∞kindi","Ak≈üam","Yatsƒ±"];
        if (!localData.counts || !Array.isArray(localData.counts) || localData.counts.length !== 5) localData.counts = pn.map(n=>({name:n,target:0,done:0}));
        else localData.counts.forEach((item,i)=>{ if(!item.name) item.name=pn[i]; if(typeof item.target==='undefined') item.target=0; if(typeof item.done==='undefined') item.done=0; });
        
        const t = getCurrentDateSimple();
        if (!localData.daily) localData.daily={date:t,counts:[0,0,0,0,0],target:10};
        else if(!localData.daily.counts) { localData.daily.counts=[0,0,0,0,0]; localData.daily.date=t; }
        
        // Streak yapƒ±sƒ±nƒ± kontrol et
        if (!localData.streak) localData.streak = { current: 0, lastAchievedDate: "" };

        if(!localData.history) localData.history=[];
        if(!localData.earnedBadges) localData.earnedBadges=[];
        if(!localData.startDate) { const now=new Date(); localData.startDate=now.toISOString().split('T')[0]; }
    }

    function forceResetData() { if(confirm("Veriler onarƒ±lacak. Emin misiniz?")) { ensureDataStructure(); saveToCloud(); renderApp(); alert("Onarƒ±ldƒ±."); } }

    auth.onAuthStateChanged((user) => {
        if (user) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-wrapper').classList.remove('hidden');
            document.getElementById('sidebarUserInfo').innerText = "Merhaba, " + user.displayName.split(' ')[0];
            dbRef = db.ref('users/' + user.uid + '/namazData');
            listenToData();
        } else { document.getElementById('login-screen').classList.remove('hidden'); document.getElementById('app-wrapper').classList.add('hidden'); dbRef = null; }
    });

    function loginWithGoogle() { auth.signInWithPopup(provider).catch((e)=>alert("Hata: "+e.message)); }
    function logout() { auth.signOut(); }
    function saveToCloud() { if(dbRef) dbRef.set(localData); }

    function listenToData() {
        dbRef.on('value', (s) => {
            const d = s.val();
            if(d) localData = d; 
            ensureDataStructure(); 
            checkDailyReset(); 
            if(!d) saveToCloud(); 
            renderApp();
        });
    }

    const startDateInput = document.getElementById("startDate");
    const elapsedDaysInput = document.getElementById("elapsedDays");
    const tableBody = document.getElementById("prayerTableBody");
    const tableFoot = document.getElementById("prayerTableFoot");
    const historyBody = document.getElementById("historyTableBody");
    const dailyCountDisplay = document.getElementById("dailyCountDisplay");
    const dailyGoalInput = document.getElementById("dailyGoalInput");
    const dailyProgressBar = document.getElementById("dailyProgressBar");
    const goalSuccessMessage = document.getElementById("goalSuccessMessage");
    const goalDefaultText = document.getElementById("goalDefaultText");
    const goalCard = document.getElementById("goalCard");
    const badgeContainer = document.getElementById("badgeContainer");
    const streakValue = document.getElementById("streakValue"); // Yeni

    function checkDailyReset() {
        const t = getCurrentDateSimple();
        if (localData.daily.date !== t) {
            localData.daily.date = t; localData.daily.counts = [0,0,0,0,0]; saveToCloud();
        }
        
        // Zincir Kontrol√º (Giri≈ü yapƒ±ldƒ±ƒüƒ±nda):
        // Eƒüer son ba≈üarƒ± tarihi d√ºnden eskiyse zincir kƒ±rƒ±lmƒ±≈ütƒ±r (0 olur).
        // Ama bug√ºn zaten ba≈üardƒ±ysa dokunma.
        const yesterday = getYesterdayDateSimple();
        if (localData.streak.lastAchievedDate !== t && localData.streak.lastAchievedDate !== yesterday && localData.streak.current > 0) {
             // Zincir kƒ±rƒ±ldƒ±
             localData.streak.current = 0;
             saveToCloud();
        }
    }
    window.updateDailyGoal = function(val) { if (!dbRef) return; localData.daily.target = parseInt(val) || 1; saveToCloud(); }

    function processDailyChange(index, delta) {
        if (delta > 0) {
            localData.daily.counts[index] = (localData.daily.counts[index] || 0) + 1;
            const currentTotal = localData.daily.counts.reduce((a, b) => a + b, 0);
            
            // HEDEF TAMAMLANDI MI?
            if (currentTotal >= localData.daily.target) {
                // Eƒüer hedef TAM ≈ûƒ∞MDƒ∞ tamamlandƒ±ysa (√∂nceden tamamlanmadƒ±ysa)
                // Veya daha √∂nce tamamlandƒ± ama streak bug√ºne i≈ülenmediyse
                const today = getCurrentDateSimple();
                const yesterday = getYesterdayDateSimple();

                // Sadece ilk kez hedefe ula≈üƒ±ldƒ±ƒüƒ±nda konfeti at
                if (currentTotal === localData.daily.target) {
                    jsConfetti.addConfetti({ emojis: ['üéâ', '‚ú®', '‚≠ê', 'üèÜ'], confettiNumber: 80 });
                }

                // STREAK MANTIƒûI
                if (localData.streak.lastAchievedDate !== today) {
                    if (localData.streak.lastAchievedDate === yesterday) {
                        localData.streak.current++; // Zincir devam ediyor
                    } else {
                        localData.streak.current = 1; // Zincir koptu, yeniden ba≈üladƒ±
                    }
                    localData.streak.lastAchievedDate = today;
                    
                    // √ñzel Konfeti (5, 10, 15, 30 g√ºn)
                    const s = localData.streak.current;
                    if([5,10,15,30,50,100].includes(s)) {
                        setTimeout(() => {
                            alert(`Harika! ${s} g√ºnd√ºr zinciri kƒ±rmadƒ±n! üî•`);
                            jsConfetti.addConfetti({ emojis: ['üî•', 'üî•', 'üòé'], confettiNumber: 100 });
                        }, 1000);
                    }
                }
            }
        } else {
            if (localData.daily.counts[index] > 0) localData.daily.counts[index]--;
        }
        checkBadges();
        saveToCloud();
    }
    
    function checkBadges() {
        let t = 0; localData.counts.forEach(c => t += parseInt(c.done));
        let earned = false;
        BADGES.forEach(b => {
            if (t >= b.id && !localData.earnedBadges.includes(b.id)) {
                localData.earnedBadges.push(b.id); earned = true;
                jsConfetti.addConfetti({ emojis: ['üèÜ', 'üëë', 'üíé', 'ü•á'], confettiNumber: 200 });
                alert(`TEBRƒ∞KLER! ${b.title} Rozetini Kazandƒ±n! üèÜ`);
            }
        });
        if (earned) saveToCloud();
    }

    function renderDailySection() {
        const c = localData.daily.counts ? localData.daily.counts.reduce((a, b) => a + b, 0) : 0;
        dailyCountDisplay.innerText = c; dailyGoalInput.value = localData.daily.target;
        let p = (c / localData.daily.target) * 100; if (p > 100) p = 100;
        dailyProgressBar.style.width = p + "%";
        if (c >= localData.daily.target) { 
            dailyProgressBar.classList.remove('bg-warning'); dailyProgressBar.classList.add('bg-success');
            goalSuccessMessage.style.display = "block"; goalDefaultText.style.display = "none"; goalCard.classList.add("success-mode");
        } else { 
            dailyProgressBar.classList.add('bg-warning'); dailyProgressBar.classList.remove('bg-success');
            goalSuccessMessage.style.display = "none"; goalDefaultText.style.display = "block"; goalCard.classList.remove("success-mode");
        }
        
        // Streak Render
        streakValue.innerText = localData.streak ? localData.streak.current : 0;
    }

    function renderBadges() {
        badgeContainer.innerHTML = ""; let t = 0; localData.counts.forEach(c => t += parseInt(c.done));
        let any = false;
        BADGES.forEach(b => {
            if (t >= b.id) {
                any = true; const d = document.createElement("div"); d.className = "badge-item";
                d.innerHTML = `<span class="badge-icon">${b.icon}</span><div class="badge-title">${b.title}</div>`;
                badgeContainer.appendChild(d);
            }
        });
        if (!any) badgeContainer.innerHTML = `<div class="text-muted small">Hen√ºz kazanƒ±lmƒ±≈ü rozet yok.</div>`;
    }

    function getElapsedDays() { if (!localData.startDate) return 1; const s = new Date(localData.startDate); const n = new Date(); s.setHours(0,0,0,0); n.setHours(0,0,0,0); return Math.ceil(Math.abs(n - s) / (1000 * 60 * 60 * 24)) || 1; }
    function formatTimeEstimator(d) { if (!isFinite(d) || d < 0) return "Tamamlandƒ±"; const y = Math.floor(d / 365); const r = d % 365; const m = Math.floor(r / 30); const fd = Math.floor(r % 30); let res = ""; if (y > 0) res += `${y} Yƒ±l `; if (m > 0) res += `${m} Ay `; if (y === 0 && m === 0) res += `${fd} G√ºn`; else if (fd > 0 && y < 10) res += `${fd} G.`; return res || "Bug√ºn"; }
    function getCurrentTime() { return new Date().toLocaleString('tr-TR'); }

    function addHistory(n, o, nv) {
        const r = { namaz: n, oldVal: parseInt(o), newVal: parseInt(nv), time: getCurrentTime() };
        if (!localData.history) localData.history = []; localData.history.unshift(r); if (localData.history.length > 20) localData.history.pop(); saveToCloud();
    }

    function renderApp() {
        if(!localData || !localData.counts) return;
        startDateInput.value = localData.startDate; renderDailySection(); renderBadges();
        const el = getElapsedDays(); elapsedDaysInput.value = el; tableBody.innerHTML = "";
        let tt = 0; let td = 0; let tr = 0;
        localData.counts.forEach((item, index) => {
            const rem = item.target - item.done; const avg = (item.done / el).toFixed(2); const est = avg > 0 ? Math.ceil(rem / avg) : 0; const estText = avg > 0 ? formatTimeEstimator(est) : "-";
            tt += parseInt(item.target); td += parseInt(item.done); tr += rem;
            let p = item.target > 0 ? (item.done / item.target) * 100 : 0;
            const row = document.createElement("tr");
            row.innerHTML = `<td class="col-namaz" style="background-color: #e0c09f;">${item.name}</td>
            <td><input type="number" class="form-control form-control-sm" value="${item.target}" onchange="updateTarget(${index}, this.value)"></td>
            <td><input type="number" class="form-control form-control-sm mb-1" value="${item.done}" onchange="updateDoneManual(${index}, this.value)">
            <div class="progress" style="height: 6px; background-color: #d1e7dd;"><div class="progress-bar bg-success" role="progressbar" style="width: ${p}%"></div></div><div class="text-success small fw-bold mt-1" style="font-size: 11px;">%${p.toFixed(1)}</div></td>
            <td><button class="btn-action btn-plus" onclick="changeCount(${index}, 1)">+</button><button class="btn-action btn-minus" onclick="changeCount(${index}, -1)">-</button></td>
            <td>${avg}</td><td class="small">${estText}</td>`;
            tableBody.appendChild(row);
        });
        const oa = (td / el).toFixed(2); const oed = oa > 0 ? Math.ceil(tr / oa) : 0; const oet = oa > 0 ? formatTimeEstimator(oed) : "-";
        tableFoot.innerHTML = `<tr><td>Toplam</td><td>${tt}</td><td>${td}</td><td style="background-color: #f8f9fa; border: none;"></td><td>${oa}</td><td class="small">${oet}</td></tr>`;
        renderHistory(); renderCharts(td, tr);
    }

    function renderHistory() { historyBody.innerHTML = ""; if (!localData.history) return; localData.history.forEach(r => { const row = document.createElement("tr"); const o = parseFloat(r.oldVal); const n = parseFloat(r.newVal); if (n > o) row.classList.add('history-row-up'); else if (n < o) row.classList.add('history-row-down'); row.innerHTML = `<td>${r.namaz}</td><td>${r.oldVal}</td><td>${r.newVal}</td><td>${r.time.split(' ')[1]}</td>`; historyBody.appendChild(row); }); }

    function renderCharts(d, r) {
        const ctx1 = document.getElementById('completionChart').getContext('2d'); if (chartCompletion) chartCompletion.destroy();
        const isDark = document.body.classList.contains('dark-mode'); const lc = isDark ? '#fff' : '#666';
        chartCompletion = new Chart(ctx1, { type: 'doughnut', data: { labels: ['Kƒ±lƒ±nan', 'Kalan'], datasets: [{ data: [d, r], backgroundColor: ['#198754', '#d9534f'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: lc } }, datalabels: { color: '#fff', font: { weight: 'bold', size: 14 }, formatter: (v, c) => { let s = 0; c.chart.data.datasets[0].data.map(d => s += d); return (v*100 / s).toFixed(1)+"%"; } } } } });
    }

    window.updateTarget = function(i, v) { if (!dbRef) return; localData.counts[i].target = parseInt(v) || 0; saveToCloud(); }
    window.updateDoneManual = function(i, v) { if (!dbRef) return; const o = localData.counts[i].done; const n = parseInt(v) || 0; if (o !== n) { localData.counts[i].done = n; addHistory(localData.counts[i].name, o, n); checkBadges(); } }
    window.changeCount = function(i, d) { if (!dbRef) return; const o = localData.counts[i].done; const n = o + d; if (n >= 0) { localData.counts[i].done = n; addHistory(localData.counts[i].name, o, n); processDailyChange(i, d); } }
    startDateInput.addEventListener("change", (e) => { if (!dbRef) return; localData.startDate = e.target.value; saveToCloud(); });

</script>
</body>
</html>
