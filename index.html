<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Ä°badet Takip Pro</title>
    
    <meta name="theme-color" content="#198754">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" id="my-manifest">

    <!-- KÃ¼tÃ¼phaneler -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Amiri:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>

    <style>
        /* --- ORÄ°JÄ°NAL TASARIM DEÄžÄ°ÅžKENLERÄ° --- */
        :root { 
            --bg-color: #e3e6ec; --text-color: #212529; --card-bg: #ffffff; --sidebar-bg: #157347; 
            --table-head: #157347; --table-row-bg: #ffffff; --input-bg: #f8f9fa; --input-text: #000000; 
            --border-color: #ced4da; --modal-bg: #ffffff;
            --col-namaz-bg: #5a826e; --col-namaz-text: #ffffff;
            --table-foot-bg: #1f3b2f; --table-foot-border: #142921;
            --box-target-bg: #e8f5e9; --box-target-border: #c3e6cb; --box-target-text: #155724;
            --box-add-bg: #e7f1ff; --box-add-border: #b6d4fe;
        }
        body.dark-mode { 
            --bg-color: #121212; --text-color: #e0e0e0; --card-bg: #1e1e1e; --sidebar-bg: #0f5132; 
            --table-head: #0f5132; --table-row-bg: #2d2d2d; --input-bg: #3a3a3a; --input-text: #ffffff; 
            --border-color: #444; --modal-bg: #2d2d2d;
            --col-namaz-bg: #1e3b2e; --col-namaz-text: #e0e0e0;
            --table-foot-bg: #0b1a15; --table-foot-border: #050d0a;
            --box-target-bg: #0f2e1c; --box-target-border: #146c43; --box-target-text: #75b798;
            --box-add-bg: #052c65; --box-add-border: #084298;
        }
        
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Poppins', sans-serif; transition: 0.3s; overflow-x: hidden; min-height: 100vh; padding-bottom: 80px; }

        /* YÃ¼kleme EkranÄ± */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(25, 135, 84, 0.2); border-top-color: #198754; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Sidebar & Nav */
        .wrapper { display: flex; width: 100%; }
        #sidebar { min-width: 260px; max-width: 260px; background: var(--sidebar-bg); color: #fff; height: 100vh; transition: 0.3s; z-index: 2000; position: fixed; top: 0; left: 0; overflow-y: auto; margin-left: -260px; }
        #sidebar.active { margin-left: 0; }
        #overlay { display: none; position: fixed; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 1999; top: 0; left: 0; }
        #overlay.active { display: block; }
        @media (min-width: 769px) { #sidebar { position: sticky; margin-left: 0; } #sidebar.active { margin-left: -260px; } #overlay { display: none !important; } #content { width: calc(100% - 260px); } }
        @media (max-width: 768px) { #content { width: 100%; } }
        #sidebar ul li { padding: 15px; cursor: pointer; border-left: 5px solid transparent; }
        #sidebar ul li.active { background: rgba(255,255,255,0.2); border-left-color: #fff; font-weight: 600; }
        #content { padding: 20px; width: 100%; max-width: 900px; margin: 0 auto; }

        /* Kartlar ve Tablo */
        .card-std { background: var(--card-bg); border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.06); padding: 20px; border: 1px solid var(--border-color); margin-bottom: 20px; }
        .goal-card { background: linear-gradient(135deg, #198754, #20c997); color: white; padding: 20px; border-radius: 16px; text-align: center; margin-bottom: 20px; }
        .table-responsive { border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; background: var(--card-bg); }
        .main-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .main-table th { background: var(--table-head); color: white; padding: 12px; text-align: center; border: 1px solid var(--border-color); }
        .main-table td { background: var(--table-row-bg); color: var(--text-color); padding: 10px; text-align: center; border: 1px solid var(--border-color); vertical-align: middle; }
        .table-input { width: 100%; height: 38px; text-align: center; background: var(--input-bg); color: var(--input-text); border: 1px solid var(--border-color); border-radius: 8px; font-weight: bold; }
        .col-namaz { background: var(--col-namaz-bg) !important; color: var(--col-namaz-text) !important; font-weight: 600; }
        
        /* Butonlar */
        .btn-action { width: 35px; height: 35px; border-radius: 8px; border: none; color: white; font-weight: bold; margin: 0 2px; }
        .btn-plus { background: #198754; } .btn-minus { background: #6c757d; }

        /* Namaz Vakti Widget (Ã–zel) */
        .prayer-widget-card { background: linear-gradient(145deg, #252438, #1e1d2b); color: white; border-radius: 20px; padding: 20px; margin-bottom: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative; overflow: hidden; }
        .pw-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .pw-location { font-size: 1.1rem; font-weight: 700; text-transform: uppercase; display: flex; align-items: center; gap: 8px; }
        .pw-date { font-size: 0.8rem; opacity: 0.7; margin-top: 4px; }
        .pw-timer-area { background: rgba(255,255,255,0.05); border-radius: 15px; padding: 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .pw-next-name { font-size: 1.8rem; font-weight: 700; text-transform: uppercase; line-height: 1; }
        .pw-countdown { font-size: 2.2rem; font-weight: 400; font-family: monospace; }
        .pw-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .pw-box { background: rgba(255,255,255,0.08); border-radius: 12px; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border: 1px solid rgba(255,255,255,0.05); transition: 0.3s; }
        .pw-box.active { background: #e67e22; color: white; border-color: #e67e22; box-shadow: 0 5px 15px rgba(230, 126, 34, 0.4); }
        .pw-box-label { font-size: 0.7rem; opacity: 0.7; font-weight: 600; text-transform: uppercase; }
        .pw-box-time { font-size: 1.2rem; font-weight: 600; }
        
        /* Modal & Bottom Nav */
        .custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .custom-modal { background: var(--modal-bg); padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; }
        .bottom-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: var(--card-bg); border-top: 1px solid var(--border-color); z-index: 2050; justify-content: space-around; align-items: center; }
        .nav-item { flex: 1; text-align: center; opacity: 0.6; cursor: pointer; color: var(--text-color); font-size: 0.75rem; }
        .nav-item.active { opacity: 1; color: #198754; font-weight: 600; }
        .nav-item i { font-size: 1.4rem; margin-bottom: 4px; display: block; }
        @media (max-width: 768px) { .bottom-nav { display: flex; } }

        /* Login */
        #login-screen { display: flex; height: 100vh; justify-content: center; align-items: center; background: var(--bg-color); position: fixed; width: 100%; z-index: 3000; top:0; left:0; }
    </style>
</head>
<body>

<!-- Åžehir SeÃ§im ModalÄ± (Dropdown) -->
<div id="cityModal" class="custom-modal-overlay">
    <div class="custom-modal">
        <h4 style="color: var(--text-color)">Åžehir SeÃ§imi</h4>
        <p style="color: var(--text-color)">Listenizden ÅŸehrinizi seÃ§iniz:</p>
        <select id="citySelect" class="form-select mb-3 text-center" style="font-weight: bold;">
            <option value="">-- YÃ¼kleniyor --</option>
        </select>
        <div class="d-flex gap-2 justify-content-center">
            <button class="btn btn-secondary" onclick="document.getElementById('cityModal').style.display='none'">Ä°ptal</button>
            <button class="btn btn-success" onclick="saveCity()">Kaydet</button>
        </div>
    </div>
</div>

<div id="loading-overlay"><div class="spinner"></div><h5 class="mt-3 text-success">YÃ¼kleniyor...</h5></div>

<div id="login-screen">
    <div class="card-std text-center p-5">
        <h3 class="text-success fw-bold mb-4">Ä°badet Takip</h3>
        <button class="btn btn-dark w-100 py-3 rounded-pill" onclick="loginWithGoogle()"><i class="fab fa-google me-2"></i> Google ile GiriÅŸ</button>
    </div>
</div>

<div id="app-wrapper" class="wrapper" style="display:none;">
    <!-- Sidebar -->
    <nav id="sidebar">
        <div class="p-4 text-center" style="background: rgba(0,0,0,0.1);"><h4 class="fw-bold">Ä°badet Takip</h4><small id="sidebarUserInfo" class="text-white-50">...</small></div>
        <ul class="list-unstyled components p-2">
            <li id="menu-dashboard" class="active" onclick="showSection('dashboard')"><i class="fas fa-mosque me-3"></i> Kaza NamazÄ±</li>
            <li id="menu-prayer" onclick="showSection('prayer')"><i class="fas fa-clock me-3"></i> Namaz Vakitleri</li>
            <li id="menu-stats" onclick="showSection('stats')"><i class="fas fa-chart-pie me-3"></i> Ä°statistikler</li>
            <li id="menu-tesbihat" onclick="showSection('tesbihat')"><i class="fas fa-fingerprint me-3"></i> Tesbihat</li>
            <li id="menu-settings" onclick="showSection('settings')"><i class="fas fa-cog me-3"></i> Ayarlar</li>
            <li onclick="toggleDarkMode()"><i class="fas fa-moon me-3"></i> Mod DeÄŸiÅŸtir</li>
            <li onclick="auth.signOut()"><i class="fas fa-sign-out-alt me-3"></i> Ã‡Ä±kÄ±ÅŸ</li>
        </ul>
    </nav>

    <div id="content">
        <!-- BÃ–LÃœM 1: KAZA NAMAZI -->
        <div id="section-dashboard">
            <div class="goal-card">
                <h4>ðŸŽ¯ GÃ¼nlÃ¼k Hedef</h4>
                <div class="d-flex justify-content-center align-items-center gap-2 mt-3">
                    <span class="fs-5">BugÃ¼n:</span>
                    <strong class="fs-1" id="dailyCountDisplay">0</strong>
                    <span class="fs-5">/</span>
                    <input type="number" id="dailyGoalInput" class="form-control text-center" style="width:70px; font-weight:bold;" value="10" onchange="updateDailyGoal(this.value)">
                </div>
                <div class="progress mt-2" style="height: 8px;"><div id="dailyProgressBar" class="progress-bar bg-warning" style="width: 0%"></div></div>
            </div>

            <div class="table-responsive">
                <table class="table main-table">
                    <thead><tr><th>Namaz</th><th>KÄ±lÄ±nacak</th><th>KÄ±lÄ±nan</th><th>Ä°ÅŸlem</th></tr></thead>
                    <tbody id="prayerTableBody"></tbody>
                    <tfoot id="prayerTableFoot"></tfoot>
                </table>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-6 mb-3">
                    <div class="card-std text-center h-100">
                        <h5>BaÅŸlangÄ±Ã§ Tarihi</h5>
                        <input type="date" id="startDate" class="form-control text-center mt-2" onchange="updateStartDate(this.value)">
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card-std text-center h-100">
                        <h5>GeÃ§en SÃ¼re</h5>
                        <h3 class="text-success fw-bold mt-2" id="elapsedDays">0 GÃ¼n</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- BÃ–LÃœM 2: NAMAZ VAKÄ°TLERÄ° (YENÄ°LENMÄ°Åž) -->
        <div id="section-prayer" style="display: none;">
            <div class="prayer-widget-card">
                <div class="pw-header">
                    <div>
                        <div class="pw-location">
                            <i class="fas fa-map-marker-alt"></i> 
                            <span id="pwCityName">Ä°STANBUL</span>
                            <span style="opacity:0.5; margin:0 5px;">â€¢</span> 
                            <span>TR</span>
                        </div>
                        <div class="pw-date" id="pwFullDate">YÃ¼kleniyor...</div>
                    </div>
                    <button class="btn btn-sm btn-outline-light" onclick="openCityModal()"><i class="fas fa-pen"></i></button>
                </div>

                <div class="pw-timer-area">
                    <div>
                        <div class="pw-next-name" id="pwActiveName">...</div>
                        <div class="pw-label">Vaktine Kalan SÃ¼re</div>
                    </div>
                    <div class="pw-countdown" id="pwCountdown">--:--:--</div>
                </div>

                <div class="pw-grid" id="pwGrid">
                    <!-- JS Dolduracak -->
                </div>
            </div>
        </div>

        <!-- BÃ–LÃœM 3: Ä°STATÄ°STÄ°KLER -->
        <div id="section-stats" style="display: none;">
            <div class="card-std">
                <h5 class="text-center">Kaza Durumu</h5>
                <canvas id="barChart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <!-- BÃ–LÃœM 4: TESBÄ°HAT -->
        <div id="section-tesbihat" style="display: none;">
            <div class="row" id="tesbihatContainer"></div>
        </div>

        <!-- BÃ–LÃœM 5: AYARLAR -->
        <div id="section-settings" style="display: none;">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="card-std text-center h-100" onclick="openCityModal()">
                        <i class="fas fa-city fs-1 text-info mb-3"></i>
                        <h5>Åžehir DeÄŸiÅŸtir</h5>
                        <p class="small text-muted">Namaz vakitleri iÃ§in il seÃ§imi.</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card-std text-center h-100" onclick="downloadBackup()">
                        <i class="fas fa-download fs-1 text-success mb-3"></i>
                        <h5>Yedek Ä°ndir</h5>
                        <p class="small text-muted">Verileri JSON olarak al.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="showSection('dashboard', this)"><i class="fas fa-mosque"></i>Kaza</div>
    <div class="nav-item" onclick="showSection('prayer', this)"><i class="fas fa-clock"></i>Vakit</div>
    <div class="nav-item" onclick="showSection('stats', this)"><i class="fas fa-chart-pie"></i>Ä°statistik</div>
    <div class="nav-item" onclick="showSection('tesbihat', this)"><i class="fas fa-fingerprint"></i>Tesbihat</div>
    <div class="nav-item" onclick="toggleSidebar()"><i class="fas fa-bars"></i>MenÃ¼</div>
</div>

<script>
    // --- KONFÄ°GÃœRASYON VE DEÄžÄ°ÅžKENLER ---
    const jsConfetti = new JSConfetti();
    const firebaseConfig = { apiKey: "AIzaSyC7zdr3x8H--8piHR_1muAz2TVOOaebI54", authDomain: "kazanamazi-ser.firebaseapp.com", databaseURL: "https://kazanamazi-ser-default-rtdb.firebaseio.com", projectId: "kazanamazi-ser", storageBucket: "kazanamazi-ser.firebasestorage.app", messagingSenderId: "951730390034", appId: "1:951730390034:web:639f96ee859c10b0e944cb" };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();
    let dbRef = null;

    // Åžehir Listesi (Value: API iÃ§in Ä°ngilizce, Text: GÃ¶rÃ¼nÃ¼m iÃ§in TÃ¼rkÃ§e)
    const citiesList = [
        {v:"Adana", t:"ADANA"}, {v:"Adiyaman", t:"ADIYAMAN"}, {v:"Afyonkarahisar", t:"AFYON"}, {v:"Agri", t:"AÄžRI"}, {v:"Aksaray", t:"AKSARAY"}, {v:"Amasya", t:"AMASYA"}, {v:"Ankara", t:"ANKARA"}, {v:"Antalya", t:"ANTALYA"}, {v:"Ardahan", t:"ARDAHAN"}, {v:"Artvin", t:"ARTVÄ°N"}, {v:"Aydin", t:"AYDIN"},
        {v:"Balikesir", t:"BALIKESÄ°R"}, {v:"Bartin", t:"BARTIN"}, {v:"Batman", t:"BATMAN"}, {v:"Bayburt", t:"BAYBURT"}, {v:"Bilecik", t:"BÄ°LECÄ°K"}, {v:"Bingol", t:"BÄ°NGÃ–L"}, {v:"Bitlis", t:"BÄ°TLÄ°S"}, {v:"Bolu", t:"BOLU"}, {v:"Burdur", t:"BURDUR"}, {v:"Bursa", t:"BURSA"},
        {v:"Canakkale", t:"Ã‡ANAKKALE"}, {v:"Cankiri", t:"Ã‡ANKIRI"}, {v:"Corum", t:"Ã‡ORUM"}, {v:"Denizli", t:"DENÄ°ZLÄ°"}, {v:"Diyarbakir", t:"DÄ°YARBAKIR"}, {v:"Duzce", t:"DÃœZCE"}, {v:"Edirne", t:"EDÄ°RNE"}, {v:"Elazig", t:"ELAZIÄž"}, {v:"Erzincan", t:"ERZÄ°NCAN"}, {v:"Erzurum", t:"ERZURUM"}, {v:"Eskisehir", t:"ESKÄ°ÅžEHÄ°R"},
        {v:"Gaziantep", t:"GAZÄ°ANTEP"}, {v:"Giresun", t:"GÄ°RESUN"}, {v:"Gumushane", t:"GÃœMÃœÅžHANE"}, {v:"Hakkari", t:"HAKKARÄ°"}, {v:"Hatay", t:"HATAY"}, {v:"Igdir", t:"IÄžDIR"}, {v:"Isparta", t:"ISPARTA"}, {v:"Istanbul", t:"Ä°STANBUL"}, {v:"Izmir", t:"Ä°ZMÄ°R"},
        {v:"Kahramanmaras", t:"KAHRAMANMARAÅž"}, {v:"Karabuk", t:"KARABÃœK"}, {v:"Karaman", t:"KARAMAN"}, {v:"Kars", t:"KARS"}, {v:"Kastamonu", t:"KASTAMONU"}, {v:"Kayseri", t:"KAYSERÄ°"}, {v:"Kilis", t:"KÄ°LÄ°S"}, {v:"Kirikkale", t:"KIRIKKALE"}, {v:"Kirklareli", t:"KIRKLARELÄ°"}, {v:"Kirsehir", t:"KIRÅžEHÄ°R"}, {v:"Kocaeli", t:"KOCAELÄ°"}, {v:"Konya", t:"KONYA"}, {v:"Kutahya", t:"KÃœTAHYA"},
        {v:"Malatya", t:"MALATYA"}, {v:"Manisa", t:"MANÄ°SA"}, {v:"Mardin", t:"MARDÄ°N"}, {v:"Mersin", t:"MERSÄ°N"}, {v:"Mugla", t:"MUÄžLA"}, {v:"Mus", t:"MUÅž"}, {v:"Nevsehir", t:"NEVÅžEHÄ°R"}, {v:"Nigde", t:"NÄ°ÄžDE"}, {v:"Ordu", t:"ORDU"}, {v:"Osmaniye", t:"OSMANÄ°YE"},
        {v:"Rize", t:"RÄ°ZE"}, {v:"Sakarya", t:"SAKARYA"}, {v:"Samsun", t:"SAMSUN"}, {v:"Sanliurfa", t:"ÅžANLIURFA"}, {v:"Siirt", t:"SÄ°Ä°RT"}, {v:"Sinop", t:"SÄ°NOP"}, {v:"Sirnak", t:"ÅžIRNAK"}, {v:"Sivas", t:"SÄ°VAS"},
        {v:"Tekirdag", t:"TEKÄ°RDAÄž"}, {v:"Tokat", t:"TOKAT"}, {v:"Trabzon", t:"TRABZON"}, {v:"Tunceli", t:"TUNCELÄ°"}, {v:"Usak", t:"UÅžAK"}, {v:"Van", t:"VAN"}, {v:"Yalova", t:"YALOVA"}, {v:"Yozgat", t:"YOZGAT"}, {v:"Zonguldak", t:"ZONGULDAK"}
    ];

    const defaultData = {
        city: "Istanbul", 
        cityNameDisplay: "Ä°STANBUL", // GÃ¶rÃ¼nÃ¼m iÃ§in
        startDate: new Date().toISOString().split('T')[0],
        daily: { target: 10, counts: [0,0,0,0,0], date: new Date().toLocaleDateString('tr-TR') },
        counts: [{name:"Sabah",target:0,done:0},{name:"Ã–ÄŸle",target:0,done:0},{name:"Ä°kindi",target:0,done:0},{name:"AkÅŸam",target:0,done:0},{name:"YatsÄ±",target:0,done:0}],
        tesbihat: [ {name:"SÃ¼bhanallah",arabic:"Ø³ÙØ¨Ù’Ø­ÙŽØ§Ù†ÙŽ Ù±Ù„Ù„ÙŽÙ‘Ù°Ù‡Ù",current:0,target:33}, {name:"ElhamdÃ¼lillah",arabic:"Ù±Ù„Ù’Ø­ÙŽÙ…Ù’Ø¯Ù Ù„ÙÙ„ÙŽÙ‘Ù°Ù‡Ù",current:0,target:33}, {name:"Allahu Ekber",arabic:"Ù±Ù„Ù„ÙŽÙ‘Ù°Ù‡Ù Ø£ÙŽÙƒÙ’Ø¨ÙŽØ±Ù",current:0,target:33} ],
        history: []
    };
    let localData = JSON.parse(JSON.stringify(defaultData));
    let prayerTimesData = null;
    let timerInterval = null;
    let barChart = null;

    // --- AUTHENTICATION ---
    auth.onAuthStateChanged((user) => {
        if (user) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-wrapper').style.display = 'flex';
            document.getElementById('sidebarUserInfo').innerText = user.displayName;
            dbRef = db.ref('users/' + user.uid + '/proData');
            dbRef.on('value', (s) => {
                const d = s.val();
                if (d) localData = d;
                checkDailyReset();
                if(!localData.city) { localData.city = "Istanbul"; localData.cityNameDisplay = "Ä°STANBUL"; }
                
                renderDashboard();
                populateCities();
                initPrayerWidget(); // Widget baÅŸlat
                document.getElementById('loading-overlay').style.display = 'none';
            });
        } else {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('loading-overlay').style.display = 'none';
        }
    });

    function loginWithGoogle() { auth.signInWithPopup(provider).catch(e => alert(e.message)); }
    function saveToCloud() { if(dbRef) dbRef.set(localData); }

    // --- NAVIGASYON ---
    window.showSection = function(id, el) {
        // Alt Navigasyon AktifliÄŸi
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(el) el.classList.add('active');
        
        // Sidebar AktifliÄŸi
        document.querySelectorAll('#sidebar li').forEach(l => l.classList.remove('active'));
        const sideEl = document.getElementById('menu-'+id);
        if(sideEl) sideEl.classList.add('active');

        // BÃ¶lÃ¼m GÃ¶ster/Gizle
        ['dashboard','prayer','stats','tesbihat','settings'].forEach(s => document.getElementById('section-'+s).style.display = 'none');
        document.getElementById('section-'+id).style.display = 'block';

        if(window.innerWidth < 768) { document.getElementById('sidebar').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); }

        // BÃ¶lÃ¼me Ã¶zel iÅŸlemler
        if(id === 'dashboard') renderDashboard();
        if(id === 'prayer') initPrayerWidget();
        if(id === 'stats') renderStats();
        if(id === 'tesbihat') renderTesbihat();
    };
    function toggleSidebar() { 
        document.getElementById('sidebar').classList.toggle('active'); 
        document.getElementById('overlay').classList.toggle('active'); 
    }

    // --- KAZA TAKÄ°P MANTIÄžI (ORÄ°JÄ°NAL) ---
    function checkDailyReset() {
        const today = new Date().toLocaleDateString('tr-TR');
        if(localData.daily.date !== today) {
            localData.daily.date = today;
            localData.daily.counts = [0,0,0,0,0];
            saveToCloud();
        }
    }

    function renderDashboard() {
        // GÃ¼nlÃ¼k Hedef
        const totalDaily = localData.daily.counts.reduce((a,b)=>a+b, 0);
        document.getElementById('dailyCountDisplay').innerText = totalDaily;
        document.getElementById('dailyGoalInput').value = localData.daily.target;
        let p = (totalDaily / localData.daily.target) * 100;
        document.getElementById('dailyProgressBar').style.width = Math.min(p, 100) + "%";

        // Tablo
        const tbody = document.getElementById('prayerTableBody');
        const tfoot = document.getElementById('prayerTableFoot');
        tbody.innerHTML = "";
        let tT=0, tD=0;
        
        // GeÃ§en GÃ¼n
        const start = new Date(localData.startDate);
        const now = new Date();
        const diffTime = Math.abs(now - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) || 1;
        document.getElementById('startDate').value = localData.startDate;
        document.getElementById('elapsedDays').innerText = diffDays + " GÃ¼n";

        localData.counts.forEach((c, i) => {
            tT += parseInt(c.target); tD += parseInt(c.done);
            tbody.innerHTML += `
            <tr>
                <td class="col-namaz">${c.name}</td>
                <td><input type="number" class="table-input" value="${c.target}" onchange="upT(${i},this.value)"></td>
                <td><input type="number" class="table-input" value="${c.done}" onchange="upD(${i},this.value)"></td>
                <td>
                    <button class="btn-action btn-plus" onclick="chC(${i}, 1)">+</button>
                    <button class="btn-action btn-minus" onclick="chC(${i}, -1)">-</button>
                </td>
            </tr>`;
        });
        tfoot.innerHTML = `<tr><td>TOPLAM</td><td>${tT}</td><td>${tD}</td><td></td></tr>`;
    }

    window.upT = (i,v) => { localData.counts[i].target = parseInt(v)||0; saveToCloud(); };
    window.upD = (i,v) => { localData.counts[i].done = parseInt(v)||0; saveToCloud(); };
    window.chC = (i,v) => {
        if(navigator.vibrate) navigator.vibrate(10);
        const n = localData.counts[i].done + v;
        if(n >= 0) {
            localData.counts[i].done = n;
            if(v > 0) localData.daily.counts[i]++;
            else if(localData.daily.counts[i] > 0) localData.daily.counts[i]--;
            saveToCloud(); renderDashboard();
            if(v > 0 && localData.daily.counts.reduce((a,b)=>a+b,0) === localData.daily.target) jsConfetti.addConfetti();
        }
    };
    window.updateDailyGoal = (v) => { localData.daily.target = parseInt(v)||10; saveToCloud(); renderDashboard(); };
    window.updateStartDate = (v) => { localData.startDate = v; saveToCloud(); renderDashboard(); };

    // --- NAMAZ VAKÄ°TLERÄ° MANTIÄžI (GARANTÄ° API + DROPDOWN) ---
    function populateCities() {
        const sel = document.getElementById('citySelect');
        if(sel.options.length > 1) return;
        citiesList.forEach(c => {
            let opt = document.createElement('option');
            opt.value = c.v; // API iÃ§in (Ingilizce)
            opt.text = c.t;  // GÃ¶rÃ¼nÃ¼m iÃ§in (TÃ¼rkÃ§e)
            sel.appendChild(opt);
        });
    }

    function openCityModal() {
        populateCities();
        document.getElementById('citySelect').value = localData.city || "Istanbul";
        document.getElementById('cityModal').style.display = 'flex';
    }

    function saveCity() {
        const sel = document.getElementById('citySelect');
        if(sel.value) {
            localData.city = sel.value;
            localData.cityNameDisplay = sel.options[sel.selectedIndex].text;
            saveToCloud();
            document.getElementById('cityModal').style.display = 'none';
            initPrayerWidget();
        }
    }

    function initPrayerWidget() {
        const cityApiName = localData.city || "Istanbul";
        const cityDisplayName = localData.cityNameDisplay || "Ä°STANBUL";
        
        document.getElementById('pwCityName').innerText = cityDisplayName;

        // Tarih
        const d = new Date();
        const miladi = d.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
        let hicri = "";
        try {
            hicri = new Intl.DateTimeFormat('tr-TR-u-ca-islamic-civil', { day: 'numeric', month: 'long', year: 'numeric' }).format(d).replace('Hicri', '').trim();
        } catch(e) { hicri = ""; }
        document.getElementById('pwFullDate').innerText = `${miladi} â€¢ ${hicri}`;

        // Veri Ã‡ek
        fetchPrayerTimes(cityApiName);
    }

    function fetchPrayerTimes(city) {
        // En saÄŸlam API (Vakit Vercel - Diyanet Proxy)
        const d = new Date();
        const dateStr = d.toISOString().split('T')[0]; // YYYY-MM-DD
        
        fetch(`https://vakit.vercel.app/api/timesFromPlace?country=Turkey&region=${city}&city=${city}&date=${dateStr}&days=1&timezoneOffset=180`)
            .then(res => res.json())
            .then(data => {
                if(data && data.times && data.times[dateStr]) {
                    const t = data.times[dateStr];
                    const timesObj = { Imsak: t[0], Gunes: t[1], Ogle: t[2], Ikindi: t[3], Aksam: t[4], Yatsi: t[5] };
                    prayerTimesData = timesObj;
                    renderPrayerGrid(timesObj);
                    startTimer();
                } else {
                    // Yedek API (Namaz Vakti Vercel)
                    fetch(`https://namaz-vakti.vercel.app/api/timesFromPlace?country=Turkey&region=${city}&city=${city}`)
                    .then(r2 => r2.json())
                    .then(d2 => {
                        if(d2 && d2.times) {
                            prayerTimesData = d2.times;
                            renderPrayerGrid(d2.times);
                            startTimer();
                        }
                    });
                }
            })
            .catch(e => console.error(e));
    }

    function renderPrayerGrid(times) {
        const grid = document.getElementById('pwGrid');
        grid.innerHTML = '';
        const map = [
            {k:'Imsak', l:'Ä°MSAK', i:'fa-cloud-sun'}, {k:'Gunes', l:'GÃœNEÅž', i:'fa-sun'},
            {k:'Ogle', l:'Ã–ÄžLE', i:'fa-clock'}, {k:'Ikindi', l:'Ä°KÄ°NDÄ°', i:'fa-cloud-sun-rain'},
            {k:'Aksam', l:'AKÅžAM', i:'fa-moon'}, {k:'Yatsi', l:'YATSI', i:'fa-stars'}
        ];
        map.forEach(m => {
            grid.innerHTML += `<div class="pw-box" id="pb-${m.k}"><span class="pw-box-label">${m.l}</span><span class="pw-box-time">${times[m.k]}</span><i class="fas ${m.i} pw-box-icon"></i></div>`;
        });
    }

    function startTimer() {
        if(timerInterval) clearInterval(timerInterval);
        const update = () => {
            if(!prayerTimesData) return;
            const now = new Date();
            const timeStr = (t) => { if(!t) return new Date(); const [h,m] = t.split(':').map(Number); const d = new Date(); d.setHours(h,m,0,0); return d; };
            const sch = {
                Imsak: timeStr(prayerTimesData.Imsak), Gunes: timeStr(prayerTimesData.Gunes),
                Ogle: timeStr(prayerTimesData.Ogle), Ikindi: timeStr(prayerTimesData.Ikindi),
                Aksam: timeStr(prayerTimesData.Aksam), Yatsi: timeStr(prayerTimesData.Yatsi)
            };
            
            let nextKey = 'Imsak', nextTime = sch.Imsak, activeKey = 'Yatsi';
            
            if(now < sch.Imsak) { nextKey='Imsak'; nextTime=sch.Imsak; activeKey='Yatsi'; }
            else if(now < sch.Gunes) { nextKey='Gunes'; nextTime=sch.Gunes; activeKey='Imsak'; }
            else if(now < sch.Ogle) { nextKey='Ogle'; nextTime=sch.Ogle; activeKey='Gunes'; }
            else if(now < sch.Ikindi) { nextKey='Ikindi'; nextTime=sch.Ikindi; activeKey='Ogle'; }
            else if(now < sch.Aksam) { nextKey='Aksam'; nextTime=sch.Aksam; activeKey='Ikindi'; }
            else if(now < sch.Yatsi) { nextKey='Yatsi'; nextTime=sch.Yatsi; activeKey='Aksam'; }
            else { 
                nextKey='Imsak'; nextTime=new Date(sch.Imsak); nextTime.setDate(nextTime.getDate()+1); activeKey='Yatsi'; 
            }

            // Ä°simleri gÃ¼ncelle
            const labelMap = { Imsak:'Ä°MSAK', Gunes:'GÃœNEÅž', Ogle:'Ã–ÄžLE', Ikindi:'Ä°KÄ°NDÄ°', Aksam:'AKÅžAM', Yatsi:'YATSI' };
            document.getElementById('pwActiveName').innerText = labelMap[nextKey];

            // Aktif kutuyu boya
            document.querySelectorAll('.pw-box').forEach(b => b.classList.remove('active'));
            const el = document.getElementById('pb-'+activeKey);
            if(el) el.classList.add('active');

            // SayaÃ§
            let diff = nextTime - now; if(diff<0) diff=0;
            const h = Math.floor(diff/3600000);
            const m = Math.floor((diff%3600000)/60000);
            const s = Math.floor((diff%60000)/1000);
            document.getElementById('pwCountdown').innerText = `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        };
        update();
        timerInterval = setInterval(update, 1000);
    }

    // --- DÄ°ÄžER (TESBÄ°HAT, STATS, AYARLAR) ---
    function renderTesbihat() {
        const c=document.getElementById('tesbihatContainer'); c.innerHTML="";
        localData.tesbihat.forEach((t,i) => {
            c.innerHTML += `<div class="col-md-6"><div class="card-std text-center"><h5>${t.name}</h5><div class="arabic-text my-2">${t.arabic}</div><h1 class="display-4 fw-bold">${t.current}</h1><button class="btn btn-lg btn-success w-100 mt-2" onclick="incTes(${i})">+</button></div></div>`;
        });
    }
    window.incTes = (i) => { localData.tesbihat[i].current++; saveToCloud(); renderTesbihat(); if(navigator.vibrate) navigator.vibrate(10); };

    function renderStats() {
        const ctx=document.getElementById('barChart').getContext('2d');
        if(barChart) barChart.destroy();
        barChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: localData.counts.map(c=>c.name), datasets: [{ label:'KÄ±lÄ±nan', data: localData.counts.map(c=>c.done), backgroundColor:'#198754' }] },
            options: { responsive:true, maintainAspectRatio:false }
        });
    }

    window.toggleDarkMode = () => { document.body.classList.toggle('dark-mode'); };
    window.downloadBackup = () => { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(localData)],{type:'application/json'})); a.download='yedek.json'; a.click(); };

</script>
</body>
</html>
