<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Kaza ve Ä°badet Takip</title>
    
    <meta name="theme-color" content="#198754">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" id="my-manifest">

    <!-- STÄ°LLER -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Amiri:wght@700&display=swap" rel="stylesheet">
    
    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <!-- CHART & EFEKT -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>

    <style>
        :root { --bg-color: #e3e6ec; --text-color: #212529; --card-bg: #ffffff; --sidebar-bg: #157347; --table-head: #157347; --table-row-bg: #ffffff; --input-bg: #f8f9fa; --input-text: #000000; --border-color: #ced4da; --modal-bg: #ffffff; --col-namaz-bg: #5a826e; --col-namaz-text: #ffffff; --table-foot-bg: #1f3b2f; --table-foot-border: #142921; --z-btn-plus-bg: linear-gradient(145deg, #198754, #20c997); --box-target-bg: #e8f5e9; --box-target-border: #c3e6cb; --box-target-text: #155724; --box-add-bg: #e7f1ff; --box-add-border: #b6d4fe; --stat-avg-color: #6610f2; }
        body.dark-mode { --bg-color: #121212; --text-color: #e0e0e0; --card-bg: #1e1e1e; --sidebar-bg: #0f5132; --table-head: #0f5132; --table-row-bg: #2d2d2d; --input-bg: #3a3a3a; --input-text: #ffffff; --border-color: #444; --modal-bg: #2d2d2d; --col-namaz-bg: #1e3b2e; --col-namaz-text: #e0e0e0; --table-foot-bg: #0b1a15; --table-foot-border: #050d0a; --z-btn-plus-bg: linear-gradient(145deg, #0f5132, #146c43); --box-target-bg: #0f2e1c; --box-target-border: #146c43; --box-target-text: #75b798; --box-add-bg: #052c65; --box-add-border: #084298; --stat-avg-color: #d63384; }
        
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Poppins', sans-serif; transition: 0.3s; overflow-x: hidden; min-height: 100vh; }
        
        /* LOADING */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(25, 135, 84, 0.2); border-top-color: #198754; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* LAYOUT */
        .wrapper { display: flex; width: 100%; }
        #sidebar { min-width: 260px; max-width: 260px; background: var(--sidebar-bg); color: #fff; height: 100vh; transition: 0.3s; z-index: 2000; position: fixed; top: 0; left: 0; overflow-y: auto; margin-left: -260px; }
        #overlay { display: none; position: fixed; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 1999; top: 0; left: 0; backdrop-filter: blur(2px); }
        #overlay.active { display: block; }
        #sidebar.active { margin-left: 0; }
        @media (min-width: 769px) { #sidebar { position: sticky; margin-left: 0; height: 100vh; z-index: 1050; } #sidebar.active { margin-left: -260px; } #overlay { display: none !important; } #content { width: calc(100% - 260px); margin-left: 0; } }
        @media (max-width: 768px) { #content { width: 100%; } }
        #sidebar ul li { padding: 15px; cursor: pointer; border-left: 5px solid transparent; transition: 0.2s; }
        #sidebar ul li:hover { background: rgba(255,255,255,0.1); }
        #sidebar ul li.active { background: rgba(255,255,255,0.2); border-left-color: #fff; font-weight: 600; }
        #content { padding: 20px; min-height: 100vh; width: 100%; max-width: 900px; margin: 0 auto; padding-bottom: 90px; }
        .app-header { text-align: center; color: var(--sidebar-bg); font-weight: 600; margin-bottom: 25px; font-size: 1.5rem; }
        body.dark-mode .app-header { color: #20c997; }

        /* NAMAZ WIDGET (DIYANET STYLE) */
        .prayer-widget-card { background: linear-gradient(135deg, #2b2b36 0%, #1e1e24 100%); border-radius: 25px; padding: 25px; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 20px; border: 1px solid #3a3a45; }
        .diyanet-select { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 8px; padding: 10px; width: 100%; margin-bottom: 10px; }
        .diyanet-select option { color: #000; }
        .main-timer-box { background: rgba(255,255,255,0.05); border-radius: 15px; padding: 20px; text-align: center; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .next-vakit-label { font-size: 1.3rem; font-weight: bold; text-transform: uppercase; display: block; }
        .timer-countdown { font-size: 3.5rem; font-weight: 700; font-family: monospace; letter-spacing: -2px; line-height: 1; margin: 10px 0; }
        .vakit-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .vakit-item { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 10px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .vakit-item.active { background: linear-gradient(135deg, #fd7e14, #d35400); border-color: #fd7e14; transform: scale(1.05); box-shadow: 0 5px 15px rgba(253, 126, 20, 0.3); }
        .vakit-name { font-size: 0.75rem; opacity: 0.8; display: block; font-weight: 600; text-transform: uppercase; }
        .vakit-time { font-size: 1.2rem; font-weight: bold; }

        /* GENEL UI */
        .card-custom { border-radius: 16px; background: var(--card-bg); box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        .table-responsive { border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; background: var(--card-bg); }
        .main-table { width: 100%; border-collapse: collapse; min-width: 600px; font-size: 0.85rem; }
        .main-table th { background: var(--table-head); color: white; padding: 12px; text-align: center; }
        .main-table td { background: var(--table-row-bg); color: var(--text-color); border: 1px solid var(--border-color); padding: 8px; text-align: center; vertical-align: middle; }
        .table-input { width: 100%; max-width: 100px; text-align: center; border: 1px solid var(--border-color); border-radius: 5px; padding: 5px; background: var(--input-bg); color: var(--input-text); margin: 0 auto; display: block; font-weight: bold; }
        .btn-action { width: 35px; height: 35px; border-radius: 8px; border: none; color: white; font-weight: bold; margin: 0 2px; }
        .btn-plus { background: #198754; } .btn-minus { background: #6c757d; }
        
        .bottom-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: var(--card-bg); border-top: 1px solid var(--border-color); z-index: 1060; justify-content: space-around; align-items: center; padding-bottom: 10px; }
        .nav-item { text-align: center; color: var(--text-color); opacity: 0.6; font-size: 0.75rem; flex: 1; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .nav-item.active { color: #198754; opacity: 1; font-weight: 600; }
        .nav-item i { font-size: 1.4rem; margin-bottom: 4px; }
        @media (max-width: 768px) { .bottom-nav { display: flex; } }

        /* DÄ°ÄžERLERÄ° */
        .login-card { max-width: 400px; margin: auto; margin-top: 10vh; padding: 40px; text-align: center; background: var(--card-bg); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .goal-card { background: linear-gradient(135deg, #198754, #20c997); color: white; padding: 20px; border-radius: 16px; text-align: center; margin-bottom: 20px; }
        .goal-card.success-mode { border: 3px solid #ffc107; }
    </style>
</head>
<body>

<!-- LOADING -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <div style="margin-top:15px; font-weight:600; color:#198754;">YÃ¼kleniyor...</div>
</div>

<!-- GÄ°RÄ°Åž -->
<div id="login-screen">
    <div class="login-card">
        <h3 class="text-success fw-bold mb-4">Ä°badet Takip</h3>
        <button class="btn btn-dark w-100 py-3 rounded-pill" onclick="loginWithGoogle()">
            <i class="fab fa-google me-2"></i> Google ile GiriÅŸ
        </button>
    </div>
</div>

<!-- UYGULAMA -->
<div id="app-wrapper" class="wrapper" style="display:none;">
    <nav id="sidebar">
        <div class="p-4 text-center" style="background: rgba(0,0,0,0.1);">
            <h4 class="fw-bold"><i class="fas fa-kaaba me-2"></i>Takip</h4>
            <small id="sidebarUserInfo" class="text-white-50">...</small>
        </div>
        <ul class="list-unstyled components p-2">
            <li id="menu-dashboard" class="active" onclick="showSection('dashboard')"><i class="fas fa-mosque me-3"></i> Kaza NamazÄ±</li>
            <li id="menu-vakitler" onclick="showSection('vakitler')"><i class="fas fa-clock me-3"></i> Namaz Vakitleri</li>
            <li id="menu-stats" onclick="showSection('stats')"><i class="fas fa-chart-pie me-3"></i> Ä°statistikler</li>
            <li id="menu-tesbihat" onclick="showSection('tesbihat')"><i class="fas fa-fingerprint me-3"></i> Tesbihat</li>
            <li id="menu-calculator" onclick="showSection('calculator')"><i class="fas fa-calculator me-3"></i> Hesap SihirbazÄ±</li>
            <li onclick="toggleDarkMode()"><i class="fas fa-moon me-3"></i> Mod DeÄŸiÅŸtir</li>
            <li onclick="logout()"><i class="fas fa-sign-out-alt me-3"></i> Ã‡Ä±kÄ±ÅŸ</li>
        </ul>
    </nav>

    <div id="content">
        <!-- DASHBOARD -->
        <div id="section-dashboard" style="display: block;">
            <div class="row justify-content-center mb-4">
                <div class="col-md-8 col-lg-6">
                    <div id="goalCard" class="goal-card">
                        <h4>ðŸŽ¯ GÃ¼nlÃ¼k Hedef</h4>
                        <div class="d-flex justify-content-center align-items-center gap-2 my-3">
                            <span>BugÃ¼n</span>
                            <strong class="fs-1" id="dailyCountDisplay">0</strong>
                            <span>/</span>
                            <input type="number" id="dailyGoalInput" class="form-control text-center fw-bold" style="width:70px;" value="10" onchange="updateDailyGoal(this.value)">
                        </div>
                        <div class="progress" style="height: 8px;"><div id="dailyProgressBar" class="progress-bar bg-warning" style="width: 0%"></div></div>
                        <div id="goalSuccessMessage" class="mt-2 fw-bold" style="display: none;">ðŸŽ‰ Hedefe UlaÅŸÄ±ldÄ±!</div>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table main-table">
                    <thead><tr><th>Namaz</th><th>KÄ±lÄ±nacak</th><th>KÄ±lÄ±nan</th><th>Ä°ÅŸlem</th></tr></thead>
                    <tbody id="prayerTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- NAMAZ VAKÄ°TLERÄ° (DÄ°YANET API) -->
        <div id="section-vakitler" style="display: none;">
            <h3 class="app-header">Namaz Vakitleri (Diyanet)</h3>
            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6">
                    <div class="prayer-widget-card">
                        <!-- Åžehir / Ä°lÃ§e SeÃ§imi -->
                        <div class="widget-header">
                            <select id="citySelect" class="diyanet-select">
                                <option value="">Åžehir YÃ¼kleniyor...</option>
                            </select>
                            <select id="districtSelect" class="diyanet-select">
                                <option value="">Ã–nce Åžehir SeÃ§in</option>
                            </select>
                            <div class="date-info text-center text-white-50" id="diyanetDate">Tarih Bekleniyor...</div>
                        </div>

                        <!-- SayaÃ§ -->
                        <div class="main-timer-box">
                            <span class="next-vakit-label" id="nextPrayerName">VAKÄ°T</span>
                            <div class="timer-countdown" id="countdownDisplay">--:--:--</div>
                            <div class="timer-subtext">Vaktine Kalan SÃ¼re</div>
                        </div>

                        <!-- Tablo -->
                        <div class="vakit-grid">
                            <div class="vakit-item" id="box-fajr"><span class="vakit-name">Ä°MSAK</span><span class="vakit-time" id="t-fajr">--:--</span></div>
                            <div class="vakit-item" id="box-sunrise"><span class="vakit-name">GÃœNEÅž</span><span class="vakit-time" id="t-sunrise">--:--</span></div>
                            <div class="vakit-item" id="box-dhuhr"><span class="vakit-name">Ã–ÄžLE</span><span class="vakit-time" id="t-dhuhr">--:--</span></div>
                            <div class="vakit-item" id="box-asr"><span class="vakit-name">Ä°KÄ°NDÄ°</span><span class="vakit-time" id="t-asr">--:--</span></div>
                            <div class="vakit-item" id="box-maghrib"><span class="vakit-name">AKÅžAM</span><span class="vakit-time" id="t-maghrib">--:--</span></div>
                            <div class="vakit-item" id="box-isha"><span class="vakit-name">YATSI</span><span class="vakit-time" id="t-isha">--:--</span></div>
                        </div>
                    </div>
                    <div class="alert alert-dark text-center small mt-3">
                        <i class="fas fa-check-circle text-success me-1"></i> Veriler <strong>namazvakitleri.diyanet.gov.tr</strong> adresinden canlÄ± Ã§ekilmektedir.
                    </div>
                </div>
            </div>
        </div>

        <!-- DÄ°ÄžER BÃ–LÃœMLER (Ã–zet) -->
        <div id="section-stats" style="display: none;"><h3 class="app-header">Ä°statistikler</h3><div class="card-custom text-center"><p>Grafikler hazÄ±rlanÄ±yor...</p></div></div>
        <div id="section-tesbihat" style="display: none;"><h3 class="app-header">Tesbihat</h3><div id="tesbihatContainer" class="row g-3"></div></div>
        <div id="section-calculator" style="display: none;"><h3 class="app-header">Hesaplama</h3><div class="card-custom">Hesaplama araÃ§larÄ± burada olacak.</div></div>
        <div id="section-settings" style="display: none;"><h3 class="app-header">Ayarlar</h3><div class="card-custom">Ayarlar burada olacak.</div></div>

    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="showSection('dashboard');"><i class="fas fa-mosque"></i><span>Kaza</span></div>
    <div class="nav-item" onclick="showSection('vakitler');"><i class="fas fa-clock"></i><span>Vakitler</span></div>
    <div class="nav-item" onclick="showSection('tesbihat');"><i class="fas fa-fingerprint"></i><span>Tesbihat</span></div>
    <div class="nav-item" onclick="toggleSidebar()"><i class="fas fa-bars"></i><span>MenÃ¼</span></div>
</div>

<script>
    // --- AYARLAR ---
    const firebaseConfig = {
        apiKey: "AIzaSyC7zdr3x8H--8piHR_1muAz2TVOOaebI54",
        authDomain: "kazanamazi-ser.firebaseapp.com",
        databaseURL: "https://kazanamazi-ser-default-rtdb.firebaseio.com",
        projectId: "kazanamazi-ser",
        storageBucket: "kazanamazi-ser.firebasestorage.app",
        messagingSenderId: "951730390034",
        appId: "1:951730390034:web:639f96ee859c10b0e944cb",
        measurementId: "G-5WGCDTL1RX"
    };
    
    // Firebase BaÅŸlat
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();
    const jsConfetti = new JSConfetti();
    let localData = {};
    let dbRef = null;

    // --- GÃœVENLÄ° YÃœKLEME (LOADING KÄ°LÄ°DÄ°) ---
    // EÄŸer 3 saniye iÃ§inde veri gelmezse veya hata olursa loading ekranÄ±nÄ± zorla kapat
    setTimeout(() => {
        document.getElementById('loading-overlay').style.opacity = '0';
        setTimeout(() => { document.getElementById('loading-overlay').style.visibility = 'hidden'; }, 500);
    }, 3000);

    // --- AUTH LOGIC ---
    auth.onAuthStateChanged((user) => {
        if (user) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-wrapper').style.display = 'flex';
            document.getElementById('sidebarUserInfo').innerText = user.displayName;
            
            dbRef = db.ref('users/' + user.uid + '/namazData');
            dbRef.on('value', (s) => {
                const val = s.val();
                if(val) { localData = val; } 
                else { 
                    // VarsayÄ±lan Veri
                    localData = { counts: [{name:"Sabah",target:0,done:0},{name:"Ã–ÄŸle",target:0,done:0},{name:"Ä°kindi",target:0,done:0},{name:"AkÅŸam",target:0,done:0},{name:"YatsÄ±",target:0,done:0}], daily: {target:10, counts:[0,0,0,0,0], date: new Date().toLocaleDateString('tr-TR')}, tesbihat: [{name:"SÃ¼bhanallah",current:0,target:33},{name:"ElhamdÃ¼lillah",current:0,target:33},{name:"Allahu Ekber",current:0,target:33}] };
                    dbRef.set(localData);
                }
                renderApp();
                renderTesbihat();
            });
        } else {
            document.getElementById('app-wrapper').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
        }
    });

    function loginWithGoogle() { auth.signInWithPopup(provider).catch(alert); }
    function logout() { auth.signOut(); }
    function save() { if(dbRef) dbRef.set(localData); }

    // --- KAZA NAMAZI MANTIÄžI ---
    function renderApp() {
        if(!localData.counts) return;
        const tbody = document.getElementById('prayerTableBody');
        tbody.innerHTML = "";
        let totalDone = 0;
        
        localData.counts.forEach((item, i) => {
            totalDone += item.done;
            const percent = item.target > 0 ? (item.done / item.target) * 100 : 0;
            tbody.innerHTML += `
            <tr>
                <td class="col-namaz">${item.name}</td>
                <td><input type="number" class="table-input" value="${item.target}" onchange="upT(${i},this.value)"></td>
                <td>
                    <input type="number" class="table-input" value="${item.done}" onchange="upD(${i},this.value)">
                    <div class="progress-container"><div class="progress"><div class="progress-bar bg-success" style="width:${percent}%"></div></div></div>
                </td>
                <td class="col-action">
                    <div class="action-wrapper">
                        <button class="btn-action btn-plus" onclick="chC(${i},1)">+</button>
                        <button class="btn-action btn-minus" onclick="chC(${i},-1)">-</button>
                    </div>
                </td>
            </tr>`;
        });

        // GÃ¼nlÃ¼k Hedef
        const dailyTotal = localData.daily.counts.reduce((a,b)=>a+b, 0);
        document.getElementById('dailyCountDisplay').innerText = dailyTotal;
        document.getElementById('dailyGoalInput').value = localData.daily.target;
        let p = (dailyTotal / localData.daily.target) * 100;
        document.getElementById('dailyProgressBar').style.width = Math.min(p, 100) + "%";
        
        if(dailyTotal >= localData.daily.target) {
            document.getElementById('goalCard').classList.add('success-mode');
            document.getElementById('goalSuccessMessage').style.display = 'block';
        } else {
            document.getElementById('goalCard').classList.remove('success-mode');
            document.getElementById('goalSuccessMessage').style.display = 'none';
        }
    }

    window.upT = function(i,v) { localData.counts[i].target = parseInt(v)||0; save(); renderApp(); };
    window.upD = function(i,v) { localData.counts[i].done = parseInt(v)||0; save(); renderApp(); };
    window.chC = function(i,d) { 
        if(navigator.vibrate) navigator.vibrate(10);
        localData.counts[i].done += d; 
        if(d>0) {
            localData.daily.counts[i]++;
            const dt = localData.daily.counts.reduce((a,b)=>a+b,0);
            if(dt === localData.daily.target) jsConfetti.addConfetti();
        } else if(localData.daily.counts[i] > 0) {
            localData.daily.counts[i]--;
        }
        save(); renderApp(); 
    };
    window.updateDailyGoal = function(v) { localData.daily.target = parseInt(v)||10; save(); renderApp(); };

    // --- TESBÄ°HAT MANTIÄžI ---
    function renderTesbihat() {
        const c = document.getElementById('tesbihatContainer');
        c.innerHTML = "";
        if(!localData.tesbihat) return;
        localData.tesbihat.forEach((item, i) => {
            c.innerHTML += `
            <div class="col-md-6">
                <div class="zikr-card">
                    <h5>${item.name}</h5>
                    <div class="zikr-count">${item.current}</div>
                    <div class="zikr-btn-group">
                        <button class="btn-action btn-minus" onclick="tesUp(${i},-1)">-</button>
                        <button class="btn-action btn-plus" style="width:60px; height:60px; font-size:1.5rem;" onclick="tesUp(${i},1)">+</button>
                        <button class="btn-action bg-warning text-dark" onclick="tesRes(${i})">R</button>
                    </div>
                </div>
            </div>`;
        });
    }
    window.tesUp = function(i,d) { localData.tesbihat[i].current += d; if(localData.tesbihat[i].current<0) localData.tesbihat[i].current=0; save(); renderTesbihat(); };
    window.tesRes = function(i) { localData.tesbihat[i].current = 0; save(); renderTesbihat(); };

    // --- NAVÄ°GASYON ---
    window.showSection = function(id) {
        document.querySelectorAll('#sidebar ul li').forEach(li => li.classList.remove('active'));
        const activeMenu = document.getElementById('menu-' + id);
        if(activeMenu) activeMenu.classList.add('active');

        const pages = ['dashboard', 'vakitler', 'stats', 'tesbihat', 'calculator', 'settings'];
        pages.forEach(p => document.getElementById('section-'+p).style.display = 'none');
        document.getElementById('section-'+id).style.display = 'block';
        
        if(window.innerWidth < 768) {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }

        // EÄŸer Vakitler sekmesi aÃ§Ä±ldÄ±ysa verileri yÃ¼klemeyi dene
        if(id === 'vakitler' && document.getElementById('citySelect').options.length <= 1) {
            loadDiyanetCities();
        }
    };

    window.toggleSidebar = function() {
        document.getElementById('sidebar').classList.toggle('active');
        document.getElementById('overlay').classList.toggle('active');
    };
    
    window.toggleDarkMode = function() {
        document.body.classList.toggle('dark-mode');
    };

    /* 
       ================================================================
       NAMAZ VAKÄ°TLERÄ° (RESMÄ° DÄ°YANET API + PROXY)
       ================================================================
       Not: Diyanet'in sunucusu dÄ±ÅŸardan eriÅŸime kapalÄ± olduÄŸu iÃ§in
       "corsproxy.io" aracÄ±sÄ± kullanÄ±lÄ±yor. Bu veriyi bozmaz, sadece taÅŸÄ±r.
    */

    const PROXY_URL = "https://corsproxy.io/?url=";
    const API_BASE = "https://namazvakitleri.diyanet.gov.tr/api";

    // 1. ÅžEHÄ°RLERÄ° Ã‡EK
    function loadDiyanetCities() {
        fetch(PROXY_URL + encodeURIComponent(`${API_BASE}/regions`))
            .then(res => res.json())
            .then(data => {
                // Sadece TÃ¼rkiye ÅŸehirlerini al (RegionType = 1, CountryId = 2 varsayÄ±mÄ±yla)
                // Diyanet API'sinde TÃ¼rkiye ÅŸehirlerinin parent'Ä± genelde 2'dir (Turkey)
                // Ama veride direk ÅŸehirler regionType=1 olarak geliyor.
                
                // TÃ¼rkiye'nin ID'sini bulalÄ±m (Genelde 2)
                const turkey = data.find(d => d.regionName === "TÃœRKÄ°YE");
                const countryId = turkey ? turkey.regionId : 2;

                // Ãœlkesi TÃ¼rkiye olan ÅŸehirleri filtrele
                const cities = data.filter(r => r.regionType === 1 && r.parentRegionId === countryId);
                
                // Alfabeye gÃ¶re sÄ±rala
                cities.sort((a, b) => a.regionName.localeCompare(b.regionName));

                const sel = document.getElementById('citySelect');
                sel.innerHTML = "<option value=''>Åžehir SeÃ§iniz...</option>";
                
                cities.forEach(city => {
                    const opt = document.createElement('option');
                    opt.value = city.regionId;
                    opt.innerText = city.regionName;
                    sel.appendChild(opt);
                });

                // KayÄ±tlÄ± ÅŸehir varsa seÃ§
                const savedCity = localStorage.getItem('diyanetCityId');
                if(savedCity) {
                    sel.value = savedCity;
                    loadDistricts(savedCity);
                }
            })
            .catch(err => console.error("Åžehirler alÄ±namadÄ±", err));
    }

    // 2. Ä°LÃ‡ELERÄ° Ã‡EK
    window.loadDistricts = function(cityId) {
        if(!cityId) return;
        localStorage.setItem('diyanetCityId', cityId);

        // Diyanet API'de ilÃ§eleri Ã§ekmek iÃ§in regionType=2 ve parent=cityId kullanÄ±lÄ±r.
        // Ancak /regions endpointi tÃ¼m dÃ¼nyayÄ± dÃ¶ndÃ¼ÄŸÃ¼ iÃ§in client-side filtrelemek yerine
        // Diyanet'in web mantÄ±ÄŸÄ±nda sub-region Ã§ekmek daha iyi olabilir.
        // Ama /regions endpointi cached ise hÄ±zlÄ±dÄ±r.
        // DoÄŸru yÃ¶ntem: /regions endpointini tekrar sorgulamak yerine ilk veriden sÃ¼zmek zordur (Ã§ok veri).
        // Diyanet genelde dinamik endpoint sunar: /regions?parentRegionId=...
        
        fetch(PROXY_URL + encodeURIComponent(`${API_BASE}/regions?parentRegionId=${cityId}`))
            .then(res => res.json())
            .then(data => {
                const sel = document.getElementById('districtSelect');
                sel.innerHTML = "<option value=''>Ä°lÃ§e SeÃ§iniz...</option>";
                
                data.forEach(dist => {
                    const opt = document.createElement('option');
                    opt.value = dist.regionId;
                    opt.innerText = dist.regionName;
                    sel.appendChild(opt);
                });

                const savedDist = localStorage.getItem('diyanetDistId');
                if(savedDist) {
                    sel.value = savedDist;
                    loadTimes(savedDist);
                }
            });
    };

    // Event Listenerlar
    document.getElementById('citySelect').addEventListener('change', function() {
        loadDistricts(this.value);
    });
    
    document.getElementById('districtSelect').addEventListener('change', function() {
        localStorage.setItem('diyanetDistId', this.value);
        loadTimes(this.value);
    });

    // 3. VAKÄ°TLERÄ° Ã‡EK
    function loadTimes(districtId) {
        if(!districtId) return;
        
        // Diyanet API: /PrayerTimes?regionId=...
        const year = new Date().getFullYear();
        const url = `${API_BASE}/PrayerTimes?regionId=${districtId}`;
        
        fetch(PROXY_URL + encodeURIComponent(url))
            .then(res => res.json())
            .then(data => {
                // Diyanet tÃ¼m yÄ±lÄ± veya ayÄ± dÃ¶nebilir. Biz bugÃ¼nÃ¼ bulacaÄŸÄ±z.
                // Diyanet Date Format: "2025-11-27 00:00:00"
                const d = new Date();
                const y = d.getFullYear();
                const m = String(d.getMonth()+1).padStart(2,'0');
                const day = String(d.getDate()).padStart(2,'0');
                const todayStr = `${y}-${m}-${day}`; // 2025-11-27

                // Veri formatÄ±na gÃ¶re bul (Diyanet bazen "27.11.2025" bazen "YYYY-MM-DD" dÃ¶ner)
                // Genelde JSON'da: data[i].gregorianDateShortISO ("2025-11-27")
                
                // Gelen veriyi kontrol edelim, liste mi obje mi? Genelde liste.
                let todayData = null;
                if(Array.isArray(data)) {
                    todayData = data.find(item => item.gregorianDateShortISO === todayStr || item.date.startsWith(todayStr));
                } else if(data.data) {
                    todayData = data.data.find(item => item.date.startsWith(todayStr));
                }

                if(todayData) {
                    updatePrayerUI(todayData);
                } else {
                    alert("BugÃ¼nÃ¼n verisi bulunamadÄ±.");
                }
            })
            .catch(err => {
                console.error("Vakit hatasÄ±", err);
                document.getElementById('diyanetDate').innerText = "BaÄŸlantÄ± HatasÄ±!";
            });
    }

    let timerInterval = null;

    function updatePrayerUI(data) {
        // Tarih
        document.getElementById('diyanetDate').innerText = data.dateLong || data.date; // "27 KasÄ±m 2025 PerÅŸembe"

        // Saatler (Diyanet verisindeki keyler: fajr, sunrise, dhuhr, asr, maghrib, isha)
        const times = {
            imsak: data.fajr,
            gunes: data.sunrise,
            ogle: data.dhuhr,
            ikindi: data.asr,
            aksam: data.maghrib,
            yatsi: data.isha
        };

        document.getElementById('t-fajr').innerText = times.imsak;
        document.getElementById('t-sunrise').innerText = times.gunes;
        document.getElementById('t-dhuhr').innerText = times.ogle;
        document.getElementById('t-asr').innerText = times.ikindi;
        document.getElementById('t-maghrib').innerText = times.aksam;
        document.getElementById('t-isha').innerText = times.yatsi;

        // SayacÄ± BaÅŸlat
        if(timerInterval) clearInterval(timerInterval);
        startCountdown(times);
        timerInterval = setInterval(() => startCountdown(times), 1000);
    }

    function startCountdown(times) {
        const now = new Date();
        const names = { imsak:"Ä°msak", gunes:"GÃ¼neÅŸ", ogle:"Ã–ÄŸle", ikindi:"Ä°kindi", aksam:"AkÅŸam", yatsi:"YatsÄ±" };
        
        // ZamanlarÄ± Date objesine Ã§evir
        let nextTime = null;
        let nextName = "";
        let activeKey = "";

        // SÄ±rayla kontrol et
        const order = ['imsak', 'gunes', 'ogle', 'ikindi', 'aksam', 'yatsi'];
        
        for(let key of order) {
            const tStr = times[key];
            const [h, m] = tStr.split(':');
            const tDate = new Date();
            tDate.setHours(h, m, 0, 0);
            
            if(tDate > now) {
                nextTime = tDate;
                nextName = names[key];
                // Aktif olan bir Ã¶nceki
                const idx = order.indexOf(key);
                const prevIdx = idx === 0 ? 5 : idx - 1;
                activeKey = order[prevIdx];
                break;
            }
        }

        if(!nextTime) {
            // YarÄ±na kaldÄ± (Ä°msak)
            const [h, m] = times.imsak.split(':');
            nextTime = new Date();
            nextTime.setDate(nextTime.getDate() + 1);
            nextTime.setHours(h, m, 0, 0);
            nextName = "Ä°msak";
            activeKey = "yatsi";
        }

        // UI Boyama
        // ID'ler: box-fajr, box-sunrise... (keyler ile eÅŸleÅŸmeli)
        // order dizisi: imsak, gunes...
        // HTML ID map
        const idMap = { imsak:'box-fajr', gunes:'box-sunrise', ogle:'box-dhuhr', ikindi:'box-asr', aksam:'box-maghrib', yatsi:'box-isha' };
        
        document.querySelectorAll('.vakit-item').forEach(el => el.classList.remove('active'));
        if(activeKey) {
            document.getElementById(idMap[activeKey]).classList.add('active');
        }

        // YazÄ±
        document.getElementById('nextPrayerName').innerText = nextName;
        
        const diff = nextTime - now;
        const h = Math.floor(diff / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        const s = Math.floor((diff % 60000) / 1000);
        
        document.getElementById('countdownDisplay').innerText = 
            `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

</script>
</body>
</html>
