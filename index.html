<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kaza NamazÄ± Takip</title>
    
    <meta name="theme-color" content="#198754">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" id="my-manifest">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>

    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-x: hidden; }
        
        /* LAYOUT */
        .wrapper { display: flex; width: 100%; align-items: stretch; }
        #sidebar { min-width: 250px; max-width: 250px; background: #157347; color: #fff; min-height: 100vh; transition: all 0.3s; }
        #sidebar.active { margin-left: -250px; }
        #sidebar .sidebar-header { padding: 20px; background: #146c43; }
        #sidebar ul.components { padding: 20px 0; border-bottom: 1px solid #47748b; }
        #sidebar ul li { padding: 10px; font-size: 1.1em; display: block; cursor: pointer; }
        #sidebar ul li:hover { background: #146c43; }
        #sidebar ul li.active { background: #fff; color: #157347; border-radius: 5px 0 0 5px; margin-left: 10px; font-weight: bold; }
        
        #content { width: 100%; padding: 20px; min-height: 100vh; transition: all 0.3s; }
        @media (max-width: 768px) {
            #sidebar { margin-left: -250px; position: fixed; z-index: 999; height: 100%; }
            #sidebar.active { margin-left: 0; }
        }

        .app-header { text-align: center; color: #198754; font-weight: bold; margin-bottom: 20px; }
        
        /* TABLO Ä°YÄ°LEÅTÄ°RMELERÄ° (MOBÄ°L Ä°Ã‡Ä°N) */
        .main-table thead th { 
            background-color: #157347; color: white; vertical-align: middle; text-align: center; font-size: 0.9rem; 
            white-space: nowrap; /* BaÅŸlÄ±klarÄ±n alt satÄ±ra geÃ§mesini engelle */
        }
        .main-table tbody td { 
            vertical-align: middle; text-align: center; background-color: #e6e6e6; font-weight: bold; 
            white-space: nowrap; /* Ä°Ã§eriÄŸin sÄ±kÄ±ÅŸmasÄ±nÄ± engelle, kaydÄ±rmaya zorla */
        }
        .main-table input { text-align: center; font-weight: bold; min-width: 60px; }
        .main-table tfoot td { background-color: #d9534f; color: white; font-weight: bold; text-align: center; border-color: #c9302c; }
        
        .btn-action { width: 30px; height: 30px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; margin: 0 2px; }
        .btn-plus { background-color: #20c997; border: none; color: white; }
        .btn-minus { background-color: #6c757d; border: none; color: white; }
        .col-namaz { background-color: #f4a261 !important; color: black; } 
        .hidden { display: none !important; }
        
        /* MOBÄ°L Ã–ZEL AYARLAR */
        @media (max-width: 768px) {
            .main-table { font-size: 0.8rem; } /* YazÄ±larÄ± kÃ¼Ã§Ã¼lt */
            .main-table th, .main-table td { padding: 0.4rem !important; } /* BoÅŸluklarÄ± azalt */
            .btn-action { width: 25px; height: 25px; font-size: 0.8rem; } /* ButonlarÄ± kÃ¼Ã§Ã¼lt */
            /* Telefondan girince tablo yatay kaydÄ±rÄ±labilir olsun */
            .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        }

        #login-screen { height: 100vh; display: flex; justify-content: center; align-items: center; background-color: #e9ecef; }
        .login-card { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 100%; }
        
        .chart-container { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; text-align: center; }

        .goal-card {
            background: linear-gradient(135deg, #198754, #20c997);
            color: white; border-radius: 15px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(32, 201, 151, 0.4);
            position: relative; overflow: hidden; transition: all 0.3s ease;
        }
        .goal-card.success-mode { background: linear-gradient(135deg, #1aa179, #157347); border: 3px solid #ffc107; box-shadow: 0 0 20px rgba(255, 193, 7, 0.6); }
        .goal-input { width: 80px; text-align: center; font-weight: bold; border: none; border-radius: 5px; color: #198754; }

        .badge-container { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-top: 20px; margin-bottom: 40px; }
        .badge-item { text-align: center; width: 110px; background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); animation: popIn 0.5s ease; }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        .badge-icon { font-size: 3rem; display: block; margin-bottom: 5px; }
        .badge-title { font-size: 0.85rem; font-weight: bold; color: #198754; }

        .history-row-up, .history-row-up > td { background-color: #d1e7dd !important; color: #0f5132 !important; }
        .history-row-down, .history-row-down > td { background-color: #f8d7da !important; color: #842029 !important; }
        
        @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(1); } }
        .success-msg { animation: bounceIn 0.5s; font-size: 1.3rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); }

        .calculator-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .result-box { background: #e9ecef; padding: 20px; border-radius: 10px; margin-top: 20px; display: none; }
        .calc-row { background: #f1f3f5; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .calc-label { font-weight: bold; color: #198754; font-size: 1.1rem; margin-bottom: 5px; display: block;}
        .calc-input-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .calc-input-group div { flex: 1; min-width: 140px; }
        .calc-result-input { font-weight: bold; color: #d9534f; text-align: center; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <h3 class="text-success fw-bold mb-4">Kaza NamazÄ± Takip</h3>
        <p class="text-secondary mb-4">Verilerinize eriÅŸmek iÃ§in gÃ¼venli giriÅŸ yapÄ±n.</p>
        <button class="btn btn-outline-dark w-100 py-2 fw-bold" onclick="loginWithGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" class="me-2">
            Google ile GiriÅŸ Yap
        </button>
    </div>
</div>

<div id="app-wrapper" class="wrapper hidden">
    <nav id="sidebar">
        <div class="sidebar-header">
            <h3>Kaza Takip</h3>
            <div id="sidebarUserInfo" class="small mt-2 text-white-50">...</div>
        </div>
        <ul class="list-unstyled components">
            <li id="menu-dashboard" class="active" onclick="showSection('dashboard')"><i class="fas fa-home me-2"></i> Ana Sayfa</li>
            <li id="menu-calculator" onclick="showSection('calculator')"><i class="fas fa-calculator me-2"></i> Hesap SihirbazÄ±</li>
            <li onclick="forceResetData()" class="text-warning"><i class="fas fa-wrench me-2"></i> Verileri Onar</li>
            <li onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Ã‡Ä±kÄ±ÅŸ Yap</li>
        </ul>
    </nav>

    <div id="content">
        <button type="button" id="sidebarCollapse" class="btn btn-success mb-3 d-md-none"><i class="fas fa-bars"></i> MenÃ¼</button>

        <!-- BÃ–LÃœM 1: ANA SAYFA -->
        <div id="section-dashboard">
            <h2 class="app-header">Namaz Takip Paneli</h2>
            
            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6">
                    <div id="goalCard" class="goal-card text-center">
                        <h4>ğŸ¯ GÃ¼nlÃ¼k Hedef</h4>
                        <div class="d-flex justify-content-center align-items-center gap-2 mt-3 mb-2">
                            <span style="font-size: 1.2rem;">BugÃ¼n</span>
                            <strong style="font-size: 2rem;" id="dailyCountDisplay">0</strong>
                            <span style="font-size: 1.2rem;">/</span>
                            <input type="number" id="dailyGoalInput" class="goal-input" value="10" onchange="updateDailyGoal(this.value)">
                            <span style="font-size: 1.2rem;">Kaza</span>
                        </div>
                        <div class="progress mt-2" style="height: 10px; background-color: rgba(255,255,255,0.3);">
                            <div id="dailyProgressBar" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="goalSuccessMessage" class="success-msg mt-2 fw-bold text-white" style="display: none;">
                            ğŸ‰ GÃ¼nlÃ¼k Hedefe UlaÅŸÄ±ldÄ±!
                        </div>
                        <small id="goalDefaultText" class="text-white-50 mt-1 d-block">BugÃ¼n iÃ§inde yapmadÄ±ÄŸÄ±nÄ±z iÅŸlemler hedefi etkilemez.</small>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-center gap-3 mb-3 flex-wrap">
                <div><label class="fw-bold text-secondary">BaÅŸlama:</label> <input type="date" id="startDate" class="form-control d-inline-block w-auto text-center fw-bold"></div>
                <div><label class="fw-bold text-secondary">GÃ¼n:</label> <input type="text" id="elapsedDays" class="form-control d-inline-block w-auto text-center fw-bold" readonly></div>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered main-table">
                    <thead>
                        <tr>
                            <th>Namaz</th>
                            <th style="width: 15%;">KÄ±lÄ±nacak</th>
                            <th style="width: 20%;">KÄ±lÄ±nan</th>
                            <th>Ä°ÅŸlem</th>
                            <th>Ort. Namaz</th>
                            <th>Kalan SÃ¼re</th>
                        </tr>
                    </thead>
                    <tbody id="prayerTableBody"></tbody>
                    <tfoot id="prayerTableFoot"></tfoot>
                </table>
            </div>

            <div class="row mt-4 justify-content-center">
                <div class="col-md-6 col-lg-5 mb-3">
                    <div class="chart-container">
                        <h5 class="text-center text-secondary mb-3">Genel Tamamlanma Durumu</h5>
                        <canvas id="completionChart" style="max-height: 280px;"></canvas>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4"><h4 class="text-secondary fw-bold">ğŸ† Rozet MÃ¼zesi</h4></div>
            <div class="badge-container" id="badgeContainer"></div>

            <h4 class="text-center text-secondary fw-bold mt-4" style="font-size: 0.9rem;">Son DeÄŸiÅŸiklikler</h4>
            <div class="table-responsive">
                <table class="table table-bordered text-center" style="font-size: 0.8rem;">
                    <thead><tr class="table-light"><th>Namaz</th><th>Ã–nceki</th><th>Son</th><th>Zaman</th></tr></thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- BÃ–LÃœM 2: DETAYLI HESAPLAMA SÄ°HÄ°RBAZI -->
        <div id="section-calculator" class="hidden">
            <h2 class="app-header">DetaylÄ± Hesap SihirbazÄ±</h2>
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="calculator-card">
                        <div class="alert alert-info small">
                            <i class="fas fa-info-circle me-1"></i> 
                            LÃ¼tfen ilgili namazÄ±n satÄ±rÄ±na tarihleri girin. "Hesaplanan GÃ¼n" otomatik Ã§Ä±kacaktÄ±r.
                            <br><strong>Ä°pucu:</strong> Ä°lk satÄ±rÄ± (Sabah) doldurduktan sonra aÅŸaÄŸÄ±daki butonlarla diÄŸerlerine kopyalayabilirsiniz.
                        </div>

                        <div class="d-flex justify-content-end gap-2 mb-3 flex-wrap">
                            <button class="btn btn-sm btn-outline-info" onclick="copyStartDate()">
                                <i class="fas fa-arrow-down me-1"></i> Sorumluluk Tarihini DaÄŸÄ±t
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="copyEndDate()">
                                <i class="fas fa-arrow-down me-1"></i> DÃ¼zenli BaÅŸlamayÄ± DaÄŸÄ±t
                            </button>
                        </div>

                        <div id="calcRowsContainer"></div>

                        <hr class="my-4">
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Dikkat:</strong> "HesaplananlarÄ± Aktar" butonuna bastÄ±ÄŸÄ±nÄ±zda, Ana Sayfa'daki "KÄ±lÄ±nacak" sayÄ±larÄ±nÄ±z buradaki deÄŸerlerle <u>deÄŸiÅŸtirilecektir.</u>
                        </div>

                        <button class="btn btn-danger w-100 py-2 fw-bold" onclick="applyAdvancedCalculation()">
                            <i class="fas fa-check-circle me-2"></i> OnaylÄ±yorum ve HesaplananlarÄ± Aktar
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    document.getElementById('sidebarCollapse').addEventListener('click', function () {
        document.getElementById('sidebar').classList.toggle('active');
    });

    function showSection(sectionId) {
        document.querySelectorAll('#sidebar ul li').forEach(li => li.classList.remove('active'));
        document.getElementById('menu-' + sectionId).classList.add('active');
        document.getElementById('section-dashboard').classList.add('hidden');
        document.getElementById('section-calculator').classList.add('hidden');
        document.getElementById('section-' + sectionId).classList.remove('hidden');
        if(window.innerWidth < 768) { document.getElementById('sidebar').classList.remove('active'); }
        
        if(sectionId === 'calculator') {
            renderCalculatorRows();
        }
    }

    // --- GELÄ°ÅMÄ°Å HESAPLAMA MANTIÄI ---
    const prayerTypes = ["Sabah", "Ã–ÄŸle", "Ä°kindi", "AkÅŸam", "YatsÄ±"];

    function renderCalculatorRows() {
        const container = document.getElementById('calcRowsContainer');
        if(container.innerHTML.trim() !== "") return;

        let html = "";
        prayerTypes.forEach((prayer, index) => {
            html += `
            <div class="calc-row" id="row-${index}">
                <span class="calc-label">${prayer}</span>
                <div class="calc-input-group">
                    <div>
                        <small class="text-muted">Sorumluluk BaÅŸlangÄ±cÄ±</small>
                        <input type="date" class="form-control start-date" onchange="calculateRow(${index})">
                    </div>
                    <div>
                        <small class="text-muted">DÃ¼zenli BaÅŸlama</small>
                        <input type="date" class="form-control end-date" onchange="calculateRow(${index})">
                    </div>
                    <div>
                        <small class="text-muted">Hesaplanan GÃ¼n</small>
                        <input type="number" class="form-control calc-result-input" id="res-${index}" value="0">
                    </div>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    }

    function calculateRow(index) {
        const row = document.getElementById(`row-${index}`);
        const startVal = row.querySelector('.start-date').value;
        const endVal = row.querySelector('.end-date').value;
        const resInput = document.getElementById(`res-${index}`);

        if(startVal && endVal) {
            const d1 = new Date(startVal);
            const d2 = new Date(endVal);
            
            if(d1 < d2) {
                const diff = Math.ceil(Math.abs(d2 - d1) / (1000 * 60 * 60 * 24));
                resInput.value = diff;
            } else {
                resInput.value = 0; 
            }
        }
    }

    function copyStartDate() {
        const row0 = document.getElementById('row-0');
        const start0 = row0.querySelector('.start-date').value;
        if(!start0) { alert("LÃ¼tfen Sabah namazÄ± iÃ§in Sorumluluk Tarihini girin."); return; }
        for(let i = 1; i < 5; i++) {
            const row = document.getElementById(`row-${i}`);
            row.querySelector('.start-date').value = start0;
            calculateRow(i);
        }
    }

    function copyEndDate() {
        const row0 = document.getElementById('row-0');
        const end0 = row0.querySelector('.end-date').value;
        if(!end0) { alert("LÃ¼tfen Sabah namazÄ± iÃ§in DÃ¼zenli BaÅŸlama Tarihini girin."); return; }
        for(let i = 1; i < 5; i++) {
            const row = document.getElementById(`row-${i}`);
            row.querySelector('.end-date').value = end0;
            calculateRow(i);
        }
    }

    function applyAdvancedCalculation() {
        let newValues = [];
        for(let i = 0; i < 5; i++) {
            const val = parseInt(document.getElementById(`res-${i}`).value) || 0;
            newValues.push(val);
        }

        if(newValues.every(v => v === 0)) {
            alert("Hesaplanan deÄŸerler 0 gÃ¶rÃ¼nÃ¼yor. LÃ¼tfen tarihleri kontrol edin.");
            return;
        }

        if(confirm("Bu deÄŸerler ana sayfanÄ±zdaki hedeflerin Ã¼zerine yazÄ±lacak. OnaylÄ±yor musunuz?")) {
            ensureDataStructure();
            
            localData.counts[0].target = newValues[0];
            localData.counts[1].target = newValues[1];
            localData.counts[2].target = newValues[2];
            localData.counts[3].target = newValues[3];
            localData.counts[4].target = newValues[4];
            
            saveToCloud();
            alert("Hedefler baÅŸarÄ±yla gÃ¼ncellendi!");
            showSection('dashboard');
        }
    }

    // --- STANDART JS KODLARI ---
    const pwaIcon = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23198754' d='M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256 256-114.6 256-256S401.4 0 256 0zm-46.8 389L68.6 248.4c-4.7-4.7-4.7-12.3 0-17l28.3-28.3c4.7-4.7 12.3-4.7 17 0L209.2 298l188.8-188.8c4.7-4.7 12.3-4.7 17 0l28.3 28.3c4.7 4.7 4.7 12.3 0 17L226.2 389c-4.7 4.7-12.3 4.7-17 0z'/%3E%3C/svg%3E";
    const manifestBlob = new Blob([JSON.stringify({
        "name": "Kaza NamazÄ±", "short_name": "Namaz Takip", "start_url": ".", "display": "standalone",
        "background_color": "#f8f9fa", "theme_color": "#198754",
        "icons": [{ "src": pwaIcon, "sizes": "192x192", "type": "image/svg+xml" }]
    })], {type: 'application/json'});
    document.querySelector('#my-manifest').href = URL.createObjectURL(manifestBlob);
    
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register(URL.createObjectURL(new Blob([`self.addEventListener('install',e=>e.waitUntil(self.skipWaiting()));self.addEventListener('activate',e=>e.waitUntil(self.clients.claim()));self.addEventListener('fetch',e=>{})`], {type: 'application/javascript'})));
    }

    Chart.register(ChartDataLabels);
    const jsConfetti = new JSConfetti();

    // FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyC7zdr3x8H--8piHR_1muAz2TVOOaebI54",
        authDomain: "kazanamazi-ser.firebaseapp.com",
        databaseURL: "https://kazanamazi-ser-default-rtdb.firebaseio.com",
        projectId: "kazanamazi-ser",
        storageBucket: "kazanamazi-ser.firebasestorage.app",
        messagingSenderId: "951730390034",
        appId: "1:951730390034:web:639f96ee859c10b0e944cb",
        measurementId: "G-5WGCDTL1RX"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();

    let dbRef = null;
    const BADGES = [
        { id: 1000, title: "BaÅŸlangÄ±Ã§", icon: "ğŸ—ï¸", desc: "1.000 Namaz" },
        { id: 5000, title: "Ä°stikrar", icon: "ğŸ–ï¸", desc: "5.000 Namaz" },
        { id: 10000, title: "YÄ±ldÄ±z", icon: "â­", desc: "10.000 Namaz" },
        { id: 25000, title: "Åampiyon", icon: "ğŸ†", desc: "25.000 Namaz" },
        { id: 50000, title: "Efsane", icon: "ğŸ‘‘", desc: "50.000 Namaz" }
    ];

    // VarsayÄ±lan Veri
    function getCurrentDateSimple() { const d = new Date(); return d.toLocaleDateString('tr-TR'); }
    
    const defaultData = {
        startDate: "2022-11-22",
        daily: { date: getCurrentDateSimple(), counts: [0, 0, 0, 0, 0], target: 10 }, 
        counts: [
            { name: "Sabah", target: 0, done: 0 },
            { name: "Ã–ÄŸle", target: 0, done: 0 },
            { name: "Ä°kindi", target: 0, done: 0 },
            { name: "AkÅŸam", target: 0, done: 0 },
            { name: "YatsÄ±", target: 0, done: 0 }
        ],
        earnedBadges: [],
        history: [] 
    };

    let localData = JSON.parse(JSON.stringify(defaultData));
    let chartCompletion = null;

    function ensureDataStructure() {
        const prayerNames = ["Sabah", "Ã–ÄŸle", "Ä°kindi", "AkÅŸam", "YatsÄ±"];
        if (!localData.counts || !Array.isArray(localData.counts) || localData.counts.length !== 5) {
            localData.counts = prayerNames.map(name => ({ name: name, target: 0, done: 0 }));
        } else {
            localData.counts.forEach((item, index) => {
                if (!item.name) item.name = prayerNames[index];
                if (typeof item.target === 'undefined') item.target = 0;
                if (typeof item.done === 'undefined') item.done = 0;
            });
        }
        const todayStr = getCurrentDateSimple();
        if (!localData.daily) { localData.daily = { date: todayStr, counts: [0,0,0,0,0], target: 10 }; } 
        else if (!localData.daily.counts) { localData.daily.counts = [0,0,0,0,0]; localData.daily.date = todayStr; }
        if (!localData.history) localData.history = [];
        if (!localData.earnedBadges) localData.earnedBadges = [];
        if (!localData.startDate) { const now = new Date(); localData.startDate = now.toISOString().split('T')[0]; }
    }

    function forceResetData() {
        if(confirm("DÄ°KKAT: Bu iÅŸlem mevcut verileriniz bozuksa onarÄ±r. Emin misiniz?")) {
            ensureDataStructure();
            saveToCloud();
            renderApp();
            alert("Veriler onarÄ±ldÄ±.");
        }
    }

    auth.onAuthStateChanged((user) => {
        if (user) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-wrapper').classList.remove('hidden');
            document.getElementById('sidebarUserInfo').innerText = "Merhaba, " + user.displayName.split(' ')[0];
            dbRef = db.ref('users/' + user.uid + '/namazData');
            listenToData();
        } else {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-wrapper').classList.add('hidden');
            dbRef = null;
        }
    });

    function loginWithGoogle() { auth.signInWithPopup(provider).catch((error) => alert("GiriÅŸ HatasÄ±: " + error.message)); }
    function logout() { auth.signOut(); }
    function saveToCloud() { if (dbRef) dbRef.set(localData); }

    function listenToData() {
        dbRef.on('value', (snapshot) => {
            const cloudData = snapshot.val();
            if (cloudData) {
                localData = cloudData;
            } 
            ensureDataStructure();
            checkDailyReset();
            if (!cloudData) saveToCloud(); 
            renderApp();
        });
    }

    const startDateInput = document.getElementById("startDate");
    const elapsedDaysInput = document.getElementById("elapsedDays");
    const tableBody = document.getElementById("prayerTableBody");
    const tableFoot = document.getElementById("prayerTableFoot");
    const historyBody = document.getElementById("historyTableBody");
    const dailyCountDisplay = document.getElementById("dailyCountDisplay");
    const dailyGoalInput = document.getElementById("dailyGoalInput");
    const dailyProgressBar = document.getElementById("dailyProgressBar");
    const goalSuccessMessage = document.getElementById("goalSuccessMessage");
    const goalDefaultText = document.getElementById("goalDefaultText");
    const goalCard = document.getElementById("goalCard");
    const badgeContainer = document.getElementById("badgeContainer");

    function checkDailyReset() {
        const todayStr = getCurrentDateSimple();
        if (localData.daily.date !== todayStr) {
            localData.daily.date = todayStr; localData.daily.counts = [0, 0, 0, 0, 0]; saveToCloud();
        }
    }
    window.updateDailyGoal = function(val) { if (!dbRef) return; localData.daily.target = parseInt(val) || 1; saveToCloud(); }

    function processDailyChange(index, delta) {
        if (delta > 0) {
            localData.daily.counts[index] = (localData.daily.counts[index] || 0) + 1;
            const currentTotal = localData.daily.counts.reduce((a, b) => a + b, 0);
            if (currentTotal === localData.daily.target) {
                jsConfetti.addConfetti({ emojis: ['ğŸ‰', 'âœ¨', 'â­', 'ğŸ†'], confettiNumber: 80 });
            }
        } else {
            if (localData.daily.counts[index] > 0) localData.daily.counts[index]--;
        }
        checkBadges();
        saveToCloud();
    }
    
    function checkBadges() {
        let totalDone = 0;
        localData.counts.forEach(c => totalDone += parseInt(c.done));
        let newBadgeEarned = false;
        BADGES.forEach(badge => {
            if (totalDone >= badge.id && !localData.earnedBadges.includes(badge.id)) {
                localData.earnedBadges.push(badge.id);
                newBadgeEarned = true;
                jsConfetti.addConfetti({ emojis: ['ğŸ†', 'ğŸ‘‘', 'ğŸ’', 'ğŸ¥‡'], confettiNumber: 200 });
                alert(`TEBRÄ°KLER! ${badge.title} Rozetini KazandÄ±n! ğŸ†`);
            }
        });
        if (newBadgeEarned) saveToCloud();
    }

    function renderDailySection() {
        const currentTotal = localData.daily.counts ? localData.daily.counts.reduce((a, b) => a + b, 0) : 0;
        dailyCountDisplay.innerText = currentTotal;
        dailyGoalInput.value = localData.daily.target;
        let percent = (currentTotal / localData.daily.target) * 100;
        if (percent > 100) percent = 100;
        dailyProgressBar.style.width = percent + "%";
        
        if (currentTotal >= localData.daily.target) { 
            dailyProgressBar.classList.remove('bg-warning'); dailyProgressBar.classList.add('bg-success');
            goalSuccessMessage.style.display = "block"; goalDefaultText.style.display = "none"; goalCard.classList.add("success-mode");
        } else { 
            dailyProgressBar.classList.add('bg-warning'); dailyProgressBar.classList.remove('bg-success');
            goalSuccessMessage.style.display = "none"; goalDefaultText.style.display = "block"; goalCard.classList.remove("success-mode");
        }
    }

    function renderBadges() {
        badgeContainer.innerHTML = "";
        let totalDone = 0;
        localData.counts.forEach(c => totalDone += parseInt(c.done));
        let anyBadge = false;
        BADGES.forEach(badge => {
            if (totalDone >= badge.id) {
                anyBadge = true;
                const div = document.createElement("div");
                div.className = "badge-item unlocked";
                div.innerHTML = `<span class="badge-icon">${badge.icon}</span><div class="badge-title">${badge.title}</div>`;
                badgeContainer.appendChild(div);
            }
        });
        if (!anyBadge) { badgeContainer.innerHTML = `<div class="text-muted small">HenÃ¼z kazanÄ±lmÄ±ÅŸ rozet yok. KÄ±lmaya devam edin!</div>`; }
    }

    function getElapsedDays() {
        if (!localData.startDate) return 1;
        const start = new Date(localData.startDate);
        const now = new Date(); start.setHours(0,0,0,0); now.setHours(0,0,0,0);
        const diffTime = Math.abs(now - start);
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) || 1; 
    }
    function formatTimeEstimator(days) {
        if (!isFinite(days) || days < 0) return "TamamlandÄ±";
        const years = Math.floor(days / 365); const rem = days % 365;
        const months = Math.floor(rem / 30); const finalDays = Math.floor(rem % 30);
        let result = "";
        if (years > 0) result += `${years} YÄ±l `;
        if (months > 0) result += `${months} Ay `;
        if (years === 0 && months === 0) result += `${finalDays} GÃ¼n`;
        else if (finalDays > 0 && years < 10) result += `${finalDays} G.`;
        return result || "BugÃ¼n";
    }
    function getCurrentTime() { return new Date().toLocaleString('tr-TR'); }

    function addHistory(namazName, oldVal, newVal) {
        const record = { namaz: namazName, oldVal: parseInt(oldVal), newVal: parseInt(newVal), time: getCurrentTime() };
        if (!localData.history) localData.history = [];
        localData.history.unshift(record);
        if (localData.history.length > 20) localData.history.pop(); 
        saveToCloud();
    }

    function renderApp() {
        if(!localData || !localData.counts) return;

        startDateInput.value = localData.startDate;
        renderDailySection();
        renderBadges();
        const elapsed = getElapsedDays(); elapsedDaysInput.value = elapsed;
        tableBody.innerHTML = "";
        
        let totalTarget = 0; let totalDone = 0; let totalRemaining = 0;
        localData.counts.forEach((item, index) => {
            const remaining = item.target - item.done;
            const avg = (item.done / elapsed).toFixed(2);
            const estDays = avg > 0 ? Math.ceil(remaining / avg) : 0;
            const estText = avg > 0 ? formatTimeEstimator(estDays) : "-";
            totalTarget += parseInt(item.target); totalDone += parseInt(item.done); totalRemaining += remaining;
            
            let percent = item.target > 0 ? (item.done / item.target) * 100 : 0;
            const row = document.createElement("tr");
            row.innerHTML = `
                <td class="col-namaz" style="background-color: #e0c09f;">${item.name}</td>
                <td><input type="number" class="form-control form-control-sm" value="${item.target}" onchange="updateTarget(${index}, this.value)"></td>
                <td>
                    <input type="number" class="form-control form-control-sm mb-1" value="${item.done}" onchange="updateDoneManual(${index}, this.value)">
                    <div class="progress" style="height: 6px; background-color: #d1e7dd;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: ${percent}%"></div>
                    </div>
                    <div class="text-success small fw-bold mt-1" style="font-size: 11px;">%${percent.toFixed(1)}</div>
                </td>
                <td>
                    <button class="btn-action btn-plus" onclick="changeCount(${index}, 1)">+</button>
                    <button class="btn-action btn-minus" onclick="changeCount(${index}, -1)">-</button>
                </td>
                <td>${avg}</td>
                <td class="small">${estText}</td>
            `;
            tableBody.appendChild(row);
        });

        const overallAvg = (totalDone / elapsed).toFixed(2);
        const overallEstDays = overallAvg > 0 ? Math.ceil(totalRemaining / overallAvg) : 0;
        const overallEstText = overallAvg > 0 ? formatTimeEstimator(overallEstDays) : "-";

        tableFoot.innerHTML = `
            <tr>
                <td>Toplam</td>
                <td>${totalTarget}</td>
                <td>${totalDone}</td>
                <td style="background-color: #f8f9fa; border: none;"></td>
                <td>${overallAvg}</td>
                <td class="small">${overallEstText}</td>
            </tr>
        `;
        renderHistory();
        renderCharts(totalDone, totalRemaining);
    }

    function renderHistory() {
        historyBody.innerHTML = "";
        if (!localData.history) return;
        localData.history.forEach(rec => {
            const row = document.createElement("tr");
            const oldV = parseFloat(rec.oldVal); const newV = parseFloat(rec.newVal);
            if (newV > oldV) { row.classList.add('history-row-up'); } 
            else if (newV < oldV) { row.classList.add('history-row-down'); }
            row.innerHTML = `<td>${rec.namaz}</td><td>${rec.oldVal}</td><td>${rec.newVal}</td><td>${rec.time.split(' ')[1]}</td>`;
            historyBody.appendChild(row);
        });
    }

    function renderCharts(totalDone, totalRemaining) {
        const ctx1 = document.getElementById('completionChart').getContext('2d');
        if (chartCompletion) chartCompletion.destroy(); 
        chartCompletion = new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: ['KÄ±lÄ±nan', 'Kalan'],
                datasets: [{ data: [totalDone, totalRemaining], backgroundColor: ['#198754', '#d9534f'], borderWidth: 1 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    datalabels: { color: '#fff', font: { weight: 'bold', size: 14 }, formatter: (value, ctx) => { let sum = 0; ctx.chart.data.datasets[0].data.map(d => sum += d); return (value*100 / sum).toFixed(1)+"%"; } }
                }
            }
        });
    }

    window.updateTarget = function(index, value) { if (!dbRef) return; localData.counts[index].target = parseInt(value) || 0; saveToCloud(); }
    window.updateDoneManual = function(index, value) { if (!dbRef) return; const oldVal = localData.counts[index].done; const newVal = parseInt(value) || 0; if (oldVal !== newVal) { localData.counts[index].done = newVal; addHistory(localData.counts[index].name, oldVal, newVal); checkBadges(); } }
    window.changeCount = function(index, delta) { if (!dbRef) return; const oldVal = localData.counts[index].done; const newVal = oldVal + delta; if (newVal >= 0) { localData.counts[index].done = newVal; addHistory(localData.counts[index].name, oldVal, newVal); processDailyChange(index, delta); } }
    startDateInput.addEventListener("change", (e) => { if (!dbRef) return; localData.startDate = e.target.value; saveToCloud(); });

</script>
</body>
</html>
