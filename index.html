<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Ä°badet Takip & Namaz Vakti</title>
    
    <meta name="theme-color" content="#198754">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" id="my-manifest">

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Amiri:wght@700&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <!-- Grafikler -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>

    <style>
        /* --- TEMA AYARLARI --- */
        :root { 
            --bg-color: #e3e6ec; --text-color: #212529; --card-bg: #ffffff; --sidebar-bg: #157347; 
            --table-head: #157347; --table-row-bg: #ffffff; --input-bg: #f8f9fa; --input-text: #000000; 
            --border-color: #ced4da; --modal-bg: #ffffff;
            --col-namaz-bg: #5a826e; --col-namaz-text: #ffffff;
            --table-foot-bg: #1f3b2f; --table-foot-border: #142921;
            --z-btn-minus-bg: #e9ecef; --z-btn-minus-text: #495057;
            --z-btn-reset-bg: #fff3cd; --z-btn-reset-text: #856404;
            --z-btn-plus-bg: linear-gradient(145deg, #198754, #20c997);
            --scroll-track: #e9ecef; --scroll-thumb: #ced4da;
            --box-target-bg: #e8f5e9; --box-target-border: #c3e6cb; --box-target-text: #155724;
            --box-add-bg: #e7f1ff; --box-add-border: #b6d4fe;
            --stat-avg-color: #6610f2;
        }
        body.dark-mode { 
            --bg-color: #121212; --text-color: #e0e0e0; --card-bg: #1e1e1e; --sidebar-bg: #0f5132; 
            --table-head: #0f5132; --table-row-bg: #2d2d2d; --input-bg: #3a3a3a; --input-text: #ffffff; 
            --border-color: #444; --modal-bg: #2d2d2d;
            --col-namaz-bg: #1e3b2e; --col-namaz-text: #e0e0e0;
            --table-foot-bg: #0b1a15; --table-foot-border: #050d0a;
            --z-btn-minus-bg: #343a40; --z-btn-minus-text: #ced4da;
            --z-btn-reset-bg: #3e2c00; --z-btn-reset-text: #ffc107;
            --z-btn-plus-bg: linear-gradient(145deg, #0f5132, #146c43);
            --scroll-track: #2d2d2d; --scroll-thumb: #555;
            --box-target-bg: #0f2e1c; --box-target-border: #146c43; --box-target-text: #75b798;
            --box-add-bg: #052c65; --box-add-border: #084298;
            --stat-avg-color: #d63384; 
        }
        
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Poppins', sans-serif; transition: 0.3s; overflow-x: hidden; min-height: 100vh; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s ease, visibility 0.5s; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(25, 135, 84, 0.2); border-top-color: #198754; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 15px; font-weight: 600; color: #198754; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* SIDEBAR & LAYOUT */
        .wrapper { display: flex; width: 100%; }
        #sidebar { min-width: 260px; max-width: 260px; background: var(--sidebar-bg); color: #fff; height: 100vh; transition: 0.3s; z-index: 2000; position: fixed; top: 0; left: 0; overflow-y: auto; margin-left: -260px; }
        #overlay { display: none; position: fixed; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 1999; top: 0; left: 0; backdrop-filter: blur(2px); }
        #overlay.active { display: block; }
        #sidebar.active { margin-left: 0; }
        @media (min-width: 769px) { #sidebar { position: sticky; margin-left: 0; height: 100vh; z-index: 1050; } #sidebar.active { margin-left: -260px; } #overlay { display: none !important; } #content { width: calc(100% - 260px); margin-left: 0; } }
        @media (max-width: 768px) { #content { width: 100%; } }
        #sidebar ul li { padding: 15px; cursor: pointer; border-left: 5px solid transparent; transition: 0.2s; }
        #sidebar ul li:hover { background: rgba(255,255,255,0.1); }
        #sidebar ul li.active { background: rgba(255,255,255,0.2); border-left-color: #fff; font-weight: 600; }
        #content { padding: 20px; min-height: 100vh; transition: 0.3s; width: 100%; max-width: 900px; margin: 0 auto; }
        .app-header { text-align: center; color: var(--sidebar-bg); font-weight: 600; margin-bottom: 25px; font-size: 1.5rem; }
        body.dark-mode .app-header { color: #20c997; }

        /* KARTLAR VE TABLO */
        .card-common { border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.06); background-color: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); }
        .login-card, .goal-card, .zikr-card, .chart-container, .calculator-card, .settings-card, .prediction-card, .stat-card { @extend .card-common; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.06); background-color: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); }
        #login-screen { height: 100vh; display: flex; justify-content: center; align-items: center; background-color: var(--bg-color); }
        .chart-container { padding: 20px; margin-bottom: 20px; text-align: center; }
        .goal-card { background: linear-gradient(135deg, #198754, #20c997); color: white; padding: 20px; margin-bottom: 20px; text-align: center; }
        .goal-card.success-mode { border: 3px solid #ffc107; }
        .goal-input { width: 70px; text-align: center; font-weight: bold; border: none; border-radius: 5px; color: #198754; background: white; }
        
        .table-responsive { border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; overflow-x: auto; width: 100%; display: block; }
        .main-table { color: var(--text-color); font-size: 0.85rem; width: 100%; border-collapse: collapse; min-width: 650px; }
        .main-table th { background-color: var(--table-head); color: white; text-align: center; padding: 12px 5px; border: 1px solid var(--border-color); }
        .main-table td { background-color: var(--table-row-bg); color: var(--text-color); border: 1px solid var(--border-color); text-align: center; padding: 10px 5px; vertical-align: middle; }
        .table-input { text-align: center; background: var(--input-bg); color: var(--input-text); border: 1px solid var(--border-color); width: 100%; height: 38px; border-radius: 8px; }
        .col-namaz { background-color: var(--col-namaz-bg) !important; color: var(--col-namaz-text) !important; font-weight: 600; min-width: 80px; }
        .btn-action { width: 38px; height: 38px; border-radius: 8px; border: none; color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-plus { background-color: #198754; } .btn-minus { background-color: #6c757d; }
        
        /* WIDGET TASARIMI */
        .prayer-widget-card { background: linear-gradient(145deg, #252438, #1e1d2b); color: white; border-radius: 20px; padding: 20px; margin-bottom: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); font-family: 'Poppins', sans-serif; border: 1px solid rgba(255,255,255,0.1); width: 100%; position: relative; overflow: hidden; }
        .pw-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .pw-location { font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 8px; text-transform: uppercase; }
        .pw-date { font-size: 0.8rem; opacity: 0.7; margin-top: 4px; font-weight: 400; }
        .btn-change-city { background: rgba(255,255,255,0.1); border: none; color: white; border-radius: 8px; padding: 4px 10px; font-size: 0.7rem; cursor: pointer; }
        .pw-timer-area { background: rgba(255,255,255,0.05); border-radius: 15px; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .pw-next-name { font-size: 2rem; font-weight: 700; line-height: 1; text-transform: uppercase; }
        .pw-label { font-size: 0.85rem; opacity: 0.8; margin-top: 5px; }
        .pw-countdown { font-size: 2.5rem; font-weight: 400; letter-spacing: 2px; font-variant-numeric: tabular-nums; }
        .pw-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .pw-box { background: rgba(255,255,255,0.08); border-radius: 12px; padding: 12px 10px; display: flex; flex-direction: column; align-items: flex-start; justify-content: center; position: relative; border: 1px solid rgba(255,255,255,0.05); transition: 0.3s; }
        .pw-box-label { font-size: 0.7rem; text-transform: uppercase; opacity: 0.6; font-weight: 600; }
        .pw-box-time { font-size: 1.3rem; font-weight: 600; }
        .pw-box-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 1.2rem; opacity: 0.3; }
        .pw-box.active { background: #e67e22; color: white; border-color: #e67e22; box-shadow: 0 5px 15px rgba(230, 126, 34, 0.4); }
        .pw-box.active .pw-box-label { opacity: 0.9; } .pw-box.active .pw-box-icon { opacity: 0.8; }
        
        /* MOBÄ°L UYUM */
        @media (max-width: 400px) { .pw-next-name { font-size: 1.5rem; } .pw-countdown { font-size: 2rem; } .pw-grid { grid-template-columns: repeat(2, 1fr); } }
        .bottom-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: var(--card-bg); border-top: 1px solid var(--border-color); z-index: 1060; justify-content: space-around; align-items: center; padding-bottom: 10px; }
        .nav-item { text-align: center; color: var(--text-color); opacity: 0.6; font-size: 0.75rem; flex: 1; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .nav-item.active { color: #198754; opacity: 1; font-weight: 600; }
        .nav-item i { font-size: 1.4rem; margin-bottom: 4px; }
        @media (max-width: 768px) { .bottom-nav { display: flex; } #content { padding-bottom: 90px; } }

        /* MODAL */
        .custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .custom-modal { background: var(--modal-bg); padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; animation: popIn 0.3s ease; }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-btn { padding: 10px 25px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; }
        .btn-ok { background: #198754; color: white; width: 100%; } .btn-cancel { background: #6c757d; color: white; }
        
        /* TESBÄ°HAT, STATS vb. */
        .zikr-card { padding: 25px; text-align: center; border-top: 6px solid #198754; margin-bottom: 20px; }
        .arabic-text { font-family: 'Amiri', serif; font-size: 2.4rem; color: #198754; }
        .zikr-btn { border: none; background: transparent; cursor: pointer; }
        .z-plus { width: 90px; height: 90px; border-radius: 25px; background: linear-gradient(145deg, #198754, #20c997); color: white; font-size: 2.5rem; }
    </style>
</head>
<body>

<div id="loading-overlay"><div class="spinner"></div><div class="loading-text">YÃ¼kleniyor...</div></div>

<!-- YENÄ°: ÅžEHÄ°R SEÃ‡Ä°M DROPDOWN MODALI -->
<div id="cityModal" class="custom-modal-overlay">
    <div class="custom-modal">
        <h4 style="color:var(--text-color)">Åžehir SeÃ§imi</h4>
        <p style="color:var(--text-color)">LÃ¼tfen listeden ilinizi seÃ§iniz:</p>
        <select id="citySelect" class="form-select mb-3 text-center" style="font-weight:bold; font-size:1.1rem; padding:10px;">
            <option value="">-- YÃ¼kleniyor --</option>
        </select>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button class="modal-btn btn-cancel" onclick="document.getElementById('cityModal').style.display='none'">Ä°ptal</button>
            <button class="modal-btn btn-ok" onclick="saveCity()">Kaydet</button>
        </div>
    </div>
</div>

<div id="customModal" class="custom-modal-overlay"><div class="custom-modal"><h4 id="modalTitle">BaÅŸlÄ±k</h4><p id="modalMessage">Mesaj</p><div id="modalButtons"></div></div></div>
<div id="overlay" onclick="toggleSidebar()"></div>

<div id="login-screen">
    <div class="login-card p-5 text-center" style="max-width: 400px;">
        <h3 class="text-success fw-bold mb-4">Ä°badet Takip</h3>
        <button class="btn btn-dark w-100 py-3 rounded-pill" onclick="loginWithGoogle()"><i class="fab fa-google me-2"></i> Google ile GiriÅŸ</button>
    </div>
</div>

<div id="app-wrapper" class="wrapper" style="display:none;">
    <nav id="sidebar">
        <div class="p-4 text-center" style="background: rgba(0,0,0,0.1);"><h4 class="fw-bold"><i class="fas fa-kaaba me-2"></i>Takip</h4><small id="sidebarUserInfo" class="text-white-50">...</small></div>
        <ul class="list-unstyled components p-2">
            <li id="menu-dashboard" class="active" onclick="showSection('dashboard')"><i class="fas fa-mosque me-3"></i> Kaza NamazÄ±</li>
            <li id="menu-prayer" onclick="showSection('prayer')"><i class="fas fa-clock me-3"></i> Namaz Vakitleri</li>
            <li id="menu-stats" onclick="showSection('stats')"><i class="fas fa-chart-pie me-3"></i> Ä°statistikler</li>
            <li id="menu-tesbihat" onclick="showSection('tesbihat')"><i class="fas fa-fingerprint me-3"></i> Tesbihat</li>
            <li id="menu-calculator" onclick="showSection('calculator')"><i class="fas fa-calculator me-3"></i> Hesap SihirbazÄ±</li>
            <li id="menu-settings" onclick="showSection('settings')"><i class="fas fa-cog me-3"></i> Ayarlar</li>
            <li onclick="toggleDarkMode()"><i class="fas fa-moon me-3"></i> <span id="darkModeText">Gece Modu</span></li>
            <li onclick="logout()"><i class="fas fa-sign-out-alt me-3"></i> Ã‡Ä±kÄ±ÅŸ Yap</li>
        </ul>
    </nav>

    <div id="content">
        <!-- KAZA NAMAZI EKRANI -->
        <div id="section-dashboard">
            <div class="row justify-content-center mb-4"><div class="col-md-8 col-lg-6"><div id="goalCard" class="goal-card"><h4>ðŸŽ¯ GÃ¼nlÃ¼k Hedef</h4><div class="d-flex justify-content-center gap-2 align-items-center mt-3"><span class="fs-5">BugÃ¼n</span><strong class="fs-1" id="dailyCountDisplay">0</strong><span class="fs-5">/</span><input type="number" id="dailyGoalInput" class="goal-input" value="10" onchange="updateDailyGoal(this.value)"></div><div class="progress mt-2" style="height: 8px;"><div id="dailyProgressBar" class="progress-bar bg-warning" style="width: 0%"></div></div><div id="goalSuccessMessage" class="mt-2 fw-bold text-white" style="display: none;">ðŸŽ‰ Harika! Hedefe UlaÅŸÄ±ldÄ±!</div></div></div></div>
            <div class="table-responsive mb-4"><table class="table main-table"><thead><tr><th>Namaz</th><th>KÄ±lÄ±nacak</th><th>KÄ±lÄ±nan</th><th>Ä°ÅŸlem</th></tr></thead><tbody id="prayerTableBody"></tbody><tfoot id="prayerTableFoot"></tfoot></table></div>
            <div id="badgeContainer" class="badge-container"></div>
        </div>

        <!-- NAMAZ VAKÄ°TLERÄ° EKRANI -->
        <div id="section-prayer" style="display: none;">
            <h3 class="app-header">Namaz Vakitleri</h3>
            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6">
                    <div class="prayer-widget-card">
                        <div class="pw-header">
                            <div>
                                <div class="pw-location"><i class="fas fa-map-marker-alt"></i> <span id="pwCityName">Ä°STANBUL</span> <span style="opacity:0.5">â€¢</span> <span>TR</span></div>
                                <div class="pw-date" id="pwFullDate">YÃ¼kleniyor...</div>
                            </div>
                            <button class="btn-change-city" onclick="openCityModal()"><i class="fas fa-pen"></i></button>
                        </div>
                        <div class="pw-timer-area">
                            <div><div class="pw-next-name" id="pwActiveName">...</div><div class="pw-label">Vaktine Kalan SÃ¼re</div></div>
                            <div class="pw-countdown" id="pwCountdown">--:--:--</div>
                        </div>
                        <div class="pw-grid" id="pwGrid">
                            <!-- JS Dolduracak -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DÄ°ÄžER SEKMELER -->
        <div id="section-stats" style="display: none;">
            <h3 class="app-header">Ä°statistikler</h3>
            <div class="chart-container"><canvas id="barChart" style="max-height: 300px;"></canvas></div>
        </div>
        <div id="section-tesbihat" style="display: none;">
            <h3 class="app-header">Tesbihat</h3>
            <div class="row g-4" id="tesbihatContainer"></div>
        </div>
        <div id="section-calculator" style="display: none;">
            <h3 class="app-header">Hesaplama</h3>
            <div class="calculator-card"><p>Hesaplama araÃ§larÄ± burada olacak.</p></div>
        </div>
        <div id="section-settings" style="display: none;">
            <h3 class="app-header">Ayarlar</h3>
            <div class="row g-4 justify-content-center">
                <div class="col-md-6"><div class="settings-card text-center" onclick="openCityModal()"><i class="fas fa-map-marker-alt settings-icon text-info"></i><h5>Åžehir DeÄŸiÅŸtir</h5></div></div>
                <div class="col-md-6"><div class="settings-card text-center" onclick="confirmResetData()"><i class="fas fa-trash settings-icon text-danger"></i><h5>SÄ±fÄ±rla</h5></div></div>
            </div>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="showSection('dashboard'); activateNav(this)"><i class="fas fa-mosque"></i><span>Kaza</span></div>
    <div class="nav-item" onclick="showSection('prayer'); activateNav(this)"><i class="fas fa-clock"></i><span>Vakit</span></div>
    <div class="nav-item" onclick="showSection('stats'); activateNav(this)"><i class="fas fa-chart-pie"></i><span>Ä°statistik</span></div>
    <div class="nav-item" onclick="showSection('tesbihat'); activateNav(this)"><i class="fas fa-fingerprint"></i><span>Tesbihat</span></div>
    <div class="nav-item" onclick="toggleSidebar()"><i class="fas fa-bars"></i><span>MenÃ¼</span></div>
</div>

<script>
    const jsConfetti = new JSConfetti();
    function triggerHaptic() { if (navigator.vibrate) navigator.vibrate(10); }
    function hideLoader() { const l=document.getElementById('loading-overlay'); if(l){ l.style.opacity='0'; setTimeout(()=>l.style.visibility='hidden',500); } }
    setTimeout(hideLoader, 4000);

    const firebaseConfig = { apiKey: "AIzaSyC7zdr3x8H--8piHR_1muAz2TVOOaebI54", authDomain: "kazanamazi-ser.firebaseapp.com", databaseURL: "https://kazanamazi-ser-default-rtdb.firebaseio.com", projectId: "kazanamazi-ser", storageBucket: "kazanamazi-ser.firebasestorage.app", messagingSenderId: "951730390034", appId: "1:951730390034:web:639f96ee859c10b0e944cb" };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();
    let dbRef = null;

    const defaultData = { city: "Istanbul", counts: [{name:"Sabah",target:0,done:0},{name:"Ã–ÄŸle",target:0,done:0},{name:"Ä°kindi",target:0,done:0},{name:"AkÅŸam",target:0,done:0},{name:"YatsÄ±",target:0,done:0}], tesbihat: [{name:"SÃ¼bhanallah",arabic:"Ø³ÙØ¨Ù’Ø­ÙŽØ§Ù†ÙŽ Ù±Ù„Ù„ÙŽÙ‘Ù°Ù‡Ù",current:0,target:33}], daily:{target:10,counts:[0,0,0,0,0],date:""}, earnedBadges:[], history:[] };
    let localData = JSON.parse(JSON.stringify(defaultData));

    // --- AUTH ---
    auth.onAuthStateChanged((user) => {
        if (user) {
            document.getElementById('login-screen').style.display='none';
            document.getElementById('app-wrapper').style.display='flex';
            document.getElementById('sidebarUserInfo').innerText=user.displayName;
            dbRef = db.ref('users/'+user.uid+'/namazData');
            dbRef.on('value', (s)=>{
                const d=s.val();
                if(d) localData=d;
                if(!localData.city) localData.city="Istanbul";
                renderApp(); 
                populateCityDropdown(); // Åžehirleri doldur
                initPrayerWidget(); // Widget baÅŸlat
                hideLoader();
            });
        } else {
            document.getElementById('login-screen').style.display='flex';
            document.getElementById('app-wrapper').style.display='none';
            hideLoader();
        }
    });

    function loginWithGoogle(){ auth.signInWithPopup(provider).catch(e=>alert(e.message)); }
    function logout(){ auth.signOut(); }
    function saveToCloud(){ if(dbRef) dbRef.set(localData); }

    // --- UI ---
    window.showSection=function(id){
        document.querySelectorAll('.components li').forEach(l=>l.classList.remove('active'));
        document.getElementById('menu-'+id)?.classList.add('active');
        ['dashboard','prayer','stats','tesbihat','calculator','settings'].forEach(s=>document.getElementById('section-'+s).style.display='none');
        document.getElementById('section-'+id).style.display='block';
        if(window.innerWidth<768){ document.getElementById('sidebar').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); }
        
        if(id==='dashboard') renderApp();
        if(id==='prayer') initPrayerWidget(); // Widget'Ä± tetikle
        if(id==='stats') renderStats();
        if(id==='tesbihat') renderTesbihat();
    };
    function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').classList.toggle('active'); }
    function activateNav(el){ document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); el.classList.add('active'); }

    // --- KAZA MANTIÄžI ---
    function renderApp(){
        const b=document.getElementById('prayerTableBody'); b.innerHTML="";
        localData.counts.forEach((c,i)=>{
            b.innerHTML+=`<tr><td class="col-namaz">${c.name}</td><td><input type="number" class="table-input" value="${c.target}" onchange="upT(${i},this.value)"></td><td><input type="number" class="table-input" value="${c.done}" onchange="upD(${i},this.value)"></td><td class="col-action"><div class="d-flex justify-content-center gap-1"><button class="btn-action btn-plus" onclick="chC(${i},1)">+</button><button class="btn-action btn-minus" onclick="chC(${i},-1)">-</button></div></td></tr>`;
        });
        const dSum=localData.daily?.counts?.reduce((a,b)=>a+b,0)||0;
        document.getElementById('dailyCountDisplay').innerText=dSum;
        document.getElementById('dailyGoalInput').value=localData.daily?.target||10;
        let p=(dSum/(localData.daily?.target||10))*100; if(p>100)p=100;
        document.getElementById('dailyProgressBar').style.width=p+"%";
        document.getElementById('goalSuccessMessage').style.display = dSum>=localData.daily?.target ? 'block':'none';
    }
    window.upT=(i,v)=>{localData.counts[i].target=parseInt(v)||0; saveToCloud();}
    window.upD=(i,v)=>{localData.counts[i].done=parseInt(v)||0; saveToCloud();}
    window.chC=(i,v)=>{
        triggerHaptic();
        let n=localData.counts[i].done+v; 
        if(n>=0){ 
            localData.counts[i].done=n; 
            if(!localData.daily) localData.daily={counts:[0,0,0,0,0],target:10};
            if(v>0) localData.daily.counts[i]++;
            else if(localData.daily.counts[i]>0) localData.daily.counts[i]--;
            saveToCloud(); renderApp();
            if(v>0 && localData.daily.counts.reduce((a,b)=>a+b,0)===localData.daily.target) jsConfetti.addConfetti();
        }
    }
    window.updateDailyGoal=(v)=>{localData.daily.target=parseInt(v); saveToCloud(); renderApp();}

    // --- NAMAZ VAKTÄ° WIDGET MANTIÄžI (SIFIRDAN YAZILDI) ---
    // TÃ¼rkiye'nin 81 Ä°li (API Uyumlu Listesi - Ä°ngilizce Karakter)
    const citiesList = [
        "Adana","Adiyaman","Afyonkarahisar","Agri","Aksaray","Amasya","Ankara","Antalya","Ardahan","Artvin","Aydin",
        "Balikesir","Bartin","Batman","Bayburt","Bilecik","Bingol","Bitlis","Bolu","Burdur","Bursa","Canakkale","Cankiri",
        "Corum","Denizli","Diyarbakir","Duzce","Edirne","Elazig","Erzincan","Erzurum","Eskisehir","Gaziantep","Giresun",
        "Gumushane","Hakkari","Hatay","Igdir","Isparta","Istanbul","Izmir","Kahramanmaras","Karabuk","Karaman","Kars",
        "Kastamonu","Kayseri","Kilis","Kirikkale","Kirklareli","Kirsehir","Kocaeli","Konya","Kutahya","Malatya","Manisa",
        "Mardin","Mersin","Mugla","Mus","Nevsehir","Nigde","Ordu","Osmaniye","Rize","Sakarya","Samsun","Sanliurfa","Siirt",
        "Sinop","Sirnak","Sivas","Tekirdag","Tokat","Trabzon","Tunceli","Usak","Van","Yalova","Yozgat","Zonguldak"
    ];

    let prayerData = null;
    let timerInterval = null;

    function populateCityDropdown() {
        const sel = document.getElementById('citySelect');
        if(sel.options.length > 1) return; // Zaten doluysa tekrar doldurma
        citiesList.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.innerText = c.toUpperCase(); // Ekranda BÃœYÃœK gÃ¶rÃ¼nsÃ¼n
            sel.appendChild(opt);
        });
    }

    function openCityModal() {
        document.getElementById('citySelect').value = localData.city || "Istanbul";
        document.getElementById('cityModal').style.display = 'flex';
    }

    function saveCity() {
        const val = document.getElementById('citySelect').value;
        if(val) {
            localData.city = val;
            saveToCloud();
            document.getElementById('cityModal').style.display = 'none';
            initPrayerWidget();
        } else {
            alert("LÃ¼tfen bir ÅŸehir seÃ§iniz.");
        }
    }

    function initPrayerWidget() {
        if(!localData.city) localData.city = "Istanbul";
        
        // Åžehir adÄ±nÄ± ekrana bas (TÃ¼rkÃ§e karakter dÃ¼zeltmesi yapmadan direkt bÃ¼yÃ¼k yaz)
        document.getElementById('pwCityName').innerText = localData.city.toUpperCase();

        // Tarihleri Bas (Miladi ve Hicri)
        const d = new Date();
        const miladi = d.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
        let hicri = "";
        try {
            hicri = new Intl.DateTimeFormat('tr-TR-u-ca-islamic-civil', { day: 'numeric', month: 'long', year: 'numeric' }).format(d).replace('Hicri', '').trim();
        } catch(e) { hicri = ""; }
        
        document.getElementById('pwFullDate').innerText = `${miladi} â€¢ ${hicri}`;

        // Veri Ã‡ek
        fetchPrayerTimes(localData.city);
    }

    function fetchPrayerTimes(city) {
        // API'ye gÃ¶nderilecek ÅŸehir adÄ± (Listeden geldiÄŸi iÃ§in zaten dÃ¼zgÃ¼n formatta)
        const safeCity = city; 
        
        // 1. YÃ–NTEM: namaz-vakti.vercel.app (En stabili bu)
        fetch(`https://namaz-vakti.vercel.app/api/timesFromPlace?country=Turkey&region=${safeCity}&city=${safeCity}`)
            .then(res => res.json())
            .then(data => {
                // API DÃ¶nÃ¼ÅŸÃ¼: { times: { Imsak: "05:00", ... } }
                if(data && data.times) {
                    processTimes(data.times);
                } else {
                    console.log("1. API baÅŸarÄ±sÄ±z, yedek deneniyor...");
                    fetchBackup(safeCity);
                }
            })
            .catch(() => fetchBackup(safeCity));
    }

    function fetchBackup(city) {
        // 2. YÃ–NTEM: vakit.vercel.app (Diyanet Proxy)
        const d = new Date();
        const dateStr = d.toISOString().split('T')[0];
        fetch(`https://vakit.vercel.app/api/timesFromPlace?country=Turkey&region=${city}&city=${city}&date=${dateStr}&days=1&timezoneOffset=180`)
            .then(res => res.json())
            .then(data => {
                if(data && data.times && data.times[dateStr]) {
                    const arr = data.times[dateStr];
                    // Array'i Objeye Ã§evir
                    processTimes({
                        Imsak: arr[0], Gunes: arr[1], Ogle: arr[2],
                        Ikindi: arr[3], Aksam: arr[4], Yatsi: arr[5]
                    });
                }
            });
    }

    function processTimes(times) {
        prayerData = times;
        const grid = document.getElementById('pwGrid');
        grid.innerHTML = '';
        
        const map = [
            {k:'Imsak', l:'Ä°MSAK', i:'fa-cloud-sun'},
            {k:'Gunes', l:'GÃœNEÅž', i:'fa-sun'},
            {k:'Ogle', l:'Ã–ÄžLE', i:'fa-clock'},
            {k:'Ikindi', l:'Ä°KÄ°NDÄ°', i:'fa-cloud-sun-rain'},
            {k:'Aksam', l:'AKÅžAM', i:'fa-moon'},
            {k:'Yatsi', l:'YATSI', i:'fa-stars'}
        ];

        map.forEach(m => {
            grid.innerHTML += `<div class="pw-box" id="pb-${m.k}">
                <span class="pw-box-label">${m.l}</span>
                <span class="pw-box-time">${times[m.k]}</span>
                <i class="fas ${m.i} pw-box-icon"></i>
            </div>`;
        });

        startTimer();
    }

    function startTimer() {
        if(timerInterval) clearInterval(timerInterval);
        
        const update = () => {
            if(!prayerData) return;
            const now = new Date();
            const timeStr = (t) => {
                const [h,m] = t.split(':').map(Number);
                const d = new Date(); d.setHours(h,m,0,0); return d;
            };

            const schedule = {
                Imsak: timeStr(prayerData.Imsak), Gunes: timeStr(prayerData.Gunes),
                Ogle: timeStr(prayerData.Ogle), Ikindi: timeStr(prayerData.Ikindi),
                Aksam: timeStr(prayerData.Aksam), Yatsi: timeStr(prayerData.Yatsi)
            };

            let nextTime = null;
            let nextName = "";
            let currentBox = "";

            if(now < schedule.Imsak) { nextTime = schedule.Imsak; nextName = "Ä°MSAK"; currentBox = "Yatsi"; }
            else if(now < schedule.Gunes) { nextTime = schedule.Gunes; nextName = "GÃœNEÅž"; currentBox = "Imsak"; }
            else if(now < schedule.Ogle) { nextTime = schedule.Ogle; nextName = "Ã–ÄžLE"; currentBox = "Gunes"; }
            else if(now < schedule.Ikindi) { nextTime = schedule.Ikindi; nextName = "Ä°KÄ°NDÄ°"; currentBox = "Ogle"; }
            else if(now < schedule.Aksam) { nextTime = schedule.Aksam; nextName = "AKÅžAM"; currentBox = "Ikindi"; }
            else if(now < schedule.Yatsi) { nextTime = schedule.Yatsi; nextName = "YATSI"; currentBox = "Aksam"; }
            else { 
                // YatsÄ±dan sonra (Ertesi gÃ¼n imsak)
                nextTime = new Date(schedule.Imsak); 
                nextTime.setDate(nextTime.getDate()+1); 
                nextName = "Ä°MSAK"; 
                currentBox = "Yatsi"; 
            }

            document.getElementById('pwActiveName').innerText = nextName;
            
            // KutularÄ± boya
            document.querySelectorAll('.pw-box').forEach(b => b.classList.remove('active'));
            const activeEl = document.getElementById(`pb-${currentBox}`);
            if(activeEl) activeEl.classList.add('active');

            // SayaÃ§
            let diff = nextTime - now;
            if(diff < 0) diff = 0;
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            document.getElementById('pwCountdown').innerText = 
                `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        };
        update();
        timerInterval = setInterval(update, 1000);
    }

    // --- TESBÄ°HAT RENDER ---
    function renderTesbihat(){
        const c=document.getElementById('tesbihatContainer'); c.innerHTML="";
        localData.tesbihat.forEach((t,i)=>{
            c.innerHTML+=`<div class="col-md-6"><div class="zikr-card"><h5>${t.name}</h5><div class="arabic-text">${t.arabic}</div><div class="display-4 fw-bold my-3">${t.current}</div><div class="d-flex justify-content-center gap-3"><button class="zikr-btn z-plus" onclick="incTes(${i})">+</button></div></div></div>`;
        });
    }
    window.incTes=(i)=>{localData.tesbihat[i].current++; saveToCloud(); renderTesbihat(); triggerHaptic();}

    // --- Ä°STATÄ°STÄ°K ---
    let barChart=null;
    function renderStats(){
        const ctx=document.getElementById('barChart').getContext('2d');
        if(barChart) barChart.destroy();
        barChart = new Chart(ctx, {type:'bar', data:{labels:localData.counts.map(c=>c.name), datasets:[{label:'KÄ±lÄ±nan', data:localData.counts.map(c=>c.done), backgroundColor:'#198754'}]}});
    }

    // --- AYARLAR ---
    window.toggleDarkMode=()=>{document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode')?'dark':'light');}
    if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark-mode');
    window.confirmResetData=()=>{if(confirm("TÃ¼m veriler silinecek?")){ localData=defaultData; saveToCloud(); location.reload(); }}

</script>
</body>
</html>
