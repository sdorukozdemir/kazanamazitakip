<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Kaza ve Ä°badet Takip</title>
    
    <meta name="theme-color" content="#198754">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" id="my-manifest">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Amiri:wght@700&display=swap" rel="stylesheet">
    
    <!-- CSS DosyasÄ±nÄ± BaÄŸladÄ±k -->
    <link rel="stylesheet" href="style.css">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>

</head>
<body>

<!-- LOADING OVERLAY -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">Veriler YÃ¼kleniyor...</div>
</div>

<div id="customModal" class="custom-modal-overlay">
    <div class="custom-modal">
        <h4 id="modalTitle">BaÅŸlÄ±k</h4>
        <p id="modalMessage">Mesaj.</p>
        <div class="modal-btn-group" id="modalButtons"></div>
    </div>
</div>
<div id="overlay" onclick="toggleSidebar()"></div>

<div id="login-screen">
    <div class="login-card p-5 text-center" style="max-width: 400px;">
        <h3 class="text-success fw-bold mb-4">Ä°badet Takip</h3>
        <button class="btn btn-dark w-100 py-3 rounded-pill" onclick="loginWithGoogle()">
            <i class="fab fa-google me-2"></i> Google ile GiriÅŸ
        </button>
    </div>
</div>

<div id="app-wrapper" class="wrapper" style="display:none;">
    <nav id="sidebar">
        <div class="p-4 text-center" style="background: rgba(0,0,0,0.1);">
            <h4 class="fw-bold"><i class="fas fa-kaaba me-2"></i>Takip</h4>
            <small id="sidebarUserInfo" class="text-white-50">...</small>
        </div>
        <ul class="list-unstyled components p-2">
            <li id="menu-dashboard" class="active" onclick="showSection('dashboard')"><i class="fas fa-mosque me-3"></i> Kaza NamazÄ±</li>
            <li id="menu-stats" onclick="showSection('stats')"><i class="fas fa-chart-pie me-3"></i> Ä°statistikler</li>
            <li id="menu-tesbihat" onclick="showSection('tesbihat')"><i class="fas fa-fingerprint me-3"></i> Tesbihat</li>
            <li id="menu-calculator" onclick="showSection('calculator')"><i class="fas fa-calculator me-3"></i> Hesap SihirbazÄ±</li>
            <li id="menu-settings" onclick="showSection('settings')"><i class="fas fa-cog me-3"></i> Yedekleme & Ayarlar</li>
            <li onclick="toggleDarkMode()"><i class="fas fa-moon me-3"></i> <span id="darkModeText">Gece Modu</span></li>
            <li onclick="logout()"><i class="fas fa-sign-out-alt me-3"></i> Ã‡Ä±kÄ±ÅŸ Yap</li>
        </ul>
    </nav>

    <div id="content">
        <!-- DASHBOARD -->
        <div id="section-dashboard" style="display: block;">
            <div class="row justify-content-center mb-4">
                <div class="col-md-8 col-lg-6">
                    <div id="goalCard" class="goal-card">
                        <h4>ðŸŽ¯ GÃ¼nlÃ¼k Hedef</h4>
                        <div class="goal-content">
                            <span class="fs-5">BugÃ¼n</span>
                            <strong class="fs-1" id="dailyCountDisplay">0</strong>
                            <span class="fs-5">/</span>
                            <input type="number" id="dailyGoalInput" class="goal-input" value="10" onchange="updateDailyGoal(this.value)">
                            <span class="fs-5">Kaza</span>
                        </div>
                        <div class="progress mt-2" style="height: 8px; background: rgba(255,255,255,0.3); border-radius: 10px;">
                            <div id="dailyProgressBar" class="progress-bar bg-warning" style="width: 0%"></div>
                        </div>
                        <div id="goalSuccessMessage" class="mt-2 fw-bold text-white" style="display: none;">ðŸŽ‰ Harika! Hedefe UlaÅŸÄ±ldÄ±!</div>
                        <div class="mt-2 streak-box">
                            <i class="fas fa-fire text-warning"></i> <span>Zincir:</span>
                            <span id="streakValue" class="fw-bold text-warning">0</span> <span>GÃ¼n</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-center gap-3 mb-4 flex-wrap align-items-center">
                <div><label class="fw-bold text-secondary small">BAÅžLAMA TARÄ°HÄ°</label> 
                    <input type="text" id="startDate" class="form-control text-center" placeholder="gg.aa.yyyy" onfocus="(this.type='date')" onblur="(this.type='text')">
                </div>
                <div><label class="fw-bold text-secondary small">GEÃ‡EN SÃœRE (GÃœN)</label> <input type="text" id="elapsedDays" class="form-control text-center fw-bold" readonly></div>
            </div>

            <div class="table-responsive mb-4">
                <table class="table main-table">
                    <thead>
                        <tr>
                            <th>Namaz</th>
                            <th class="col-input-area">KÄ±lÄ±nacak<br>Namaz</th>
                            <th class="col-input-area">KÄ±lÄ±nan<br>Namaz</th>
                            <th class="col-action">Ä°ÅŸlem</th>
                            <th>GÃ¼nlÃ¼k<br>Ortalama</th>
                            <th>Ortalama<br>Kalan SÃ¼re</th>
                        </tr>
                    </thead>
                    <tbody id="prayerTableBody"></tbody>
                    <tfoot id="prayerTableFoot"></tfoot>
                </table>
            </div>

            <!-- TAHMÄ°NÄ° BÄ°TÄ°Åž KARTI -->
            <div class="row mt-4 justify-content-center">
                <div class="col-md-8 col-lg-6">
                    <div class="prediction-card h-100">
                        <i class="fas fa-hourglass-half prediction-icon"></i>
                        <h5 class="fw-bold">Ne Zaman Biter?</h5>
                        
                        <div id="prediction-container">
                            <!-- Hedefe GÃ¶re -->
                            <div class="mt-3">
                                <div class="prediction-date" id="estFinishDate">HesaplanÄ±yor...</div>
                                <div class="prediction-days" id="estDaysLeft">...</div>
                                <span class="prediction-sub-label">GÃ¼nlÃ¼k Hedefe GÃ¶re</span>
                            </div>

                            <!-- Ortalamaya GÃ¶re -->
                            <div class="prediction-secondary">
                                <div class="date-small" id="estFinishDateAvg">HesaplanÄ±yor...</div>
                                <div class="prediction-days" id="estDaysLeftAvg">...</div>
                                <span class="prediction-sub-label">GÃ¼nlÃ¼k OrtalamanÄ±za GÃ¶re</span>
                            </div>
                        </div>
                        <div id="prediction-success" class="text-success fw-bold mt-2" style="display:none;">ðŸŽ‰ Borcunuz bulunmamaktadÄ±r!</div>
                        
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-4"><h5 class="fw-bold text-secondary"><i class="fas fa-trophy text-warning me-2"></i>Rozet MÃ¼zesi</h5></div>
            <div id="badgeContainer" class="badge-container"></div>

            <h5 class="text-center fw-bold mt-4 text-secondary">Son Ä°ÅŸlemler</h5>
            <div class="table-responsive">
                <table class="table table-bordered text-center" style="font-size: 0.8rem;">
                    <thead><tr class="table-light"><th>Namaz</th><th>Ã–nceki</th><th>Son</th><th>Zaman</th></tr></thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Ä°STATÄ°STÄ°KLER -->
        <div id="section-stats" style="display: none;">
            <h3 class="app-header">Ä°statistikler & Analiz</h3>
            
            <div class="scrolling-wrapper mb-4">
                <!-- GÃ¼nlÃ¼k Ortalama (Rengi dÃ¼zeltildi) -->
                <div class="stat-card-scroll">
                    <div class="stat-number" id="statAverage">0</div>
                    <div class="stat-label">GÃ¼nlÃ¼k Ortalama</div>
                </div>
                <div class="stat-card-scroll">
                    <div class="stat-number text-primary" id="statWeekly">0</div>
                    <div class="stat-label">Son Hafta</div>
                </div>
                <div class="stat-card-scroll">
                    <div class="stat-number text-success" id="statMonthly">0</div>
                    <div class="stat-label">Son Ay</div>
                </div>
                <div class="stat-card-scroll">
                    <div class="stat-number text-info" id="stat3Months">0</div>
                    <div class="stat-label">Son 3 Ay</div>
                </div>
                <div class="stat-card-scroll">
                    <div class="stat-number text-warning" id="stat6Months">0</div>
                    <div class="stat-label">Son 6 Ay</div>
                </div>
                <div class="stat-card-scroll">
                    <div class="stat-number text-danger" id="statYearly">0</div>
                    <div class="stat-label">Son 1 YÄ±l</div>
                </div>
            </div>

            <div class="analysis-box">
                <div class="analysis-row">
                    <div class="analysis-icon icon-good"><i class="fas fa-check"></i></div>
                    <div class="analysis-text">
                        <span class="analysis-title">En Ä°yi Performans</span>
                        <span class="analysis-value" id="bestPrayer">HesaplanÄ±yor...</span>
                    </div>
                </div>
                <div class="analysis-row">
                    <div class="analysis-icon icon-bad"><i class="fas fa-exclamation"></i></div>
                    <div class="analysis-text">
                        <span class="analysis-title">En Ã‡ok BorÃ§</span>
                        <span class="analysis-value" id="worstPrayer">HesaplanÄ±yor...</span>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-md-12">
                    <div class="chart-container">
                        <h5 class="text-center mb-3 fw-bold">Namaz BazlÄ± DaÄŸÄ±lÄ±m</h5>
                        <canvas id="barChart" style="max-height: 350px;"></canvas>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="chart-container">
                        <h5 class="text-center mb-3 fw-bold">Son 7 GÃ¼n PerformansÄ±</h5>
                        <canvas id="lineChart" style="max-height: 250px;"></canvas>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="chart-container">
                        <h5 class="text-center mb-3 fw-bold">Genel Durum</h5>
                        <canvas id="completionChart" style="max-height: 250px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- TESBÄ°HAT -->
        <div id="section-tesbihat" style="display: none;">
            <h3 class="app-header">Tesbihat ve Zikir</h3>
            <div class="row g-4" id="tesbihatContainer"></div>
        </div>

        <!-- HESAPLAMA SÄ°HÄ°RBAZI -->
        <div id="section-calculator" style="display: none;">
            <h3 class="app-header">Kaza Hesaplama SihirbazÄ±</h3>
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="calculator-card">
                        <div class="alert alert-info small mb-4">
                            <i class="fas fa-info-circle me-2"></i>
                            Sabah NamazÄ±na girdiÄŸiniz <strong>Sorumluluk BaÅŸlama (BuluÄŸ Ã‡aÄŸÄ±)</strong> ve <strong>Namaza DÃ¼zenli BaÅŸlama Tarihi</strong> deÄŸerlerini <strong>Kopyala</strong> ile diÄŸer namazlara uygulayabilirsiniz.
                        </div>
                        <div class="d-flex justify-content-end gap-2 mb-3 flex-wrap">
                            <button class="btn btn-sm btn-outline-info" onclick="copyStartDate()">
                                <i class="fas fa-copy me-1"></i> Sorumluluk BaÅŸlangÄ±Ã§ Tarihini Kopyala
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="copyEndDate()">
                                <i class="fas fa-copy me-1"></i> DÃ¼zenli BaÅŸlama Tarihini Kopyala
                            </button>
                        </div>
                        <div id="calcRowsContainer"></div>
                        <hr class="my-4">
                        <button class="btn btn-danger w-100 py-3 rounded-pill fw-bold" onclick="applyAdvancedCalculation()">
                            <i class="fas fa-check-circle me-2"></i> HesaplananlarÄ± Onayla ve Aktar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- YEDEKLEME VE AYARLAR -->
        <div id="section-settings" style="display: none;">
            <h3 class="app-header">Yedekleme ve Ayarlar</h3>
            <div class="row justify-content-center g-4">
                <div class="col-md-6 col-lg-4">
                    <div class="settings-card text-center h-100">
                        <i class="fas fa-download settings-icon"></i>
                        <div class="settings-title">Yedek Al</div>
                        <div class="settings-desc">Verileri indir.</div>
                        <button class="btn btn-success w-100" onclick="downloadBackupJSON()">
                            <i class="fas fa-file-export me-2"></i> Yedek Ä°ndir (.json)
                        </button>
                    </div>
                </div>
                <div class="col-md-6 col-lg-4">
                    <div class="settings-card text-center h-100">
                        <i class="fas fa-upload settings-icon text-primary"></i>
                        <div class="settings-title">Yedekten DÃ¶n</div>
                        <div class="settings-desc">Yedek dosyasÄ±nÄ± yÃ¼kle.</div>
                        <button class="btn btn-primary w-100" onclick="document.getElementById('importFile').click()">
                            <i class="fas fa-file-import me-2"></i> Yedek YÃ¼kle
                        </button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importBackupJSON(this)">
                    </div>
                </div>
                <div class="col-md-6 col-lg-4">
                    <div class="settings-card text-center h-100">
                        <i class="fas fa-file-csv settings-icon text-warning"></i>
                        <div class="settings-title">Excel Raporu</div>
                        <div class="settings-desc">Excel (.csv) formatÄ±nda indir.</div>
                        <button class="btn btn-warning w-100 text-white" onclick="downloadDataAsCSV()">
                            <i class="fas fa-table me-2"></i> Rapor Ä°ndir (.csv)
                        </button>
                    </div>
                </div>
                <div class="col-12">
                    <div class="settings-card text-center border-danger">
                        <i class="fas fa-exclamation-triangle settings-icon text-danger"></i>
                        <div class="settings-title text-danger">Verileri SÄ±fÄ±rla</div>
                        <div class="settings-desc">Her ÅŸeyi siler.</div>
                        <button class="btn btn-danger py-2 px-5" onclick="confirmResetData()">
                            <i class="fas fa-trash-alt me-2"></i> Her Åžeyi Sil ve SÄ±fÄ±rla
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="showSection('dashboard'); activateNav(this)"><i class="fas fa-mosque"></i><span>Kaza</span></div>
    <div class="nav-item" onclick="showSection('stats'); activateNav(this)"><i class="fas fa-chart-pie"></i><span>Ä°statistik</span></div>
    <div class="nav-item" onclick="showSection('tesbihat'); activateNav(this)"><i class="fas fa-fingerprint"></i><span>Tesbihat</span></div>
    <div class="nav-item" onclick="showSection('calculator'); activateNav(this)"><i class="fas fa-calculator"></i><span>Hesap</span></div>
    <div class="nav-item" onclick="toggleSidebar()"><i class="fas fa-bars"></i><span>MenÃ¼</span></div>
</div>

<!-- JS KodlarÄ±mÄ±zÄ± BaÄŸladÄ±k -->
<script src="app.js"></script>

</body>
</html>