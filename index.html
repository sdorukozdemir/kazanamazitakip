<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ƒ∞badet Takip & Namaz Vakti</title>
    
    <meta name="theme-color" content="#198754">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" id="my-manifest">

    <!-- CSS K√ºt√ºphaneleri -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Amiri:wght@700&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <!-- Grafikler ve Efektler -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>

    <style>
        /* --- GENEL AYARLAR --- */
        :root { 
            --bg-color: #e3e6ec; --text-color: #212529; --card-bg: #ffffff; --sidebar-bg: #157347; 
            --table-head: #157347; --table-row-bg: #ffffff; --input-bg: #f8f9fa; --input-text: #000000; 
            --border-color: #ced4da; --modal-bg: #ffffff;
            
            --col-namaz-bg: #5a826e; --col-namaz-text: #ffffff;
            --table-foot-bg: #1f3b2f; --table-foot-border: #142921;
            
            --z-btn-minus-bg: #e9ecef; --z-btn-minus-text: #495057;
            --z-btn-reset-bg: #fff3cd; --z-btn-reset-text: #856404;
            --z-btn-plus-bg: linear-gradient(145deg, #198754, #20c997);
            
            --scroll-track: #e9ecef; --scroll-thumb: #ced4da;
            --box-target-bg: #e8f5e9; --box-target-border: #c3e6cb; --box-target-text: #155724;
            --box-add-bg: #e7f1ff; --box-add-border: #b6d4fe;
            --stat-avg-color: #6610f2;
        }
        body.dark-mode { 
            --bg-color: #121212; --text-color: #e0e0e0; --card-bg: #1e1e1e; --sidebar-bg: #0f5132; 
            --table-head: #0f5132; --table-row-bg: #2d2d2d; --input-bg: #3a3a3a; --input-text: #ffffff; 
            --border-color: #444; --modal-bg: #2d2d2d;
            
            --col-namaz-bg: #1e3b2e; --col-namaz-text: #e0e0e0;
            --table-foot-bg: #0b1a15; --table-foot-border: #050d0a;
            
            --z-btn-minus-bg: #343a40; --z-btn-minus-text: #ced4da;
            --z-btn-reset-bg: #3e2c00; --z-btn-reset-text: #ffc107;
            --z-btn-plus-bg: linear-gradient(145deg, #0f5132, #146c43);
            
            --scroll-track: #2d2d2d; --scroll-thumb: #555;
            --box-target-bg: #0f2e1c; --box-target-border: #146c43; --box-target-text: #75b798;
            --box-add-bg: #052c65; --box-add-border: #084298;
            --stat-avg-color: #d63384; 
        }
        
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Poppins', sans-serif; transition: 0.3s; overflow-x: hidden; min-height: 100vh; }
        
        /* --- NAMAZ VAKTƒ∞ WIDGET TASARIMI --- */
        .prayer-widget-card {
            background: linear-gradient(145deg, #252438, #1e1d2b);
            color: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            font-family: 'Poppins', sans-serif;
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }

        .pw-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .pw-location { font-size: 1.1rem; font-weight: 700; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; text-transform: uppercase; }
        .pw-date { font-size: 0.8rem; opacity: 0.7; margin-top: 4px; font-weight: 400; color: #a9a8b6; }
        .btn-change-city { background: rgba(255,255,255,0.1); border: none; color: white; border-radius: 8px; padding: 4px 10px; font-size: 0.7rem; cursor: pointer; transition: 0.2s; }
        .btn-change-city:hover { background: rgba(255,255,255,0.2); }

        .pw-timer-area {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .pw-next-name { font-size: 1.8rem; font-weight: 700; line-height: 1; text-transform: uppercase; margin-bottom: 3px; }
        .pw-label { font-size: 0.85rem; opacity: 0.8; color: #a9a8b6; }
        .pw-countdown { font-size: 2.5rem; font-weight: 400; letter-spacing: 2px; font-variant-numeric: tabular-nums; text-shadow: 0 0 20px rgba(255,255,255,0.1); }

        .pw-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .pw-box {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 12px 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            position: relative;
            border: 1px solid rgba(255,255,255,0.05);
            transition: 0.3s;
        }
        .pw-box-label { font-size: 0.65rem; text-transform: uppercase; opacity: 0.6; font-weight: 600; margin-bottom: 2px; }
        .pw-box-time { font-size: 1.2rem; font-weight: 600; }
        .pw-box-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 1.2rem; opacity: 0.3; }
        
        /* Aktif Kutu (Turuncu) */
        .pw-box.active {
            background: #e67e22;
            color: white;
            border-color: #e67e22;
            box-shadow: 0 5px 15px rgba(230, 126, 34, 0.4);
        }
        .pw-box.active .pw-box-label { opacity: 0.9; }
        .pw-box.active .pw-box-icon { opacity: 0.8; }

        @media (max-width: 400px) {
            .pw-next-name { font-size: 1.4rem; }
            .pw-countdown { font-size: 1.8rem; }
            .pw-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* --- Dƒ∞ƒûER CSS --- */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s ease, visibility 0.5s; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(25, 135, 84, 0.2); border-top-color: #198754; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 15px; font-weight: 600; color: #198754; }

        .wrapper { display: flex; width: 100%; }
        #sidebar { min-width: 260px; max-width: 260px; background: var(--sidebar-bg); color: #fff; height: 100vh; transition: 0.3s; z-index: 2000; position: fixed; top: 0; left: 0; overflow-y: auto; margin-left: -260px; }
        #overlay { display: none; position: fixed; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 1999; top: 0; left: 0; backdrop-filter: blur(2px); }
        #overlay.active { display: block; }
        #sidebar.active { margin-left: 0; }
        @media (min-width: 769px) { #sidebar { position: sticky; margin-left: 0; height: 100vh; z-index: 1050; } #sidebar.active { margin-left: -260px; } #overlay { display: none !important; } #content { width: calc(100% - 260px); margin-left: 0; } }
        @media (max-width: 768px) { #content { width: 100%; } }
        #sidebar ul li { padding: 15px; cursor: pointer; border-left: 5px solid transparent; transition: 0.2s; }
        #sidebar ul li:hover { background: rgba(255,255,255,0.1); }
        #sidebar ul li.active { background: rgba(255,255,255,0.2); border-left-color: #fff; font-weight: 600; }
        #content { padding: 20px; min-height: 100vh; transition: 0.3s; width: 100%; max-width: 900px; margin: 0 auto; }
        .app-header { text-align: center; color: var(--sidebar-bg); font-weight: 600; margin-bottom: 25px; font-size: 1.5rem; }
        body.dark-mode .app-header { color: #20c997; }

        /* TABLO */
        .table-responsive { border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; width: 100%; display: block; overflow-x: auto;}
        .main-table { color: var(--text-color); font-size: 0.85rem; width: 100%; border-collapse: collapse; min-width: 650px; }
        .main-table thead th { background-color: var(--table-head); color: white; text-align: center; padding: 12px 5px; border: 1px solid var(--border-color); }
        .main-table tbody td { background-color: var(--table-row-bg); color: var(--text-color); border: 1px solid var(--border-color); text-align: center; vertical-align: middle !important; padding: 10px 5px; height: 1px; }
        .main-table tfoot td { background-color: var(--table-foot-bg); color: white; font-weight: bold; text-align: center; padding: 10px; border: 1px solid var(--table-foot-border); }
        .table-input, .table-value-box { text-align: center; font-weight: bold; background-color: var(--input-bg); color: var(--input-text); border: 1px solid var(--border-color); width: 100%; height: 38px; border-radius: 8px; outline: none; margin: 0; display: flex; align-items: center; justify-content: center; }
        .col-namaz { background-color: var(--col-namaz-bg) !important; color: var(--col-namaz-text) !important; font-weight: 600; min-width: 80px; }
        .btn-action { width: 38px; height: 38px; border-radius: 8px; border: none; color: white; font-weight: bold; cursor: pointer; transition: transform 0.05s; box-shadow: 0 3px 6px rgba(0,0,0,0.2); font-size: 1.2rem; display: flex; justify-content: center; align-items: center; }
        .btn-action:active { transform: scale(0.85); }
        .btn-plus { background-color: #198754; } .btn-minus { background-color: #6c757d; }
        .action-wrapper { display: flex; justify-content: center; gap: 5px; height: 38px; }
        .progress-container { height: 20px; display: flex; flex-direction: column; justify-content: flex-end; margin-top: 6px; }
        .progress { height: 12px; border-radius: 6px; background-color: #e9ecef; width: 100%; }
        .spacer-box { height: 20px; margin-top: 6px; width: 100%; visibility: hidden; }

        .card-shadow { border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.06); background-color: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); }
        .login-card { @extend .card-shadow; } 
        #login-screen { height: 100vh; display: flex; justify-content: center; align-items: center; background-color: var(--bg-color); }
        .goal-card { background: linear-gradient(135deg, #198754, #20c997); color: white; padding: 20px; margin-bottom: 20px; text-align: center; border-radius: 16px; }
        .goal-input { width: 70px; text-align: center; font-weight: bold; border: none; border-radius: 5px; color: #198754; background: white; }
        
        .custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .custom-modal { background: var(--modal-bg); padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; animation: popIn 0.3s ease; }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-btn { padding: 10px 25px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; }
        .modal-btn-group { display: flex; justify-content: center; gap: 25px; margin-top: 15px; }
        .btn-confirm { background: #dc3545; color: white; } .btn-cancel { background: #6c757d; color: white; } .btn-ok { background: #198754; color: white; width: 100%; }

        .bottom-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: var(--card-bg); border-top: 1px solid var(--border-color); z-index: 1060; justify-content: space-around; align-items: center; padding-bottom: 10px; }
        .nav-item { text-align: center; color: var(--text-color); opacity: 0.6; font-size: 0.75rem; flex: 1; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .nav-item.active { color: #198754; opacity: 1; font-weight: 600; }
        .nav-item i { font-size: 1.4rem; margin-bottom: 4px; }
        @media (max-width: 768px) { .bottom-nav { display: flex; } #content { padding-bottom: 90px; } }
        
        /* Tesbihat vb. stilleri (√∂zet) */
        .zikr-card { padding: 25px; text-align: center; border-top: 6px solid #198754; background: var(--card-bg); border-radius: 16px; margin-bottom: 10px; }
        .arabic-text { font-family: 'Amiri', serif; font-size: 2.4rem; color: #198754; margin: 10px 0; }
        .zikr-count { font-size: 2.8rem; font-weight: bold; color: var(--text-color); }
        .zikr-btn { border: none; cursor: pointer; } .z-plus { width: 90px; height: 90px; border-radius: 25px; background: var(--z-btn-plus-bg); color: white; font-size: 2.5rem; }
    </style>
</head>
<body>

<!-- LOADING -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">Y√ºkleniyor...</div>
</div>

<!-- ≈ûEHƒ∞R SE√áƒ∞M MODALI -->
<div id="cityModal" class="custom-modal-overlay">
    <div class="custom-modal">
        <h4 style="color:var(--text-color)">≈ûehir Se√ßimi</h4>
        <p style="color:var(--text-color)">Namaz vakitleri i√ßin ≈üehrinizi giriniz.</p>
        <input type="text" id="cityInput" class="form-control text-center mb-3" placeholder="√ñrn: Istanbul" style="text-transform: capitalize;">
        <div class="modal-btn-group">
            <button class="modal-btn btn-cancel" onclick="document.getElementById('cityModal').style.display='none'">ƒ∞ptal</button>
            <button class="modal-btn btn-ok" onclick="saveCity()">Kaydet</button>
        </div>
    </div>
</div>

<div id="customModal" class="custom-modal-overlay">
    <div class="custom-modal">
        <h4 id="modalTitle" style="color:var(--text-color)">Ba≈ülƒ±k</h4>
        <p id="modalMessage" style="color:var(--text-color)">Mesaj.</p>
        <div class="modal-btn-group" id="modalButtons"></div>
    </div>
</div>
<div id="overlay" onclick="toggleSidebar()"></div>

<!-- LOGIN -->
<div id="login-screen">
    <div class="login-card p-5 text-center" style="max-width: 400px; border-radius:16px; background:var(--card-bg); box-shadow:0 10px 30px rgba(0,0,0,0.1);">
        <h3 class="text-success fw-bold mb-4">ƒ∞badet Takip</h3>
        <button class="btn btn-dark w-100 py-3 rounded-pill" onclick="loginWithGoogle()">
            <i class="fab fa-google me-2"></i> Google ile Giri≈ü
        </button>
    </div>
</div>

<div id="app-wrapper" class="wrapper" style="display:none;">
    <nav id="sidebar">
        <div class="p-4 text-center" style="background: rgba(0,0,0,0.1);">
            <h4 class="fw-bold"><i class="fas fa-kaaba me-2"></i>Takip</h4>
            <small id="sidebarUserInfo" class="text-white-50">...</small>
        </div>
        <ul class="list-unstyled components p-2">
            <li id="menu-dashboard" class="active" onclick="showSection('dashboard')"><i class="fas fa-mosque me-3"></i> Kaza Namazƒ±</li>
            <li id="menu-stats" onclick="showSection('stats')"><i class="fas fa-chart-pie me-3"></i> ƒ∞statistikler</li>
            <li id="menu-tesbihat" onclick="showSection('tesbihat')"><i class="fas fa-fingerprint me-3"></i> Tesbihat</li>
            <li id="menu-calculator" onclick="showSection('calculator')"><i class="fas fa-calculator me-3"></i> Hesap Sihirbazƒ±</li>
            <li id="menu-settings" onclick="showSection('settings')"><i class="fas fa-cog me-3"></i> Ayarlar</li>
            <li onclick="toggleDarkMode()"><i class="fas fa-moon me-3"></i> <span id="darkModeText">Gece Modu</span></li>
            <li onclick="logout()"><i class="fas fa-sign-out-alt me-3"></i> √áƒ±kƒ±≈ü Yap</li>
        </ul>
    </nav>

    <div id="content">
        <!-- DASHBOARD -->
        <div id="section-dashboard" style="display: block;">
            
            <!-- NAMAZ VAKTƒ∞ WIDGET -->
            <div class="row justify-content-center mb-4">
                <div class="col-md-8 col-lg-6">
                    <div class="prayer-widget-card">
                        <div class="pw-header">
                            <div>
                                <div class="pw-location">
                                    <i class="fas fa-map-marker-alt"></i> 
                                    <span id="pwCityName">≈ûEHƒ∞R SE√áƒ∞LMEDƒ∞</span>
                                    <span style="opacity:0.5">‚Ä¢</span>
                                    <span id="pwCountryName">TR</span>
                                </div>
                                <div class="pw-date" id="pwFullDate">Y√ºkleniyor...</div>
                            </div>
                            <button class="btn-change-city" onclick="openCityModal()">
                                <i class="fas fa-pen"></i>
                            </button>
                        </div>

                        <div class="pw-timer-area">
                            <div>
                                <div class="pw-next-name" id="pwActiveName">...</div>
                                <div class="pw-label">Vaktine Kalan S√ºre</div>
                            </div>
                            <div class="pw-countdown" id="pwCountdown">--:--:--</div>
                        </div>

                        <div class="pw-grid" id="pwGrid">
                            <!-- JS ile doldurulacak -->
                            <div class="pw-box"><span class="pw-box-label">ƒ∞MSAK</span><span class="pw-box-time">--:--</span><i class="fas fa-cloud-sun pw-box-icon"></i></div>
                            <div class="pw-box"><span class="pw-box-label">G√úNE≈û</span><span class="pw-box-time">--:--</span><i class="fas fa-sun pw-box-icon"></i></div>
                            <div class="pw-box active"><span class="pw-box-label">√ñƒûLE</span><span class="pw-box-time">--:--</span><i class="fas fa-clock pw-box-icon"></i></div>
                            <div class="pw-box"><span class="pw-box-label">ƒ∞Kƒ∞NDƒ∞</span><span class="pw-box-time">--:--</span><i class="fas fa-cloud-sun-rain pw-box-icon"></i></div>
                            <div class="pw-box"><span class="pw-box-label">AK≈ûAM</span><span class="pw-box-time">--:--</span><i class="fas fa-moon pw-box-icon"></i></div>
                            <div class="pw-box"><span class="pw-box-label">YATSI</span><span class="pw-box-time">--:--</span><i class="fas fa-stars pw-box-icon"></i></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- HEDEF KARTI -->
            <div class="row justify-content-center mb-4">
                <div class="col-md-8 col-lg-6">
                    <div id="goalCard" class="goal-card">
                        <h4>üéØ G√ºnl√ºk Hedef</h4>
                        <div class="d-flex justify-content-center align-items-center gap-2 flex-wrap mt-3 mb-2">
                            <span class="fs-5">Bug√ºn</span>
                            <strong class="fs-1" id="dailyCountDisplay">0</strong>
                            <span class="fs-5">/</span>
                            <input type="number" id="dailyGoalInput" class="goal-input" value="10" onchange="updateDailyGoal(this.value)">
                            <span class="fs-5">Kaza</span>
                        </div>
                        <div class="progress mt-2" style="height: 8px; background: rgba(255,255,255,0.3); border-radius: 10px;">
                            <div id="dailyProgressBar" class="progress-bar bg-warning" style="width: 0%"></div>
                        </div>
                        <div id="goalSuccessMessage" class="mt-2 fw-bold text-white" style="display: none;">üéâ Harika! Hedefe Ula≈üƒ±ldƒ±!</div>
                    </div>
                </div>
            </div>

            <!-- KAZA TABLOSU -->
            <div class="table-responsive mb-4">
                <table class="table main-table">
                    <thead>
                        <tr>
                            <th>Namaz</th>
                            <th class="col-input-area">Kƒ±lƒ±nacak<br>Namaz</th>
                            <th class="col-input-area">Kƒ±lƒ±nan<br>Namaz</th>
                            <th class="col-action">ƒ∞≈ülem</th>
                            <th>G√ºnl√ºk<br>Ort.</th>
                            <th>Tahmini<br>Biti≈ü</th>
                        </tr>
                    </thead>
                    <tbody id="prayerTableBody"></tbody>
                    <tfoot id="prayerTableFoot"></tfoot>
                </table>
            </div>

            <div class="text-center mt-4"><h5 class="fw-bold text-secondary"><i class="fas fa-trophy text-warning me-2"></i>Rozetler</h5></div>
            <div id="badgeContainer" class="d-flex justify-content-center gap-3 flex-wrap mb-4"></div>
        </div>

        <!-- ƒ∞STATƒ∞STƒ∞KLER -->
        <div id="section-stats" style="display: none;">
            <h3 class="app-header">ƒ∞statistikler</h3>
            <div class="row g-4">
                <div class="col-md-12">
                    <div class="card-shadow p-3">
                        <canvas id="barChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card-shadow p-3">
                        <h6 class="text-center">Doluluk Oranƒ±</h6>
                        <canvas id="completionChart" style="max-height: 250px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- TESBƒ∞HAT -->
        <div id="section-tesbihat" style="display: none;">
            <h3 class="app-header">Tesbihat</h3>
            <div class="row g-4" id="tesbihatContainer"></div>
        </div>

        <!-- HESAP Sƒ∞Hƒ∞RBAZI (Basit G√∂r√ºn√ºm) -->
        <div id="section-calculator" style="display: none;">
            <h3 class="app-header">Kaza Hesaplama</h3>
            <div class="card-shadow p-4">
                <p>Doƒüum tarihi ve buluƒü √ßaƒüƒ±na g√∂re otomatik hesaplama yapƒ±labilir.</p>
                <div id="calcRowsContainer"></div>
                <button class="btn btn-primary w-100 mt-3" onclick="applyAdvancedCalculation()">Hesapla ve Kaydet</button>
            </div>
        </div>

        <!-- AYARLAR -->
        <div id="section-settings" style="display: none;">
            <h3 class="app-header">Ayarlar</h3>
            <div class="row g-4">
                <div class="col-md-6"><button class="btn btn-outline-success w-100 p-4" onclick="downloadBackupJSON()">Yedek ƒ∞ndir</button></div>
                <div class="col-md-6">
                    <button class="btn btn-outline-primary w-100 p-4" onclick="document.getElementById('importFile').click()">Yedek Y√ºkle</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importBackupJSON(this)">
                </div>
                <div class="col-12"><button class="btn btn-danger w-100 p-3" onclick="confirmResetData()">Verileri Sƒ±fƒ±rla</button></div>
            </div>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="showSection('dashboard'); activateNav(this)"><i class="fas fa-mosque"></i><span>Kaza</span></div>
    <div class="nav-item" onclick="showSection('stats'); activateNav(this)"><i class="fas fa-chart-pie"></i><span>ƒ∞statistik</span></div>
    <div class="nav-item" onclick="showSection('tesbihat'); activateNav(this)"><i class="fas fa-fingerprint"></i><span>Tesbihat</span></div>
    <div class="nav-item" onclick="toggleSidebar()"><i class="fas fa-bars"></i><span>Men√º</span></div>
</div>

<script>
    // --- KONFETƒ∞ BA≈ûLATMA ---
    const jsConfetti = new JSConfetti();

    // --- YARDIMCI FONKSƒ∞YONLAR ---
    function triggerHaptic() { if (navigator.vibrate) navigator.vibrate(10); }
    function hideLoader() { const l=document.getElementById('loading-overlay'); if(l){l.style.opacity='0'; setTimeout(()=>{l.style.visibility='hidden';},500);} }
    setTimeout(hideLoader, 5000); // Fallback

    // --- MANIFEST ---
    const pwaIcon = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23198754' d='M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256 256-114.6 256-256S401.4 0 256 0zm-46.8 389L68.6 248.4c-4.7-4.7-4.7-12.3 0-17l28.3-28.3c4.7-4.7 12.3-4.7 17 0L209.2 298l188.8-188.8c4.7-4.7 12.3-4.7 17 0l28.3 28.3c4.7 4.7 4.7 12.3 0 17L226.2 389c-4.7 4.7-12.3 4.7-17 0z'/%3E%3C/svg%3E";
    const manifestBlob = new Blob([JSON.stringify({ "name": "ƒ∞badet Takip", "short_name": "ƒ∞badet", "start_url": ".", "display": "standalone", "background_color": "#f8f9fa", "theme_color": "#198754", "icons": [{ "src": pwaIcon, "sizes": "192x192", "type": "image/svg+xml" }] })], {type: 'application/json'});
    document.querySelector('#my-manifest').href = URL.createObjectURL(manifestBlob);

    // --- FIREBASE AYARLARI ---
    const firebaseConfig = {
        apiKey: "AIzaSyC7zdr3x8H--8piHR_1muAz2TVOOaebI54",
        authDomain: "kazanamazi-ser.firebaseapp.com",
        databaseURL: "https://kazanamazi-ser-default-rtdb.firebaseio.com",
        projectId: "kazanamazi-ser",
        storageBucket: "kazanamazi-ser.firebasestorage.app",
        messagingSenderId: "951730390034",
        appId: "1:951730390034:web:639f96ee859c10b0e944cb",
        measurementId: "G-5WGCDTL1RX"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();
    let dbRef = null;

    // --- VERƒ∞ MODELƒ∞ ---
    const defaultData = {
        city: "Ankara",
        startDate: new Date().toISOString().split('T')[0],
        daily: { date: new Date().toLocaleDateString('tr-TR'), counts: [0,0,0,0,0], target: 10 },
        counts: [{name:"Sabah",target:0,done:0},{name:"√ñƒüle",target:0,done:0},{name:"ƒ∞kindi",target:0,done:0},{name:"Ak≈üam",target:0,done:0},{name:"Yatsƒ±",target:0,done:0}],
        tesbihat: [
            { name: "S√ºbhanallah", arabic: "ÿ≥Ÿèÿ®Ÿíÿ≠ŸéÿßŸÜŸé Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸê", current: 0, target: 33 },
            { name: "Elhamd√ºlillah", arabic: "Ÿ±ŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸéŸëŸ∞ŸáŸê", current: 0, target: 33 },
            { name: "Allahu Ekber", arabic: "Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸè ÿ£ŸéŸÉŸíÿ®Ÿéÿ±Ÿè", current: 0, target: 33 }
        ],
        earnedBadges: [], history: []
    };
    let localData = JSON.parse(JSON.stringify(defaultData));
    let chartCompletion = null, barChart = null;

    // --- AUTH ---
    auth.onAuthStateChanged((user) => {
        if (user) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-wrapper').style.display = 'flex';
            document.getElementById('sidebarUserInfo').innerText = user.displayName;
            dbRef = db.ref('users/' + user.uid + '/namazData');
            dbRef.on('value', (s) => {
                const d = s.val();
                if (d) localData = d;
                if (!localData.city) localData.city = "Ankara"; // Varsayƒ±lan
                if (!d) saveToCloud();
                renderApp();
                hideLoader();
            });
        } else { 
            hideLoader();
            document.getElementById('login-screen').style.display = 'flex'; 
            document.getElementById('app-wrapper').style.display = 'none'; 
        }
    });

    function loginWithGoogle() { auth.signInWithPopup(provider).catch(e => showModal("Hata", e.message)); }
    function logout() { auth.signOut(); }
    function saveToCloud() { if(dbRef) dbRef.set(localData); }

    // --- UI NAVIGATION ---
    window.showSection = function(id) {
        document.querySelectorAll('#sidebar ul li').forEach(li => li.classList.remove('active'));
        const m = document.getElementById('menu-' + id); if(m) m.classList.add('active');
        ['dashboard','stats','tesbihat','calculator','settings'].forEach(s => document.getElementById('section-'+s).style.display='none');
        document.getElementById('section-'+id).style.display='block';
        if(window.innerWidth < 768) { document.getElementById('sidebar').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); }
        if(id==='stats') renderStats();
        if(id==='tesbihat') renderTesbihat();
        if(id==='calculator') renderCalculatorRows();
    };
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').classList.toggle('active'); }
    function activateNav(el) { document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); if(el) el.classList.add('active'); }

    // --- RENDER APP ---
    function renderApp() {
        if(!localData.counts) return;
        
        // Namaz Vakti Widget'ƒ± Ba≈ülat
        initPrayerWidget();

        // G√ºnl√ºk Hedef
        const c = localData.daily.counts ? localData.daily.counts.reduce((a,b)=>a+b,0) : 0;
        document.getElementById('dailyCountDisplay').innerText = c;
        document.getElementById('dailyGoalInput').value = localData.daily.target || 10;
        let p = (c / (localData.daily.target||10)) * 100; if(p>100) p=100;
        document.getElementById('dailyProgressBar').style.width = p + "%";
        document.getElementById('goalSuccessMessage').style.display = c >= localData.daily.target ? 'block' : 'none';

        // Tablo
        const tbody = document.getElementById('prayerTableBody');
        tbody.innerHTML = "";
        let tt=0, td=0;
        const days = Math.ceil(Math.abs(new Date() - new Date(localData.startDate)) / (1000 * 60 * 60 * 24)) || 1;
        
        localData.counts.forEach((item, i) => {
            tt += parseInt(item.target); td += parseInt(item.done);
            const rem = item.target - item.done;
            const avg = (item.done / days).toFixed(2);
            const est = avg > 0 ? Math.ceil(rem/avg) + " G√ºn" : "Belirsiz";
            let pp = item.target > 0 ? (item.done / item.target) * 100 : 0;
            
            tbody.innerHTML += `<tr>
                <td class="col-namaz">${item.name}</td>
                <td class="col-input-area"><input type="number" class="table-input" value="${item.target}" onchange="window.upT(${i},this.value)"></td>
                <td class="col-input-area">
                    <input type="number" class="table-input" value="${item.done}" onchange="window.upD(${i},this.value)">
                    <div class="progress-container"><div class="progress"><div class="progress-bar bg-success" style="width: ${pp}%"></div></div></div>
                </td>
                <td class="col-action">
                    <div class="action-wrapper">
                        <button class="btn-action btn-plus" onclick="window.chC(${i},1)">+</button>
                        <button class="btn-action btn-minus" onclick="window.chC(${i},-1)">-</button>
                    </div>
                </td>
                <td><div class="table-value-box">${avg}</div></td>
                <td><div class="table-value-box">${est}</div></td>
            </tr>`;
        });
        document.getElementById('prayerTableFoot').innerHTML = `<tr><td>Toplam</td><td>${tt}</td><td>${td}</td><td colspan="3"></td></tr>`;
        
        // Rozetler
        const bc = document.getElementById('badgeContainer'); bc.innerHTML = "";
        if(td >= 100) bc.innerHTML += `<span class="badge bg-success p-2">üéâ 100 Namaz</span>`;
        if(td >= 1000) bc.innerHTML += `<span class="badge bg-warning text-dark p-2">üèîÔ∏è 1000 Namaz</span>`;
    }

    // --- NAMAZ VAKTƒ∞ WIDGET MANTIƒûI ---
    let prayerTimesData = null;
    let prayerTimerInterval = null;

    function openCityModal() {
        document.getElementById('cityInput').value = localData.city || "";
        document.getElementById('cityModal').style.display = 'flex';
    }

    function saveCity() {
        const c = document.getElementById('cityInput').value.trim();
        if(c) {
            const formattedCity = c.charAt(0).toUpperCase() + c.slice(1).toLowerCase();
            localData.city = formattedCity;
            saveToCloud();
            document.getElementById('cityModal').style.display = 'none';
            initPrayerWidget(); 
        }
    }

    function initPrayerWidget() {
        if(!localData.city) localData.city = "Ankara";
        document.getElementById('pwCityName').innerText = localData.city.toUpperCase();
        
        const date = new Date();
        const strDate = date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
        // Hicri Tarih (Native)
        const hijriDate = new Intl.DateTimeFormat('tr-TR-u-ca-islamic-uma', {day: 'numeric', month: 'long', year: 'numeric'}).format(date).replace('Hicri', '').trim();
        document.getElementById('pwFullDate').innerText = `${strDate} ‚Ä¢ ${hijriDate}`;

        fetchPrayerTimes(localData.city);
    }

    function fetchPrayerTimes(city) {
        // vakit.vercel.app kullanarak veri √ßekimi
        // T√ºrk√ße karakter temizleme
        const cleanCity = city.replace(/ƒ±/g, 'i').replace(/ƒ∞/g, 'I').replace(/≈ü/g, 's').replace(/≈û/g, 'S').replace(/ƒü/g, 'g').replace(/ƒû/g, 'G').replace(/√º/g, 'u').replace(/√ú/g, 'U').replace(/√∂/g, 'o').replace(/√ñ/g, 'O').replace(/√ß/g, 'c').replace(/√á/g, 'C');
        
        // API Tarih Formatƒ± YYYY-MM-DD
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        const dateStr = `${yyyy}-${mm}-${dd}`;

        // Diyanet Verisi √áeken Endpoint
        fetch(`https://vakit.vercel.app/api/timesFromPlace?country=Turkey&region=${cleanCity}&city=${cleanCity}&date=${dateStr}&days=1&timezoneOffset=180`)
            .then(res => res.json())
            .then(data => {
                // API yapƒ±sƒ±: { times: { "2025-11-27": ["06:11", "07:40", ...] } }
                if(data && data.times && data.times[dateStr]) {
                    const timesArr = data.times[dateStr];
                    // Sƒ±ra: ƒ∞msak, G√ºne≈ü, √ñƒüle, ƒ∞kindi, Ak≈üam, Yatsƒ±
                    const timesObj = {
                        Imsak: timesArr[0], Gunes: timesArr[1], Ogle: timesArr[2],
                        Ikindi: timesArr[3], Aksam: timesArr[4], Yatsi: timesArr[5]
                    };
                    prayerTimesData = timesObj;
                    renderPrayerGrid(timesObj);
                    startPrayerTimer();
                } else {
                    console.log("Veri √ßekilemedi, yedek API deneniyor...");
                    // Yedek API (Alternatif)
                    fetch(`https://namaz-vakti.vercel.app/api/timesFromPlace?country=Turkey&region=${cleanCity}&city=${cleanCity}`)
                    .then(res2 => res2.json())
                    .then(data2 => {
                        if(data2 && data2.times) {
                            prayerTimesData = data2.times;
                            renderPrayerGrid(data2.times);
                            startPrayerTimer();
                        }
                    });
                }
            })
            .catch(err => console.error("API hatasƒ±:", err));
    }

    function renderPrayerGrid(times) {
        const map = [
            { key: 'Imsak', label: 'ƒ∞MSAK', icon: 'fa-cloud-sun' },
            { key: 'Gunes', label: 'G√úNE≈û', icon: 'fa-sun' },
            { key: 'Ogle', label: '√ñƒûLE', icon: 'fa-clock' },
            { key: 'Ikindi', label: 'ƒ∞Kƒ∞NDƒ∞', icon: 'fa-cloud-sun-rain' },
            { key: 'Aksam', label: 'AK≈ûAM', icon: 'fa-moon' },
            { key: 'Yatsi', label: 'YATSI', icon: 'fa-stars' }
        ];
        const grid = document.getElementById('pwGrid');
        grid.innerHTML = '';
        map.forEach(item => {
            const t = times[item.key];
            grid.innerHTML += `<div class="pw-box" id="pbox-${item.key}"><span class="pw-box-label">${item.label}</span><span class="pw-box-time">${t}</span><i class="fas ${item.icon} pw-box-icon"></i></div>`;
        });
    }

    function startPrayerTimer() {
        if(prayerTimerInterval) clearInterval(prayerTimerInterval);
        const update = () => {
            if(!prayerTimesData) return;
            const now = new Date();
            const timeStr = (t) => { const [h,m] = t.split(':').map(Number); const d = new Date(); d.setHours(h,m,0,0); return d; };
            const schedule = {
                'Imsak': timeStr(prayerTimesData.Imsak), 'Gunes': timeStr(prayerTimesData.Gunes),
                'Ogle': timeStr(prayerTimesData.Ogle), 'Ikindi': timeStr(prayerTimesData.Ikindi),
                'Aksam': timeStr(prayerTimesData.Aksam), 'Yatsi': timeStr(prayerTimesData.Yatsi)
            };

            let nextKey = 'Imsak', nextTime = schedule.Imsak, activeBoxKey = 'Yatsi';
            const keys = ['Imsak', 'Gunes', 'Ogle', 'Ikindi', 'Aksam', 'Yatsi'];

            // Gece Yarƒ±sƒ± Kontrol√º
            if (now > schedule.Yatsi) {
                nextKey = 'Imsak';
                nextTime = new Date(schedule.Imsak);
                nextTime.setDate(nextTime.getDate() + 1);
                activeBoxKey = 'Yatsi';
            } else {
                for(let i=0; i<keys.length; i++) {
                    if(now < schedule[keys[i]]) {
                        nextKey = keys[i];
                        nextTime = schedule[keys[i]];
                        // Aktif kutu bir √∂nceki vakittir (≈ûu an i√ßinde bulunulan)
                        if (i === 0) activeBoxKey = 'Yatsi'; // ƒ∞msak √∂ncesi gece
                        else activeBoxKey = keys[i-1];
                        break;
                    }
                }
            }
            
            // Eƒüer ƒ∞msak ile G√ºne≈ü arasƒ±ndaysak
            if (now >= schedule.Imsak && now < schedule.Gunes) activeBoxKey = 'Imsak';
            
            const labelMap = { 'Imsak': 'ƒ∞MSAK', 'Gunes': 'G√úNE≈û', 'Ogle': '√ñƒûLE', 'Ikindi': 'ƒ∞Kƒ∞NDƒ∞', 'Aksam': 'AK≈ûAM', 'Yatsi': 'YATSI' };
            document.getElementById('pwActiveName').innerText = labelMap[nextKey];

            document.querySelectorAll('.pw-box').forEach(b => b.classList.remove('active'));
            const activeEl = document.getElementById(`pbox-${activeBoxKey}`);
            if(activeEl) activeEl.classList.add('active');

            let diff = nextTime - now;
            if(diff < 0) diff = 0;
            const h = Math.floor(diff / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);
            document.getElementById('pwCountdown').innerText = `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        };
        update();
        prayerTimerInterval = setInterval(update, 1000);
    }

    // --- ƒ∞≈ûLEMLER ---
    window.upT = function(i,v){localData.counts[i].target=parseInt(v)||0; saveToCloud(); renderApp();}
    window.upD = function(i,v){localData.counts[i].done=parseInt(v)||0; saveToCloud(); renderApp();}
    window.chC = function(i,d){
        triggerHaptic();
        const n = localData.counts[i].done + d;
        if(n>=0) {
            localData.counts[i].done = n;
            if(d>0) { localData.daily.counts[i]++; if(localData.daily.counts.reduce((a,b)=>a+b,0) === localData.daily.target) jsConfetti.addConfetti(); }
            else if(localData.daily.counts[i]>0) localData.daily.counts[i]--;
            saveToCloud(); renderApp();
        }
    }
    window.updateDailyGoal = function(v){localData.daily.target=parseInt(v); saveToCloud(); renderApp();}
    
    // --- TESBƒ∞HAT RENDER ---
    function renderTesbihat() {
        const c = document.getElementById('tesbihatContainer'); c.innerHTML="";
        localData.tesbihat.forEach((t,i) => {
            c.innerHTML += `<div class="col-md-6"><div class="zikr-card"><h5>${t.name}</h5><div class="arabic-text">${t.arabic}</div><div class="zikr-count">${t.current}</div><div class="d-flex justify-content-center gap-3 mt-3"><button class="zikr-btn z-plus" onclick="incTes(${i})">+</button></div></div></div>`;
        });
    }
    window.incTes = function(i){ localData.tesbihat[i].current++; saveToCloud(); renderTesbihat(); triggerHaptic(); }
    
    // --- GRAFƒ∞KLER ---
    function renderStats() {
        const ctx = document.getElementById('barChart').getContext('2d');
        if(barChart) barChart.destroy();
        barChart = new Chart(ctx, { type: 'bar', data: { labels: localData.counts.map(c=>c.name), datasets: [{ label:'Kƒ±lƒ±nan', data: localData.counts.map(c=>c.done), backgroundColor: '#198754' }] } });
    }
    
    // --- AYARLAR ---
    window.downloadBackupJSON = function(){ const b=new Blob([JSON.stringify(localData)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='yedek.json'; a.click(); }
    window.importBackupJSON = function(e){ const f=e.files[0]; if(!f)return; const r=new FileReader(); r.onload=(ev)=>{ try{ localData=JSON.parse(ev.target.result); saveToCloud(); renderApp(); showModal("Ba≈üarƒ±lƒ±","Yedek y√ºklendi"); }catch(err){ showModal("Hata","Dosya bozuk"); } }; r.readAsText(f); }
    window.toggleDarkMode = function(){ document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark':'light'); }
    if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark-mode');
    window.confirmResetData = function(){ if(confirm("Her ≈üey silinecek?")) { localData=defaultData; saveToCloud(); location.reload(); } }
    
    function showModal(t,m){document.getElementById('modalTitle').innerText=t;document.getElementById('modalMessage').innerText=m;document.getElementById('modalButtons').innerHTML='<button class="modal-btn btn-ok" onclick="document.getElementById(\'customModal\').style.display=\'none\'">Tamam</button>';document.getElementById('customModal').style.display='flex';}

    // --- HESAP Sƒ∞Hƒ∞RBAZI ---
    window.renderCalculatorRows = function() {
        const c = document.getElementById('calcRowsContainer'); 
        if(c.innerHTML.trim()) return;
        ["Sabah","√ñƒüle","ƒ∞kindi","Ak≈üam","Yatsƒ±"].forEach((p,i)=>{
            c.innerHTML += `<div class="mb-2"><label>${p}</label><input type="text" class="form-control" placeholder="Ba≈ülangƒ±√ß Tarihi" onfocus="(this.type='date')" id="calc-start-${i}"></div>`;
        });
    }
    window.applyAdvancedCalculation = function() {
        // Basit Demo
        alert("Hesaplama √∂zelliƒüi bu demo s√ºr√ºmde basitle≈ütirilmi≈ütir.");
    }

</script>
</body>
</html>
